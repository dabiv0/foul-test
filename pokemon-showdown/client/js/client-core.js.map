{"version":3,"file":"client-core.js","names":["PSURL","document","location","protocol","Config","routes","client","PSSubscription","observable","listener","_proto","prototype","unsubscribe","index","subscriptions","indexOf","splice","PSModel","_proto2","subscribe","subscription","push","subscribeAndRun","value","update","_i2","_this$subscriptions2","length","PSStreamModel","backlog","_proto3","_i4","_this$backlog2","arguments","undefined","_i6","_this$subscriptions4","PSBackground","_PSStreamModel2","_class","_this","call","id","curId","attrib","changeCount","menuColors","_localStorage$getItem","bg","localStorage","getItem","split","load","slice","_unused","_inheritsLoose","_proto4","save","bgUrl","setItem","join","set","bgid","host","bgs","Math","floor","random","url","title","artist","startsWith","r","parseInt","g","b","hs","getHueSat","extractMenuColors","_this2","img","Image","onload","window","ColorThief","extractMenuColorsFromImg","PS","libsLoaded","then","src","colorThief","colors","getPalette","i","color","unshift","_unused2","max","min","l","d","s","h","body","style","background","backgroundSize","buttonStyleElem","getElementById","textContent","cssBuf","n","_i8","_PSBackground$menuCol2","createElement","head","appendChild"],"sources":["../src/client-core.ts"],"sourcesContent":["/**\r\n * Client core\r\n *\r\n * No dependencies.\r\n * Does three unrelated things:\r\n * 1. sets up polyfills where necessary\r\n * 2. sets up PS's model base classes\r\n * 3. sets up the model and view for PS's backgrounds\r\n *\r\n * The background is mostly here so the new background can be loaded ASAP.\r\n *\r\n * @author Guangcong Luo <guancongluo@gmail.com>\r\n * @license AGPLv3\r\n */\r\n\r\nimport { Config, PS } from \"./client-main\";\r\ndeclare const ColorThief: any;\r\n\r\n/**********************************************************************\r\n * PS Models\r\n *********************************************************************/\r\n// PS's model classes are defined here\r\n\r\nconst PSURL = `${document.location.protocol !== 'http:' ? 'https:' : ''}//${Config.routes.client}/`;\r\n\r\nexport class PSSubscription<T = any> {\r\n\tobservable: PSModel<T> | PSStreamModel<T>;\r\n\tlistener: (value: T) => void;\r\n\tconstructor(observable: PSModel<T> | PSStreamModel<T>, listener: (value: T) => void) {\r\n\t\tthis.observable = observable;\r\n\t\tthis.listener = listener;\r\n\t}\r\n\tunsubscribe() {\r\n\t\tconst index = this.observable.subscriptions.indexOf(this as any);\r\n\t\tif (index >= 0) this.observable.subscriptions.splice(index, 1);\r\n\t}\r\n}\r\n\r\n/**\r\n * PS Models roughly implement the Observable spec. By default,\r\n * PSModel notifies listeners when the model is updated. With a\r\n * value, PSModel can also stream data out.\r\n *\r\n * Note that unlike React's usual paradigm, PS Models are not\r\n * immutable.\r\n */\r\nexport class PSModel<T = null> {\r\n\tsubscriptions: PSSubscription<T>[] = [];\r\n\tsubscribe(listener: (value: T) => void) {\r\n\t\tconst subscription = new PSSubscription<T>(this, listener);\r\n\t\tthis.subscriptions.push(subscription);\r\n\t\treturn subscription;\r\n\t}\r\n\tsubscribeAndRun(listener: (value: T) => void, value?: T) {\r\n\t\tconst subscription = this.subscribe(listener);\r\n\t\tsubscription.listener(value!);\r\n\t\treturn subscription;\r\n\t}\r\n\tupdate(this: PSModel): void;\r\n\tupdate(value: T): void;\r\n\tupdate(value?: T) {\r\n\t\tfor (const subscription of this.subscriptions) {\r\n\t\t\tsubscription.listener(value!);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * @see PSModel\r\n *\r\n * The main difference is that StreamModel keeps a backlog,\r\n * so events generated before something subscribes are not\r\n * lost. Nullish values are not kept in the backlog.\r\n */\r\nexport class PSStreamModel<T = string> {\r\n\tsubscriptions: PSSubscription<T>[] = [];\r\n\tbacklog: NonNullable<T>[] | null = [];\r\n\tsubscribe(listener: (value: T) => void) {\r\n\t\tconst subscription: PSSubscription<T> = new PSSubscription<T>(this, listener);\r\n\t\tthis.subscriptions.push(subscription);\r\n\t\tif (this.backlog) {\r\n\t\t\tfor (const update of this.backlog) {\r\n\t\t\t\tsubscription.listener(update);\r\n\t\t\t}\r\n\t\t\tthis.backlog = null;\r\n\t\t}\r\n\t\treturn subscription;\r\n\t}\r\n\tsubscribeAndRun(listener: (value: T) => void, value: T = null!) {\r\n\t\tconst subscription = this.subscribe(listener);\r\n\t\tsubscription.listener(value);\r\n\t\treturn subscription;\r\n\t}\r\n\tupdate(value: T) {\r\n\t\tif (!this.subscriptions.length && value !== null && value !== undefined) {\r\n\t\t\t// save updates for later\r\n\t\t\t(this.backlog ||= []).push(value);\r\n\t\t}\r\n\t\tfor (const subscription of this.subscriptions) {\r\n\t\t\tsubscription.listener(value);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// type JSONObject = {[k: string]: JSONValue};\r\n// type JSONArray = JSONValue[];\r\n// type JSONValue = number | string | boolean | null | JSONObject | JSONArray;\r\n\r\n/**********************************************************************\r\n * Background Model\r\n *********************************************************************/\r\n\r\n/**\r\n * PS background model. Separate from PSPrefs because unlike prefs,\r\n * backgrounds can be set separately per server, instead of being\r\n * shared among all servers.\r\n *\r\n * Streams the current URL\r\n */\r\nexport const PSBackground = new class extends PSStreamModel<string | null> {\r\n\tid = '';\r\n\tcurId = '';\r\n\tattrib: { url: string, title: string, artist: string } | null = null;\r\n\tchangeCount = 0;\r\n\tmenuColors: string[] | null = null;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\ttry {\r\n\t\t\tlet bg = localStorage.getItem('showdown_bg')?.split('\\n') || [''];\r\n\t\t\tif (bg.length === 1) {\r\n\t\t\t\t// id\r\n\t\t\t\tthis.load('', bg[0]);\r\n\t\t\t} else if (bg.length === 2) {\r\n\t\t\t\t// url, id\r\n\t\t\t\tthis.load(bg[0], bg[1]);\r\n\t\t\t} else if (bg.length >= 7) {\r\n\t\t\t\t// url, id, menuColors\r\n\t\t\t\tthis.load(bg[0], bg[1], bg.slice(2));\r\n\t\t\t}\r\n\t\t} catch {}\r\n\t}\r\n\tsave(bgUrl: string) {\r\n\t\tif (this.id !== 'custom') {\r\n\t\t\tlocalStorage.setItem('showdown_bg', this.id);\r\n\t\t} else if (this.menuColors) {\r\n\t\t\tlocalStorage.setItem('showdown_bg', bgUrl + '\\n' + this.id + '\\n' + this.menuColors.join('\\n'));\r\n\t\t} else {\r\n\t\t\tlocalStorage.setItem('showdown_bg', bgUrl + '\\n' + this.id);\r\n\t\t}\r\n\t}\r\n\tset(bgUrl: string, bgid: string) {\r\n\t\tthis.load(bgUrl, bgid);\r\n\t\tthis.save(bgUrl);\r\n\t}\r\n\r\n\tload(bgUrl: string, bgid: string, menuColors: string[] | null = null) {\r\n\t\t// id\r\n\t\tthis.id = bgid;\r\n\r\n\t\t// curid\r\n\t\tif (!bgid) {\r\n\t\t\tif (location.host === 'smogtours.psim.us') {\r\n\t\t\t\tbgid = 'shaymin';\r\n\t\t\t} else {\r\n\t\t\t\tconst bgs = ['horizon', 'ocean', 'waterfall', 'shaymin', 'charizards'];\r\n\t\t\t\tbgid = bgs[Math.floor(Math.random() * 5)];\r\n\t\t\t\t// if someone clicked the random button, try to roll a different bg than before\r\n\t\t\t\tif (bgid === this.curId) bgid = bgs[Math.floor(Math.random() * 5)];\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.curId = bgid;\r\n\r\n\t\tif (!bgUrl) {\r\n\t\t\tbgUrl = (bgid === 'solidblue' ? '#344b6c' : PSURL + 'fx/client-bg-' + bgid + '.jpg');\r\n\t\t}\r\n\r\n\t\t// April Fool's 2016 - Digimon theme\r\n\t\t// bgid = 'digimon';\r\n\t\t// bgUrl = PSURL + 'sprites/afd/digimonbg.jpg';\r\n\r\n\t\tthis.changeCount++;\r\n\r\n\t\t// menuColors, attrib\r\n\t\tlet attrib = null;\r\n\t\tswitch (bgid) {\r\n\t\tcase 'horizon':\r\n\t\t\tmenuColors = [\r\n\t\t\t\t\"318.87640449438203,35.177865612648226%\",\r\n\t\t\t\t\"216,46.2962962962963%\",\r\n\t\t\t\t\"221.25,32.25806451612904%\",\r\n\t\t\t\t\"197.8021978021978,52.60115606936417%\",\r\n\t\t\t\t\"232.00000000000003,19.480519480519483%\",\r\n\t\t\t\t\"228.38709677419354,60.7843137254902%\",\r\n\t\t\t];\r\n\t\t\tattrib = {\r\n\t\t\t\turl: 'https://vtas.deviantart.com/art/Pokemon-Horizon-312267168',\r\n\t\t\t\ttitle: 'Horizon',\r\n\t\t\t\tartist: 'Vivian Zou',\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase 'ocean':\r\n\t\t\tmenuColors = [\r\n\t\t\t\t\"82.8169014084507,34.63414634146342%\",\r\n\t\t\t\t\"216.16438356164383,29.55465587044534%\",\r\n\t\t\t\t\"212.92682926829266,59.42028985507245%\",\r\n\t\t\t\t\"209.18918918918916,57.51295336787566%\",\r\n\t\t\t\t\"199.2857142857143,48.275862068965495%\",\r\n\t\t\t\t\"213.11999999999998,55.06607929515419%\",\r\n\t\t\t];\r\n\t\t\tattrib = {\r\n\t\t\t\turl: 'https://quanyails.deviantart.com/art/Sunrise-Ocean-402667154',\r\n\t\t\t\ttitle: 'Sunrise Ocean',\r\n\t\t\t\tartist: 'Quanyails',\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase 'waterfall':\r\n\t\t\tmenuColors = [\r\n\t\t\t\t\"119.31034482758622,37.66233766233767%\",\r\n\t\t\t\t\"184.36363636363635,23.012552301255226%\",\r\n\t\t\t\t\"108.92307692307692,37.14285714285714%\",\r\n\t\t\t\t\"70.34482758620689,20.567375886524818%\",\r\n\t\t\t\t\"98.39999999999998,36.76470588235296%\",\r\n\t\t\t\t\"140,38.18181818181818%\",\r\n\t\t\t];\r\n\t\t\tattrib = {\r\n\t\t\t\turl: 'https://x.com/Yilxaevum',\r\n\t\t\t\ttitle: 'Irie',\r\n\t\t\t\tartist: 'Samuel Teo',\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase 'shaymin':\r\n\t\t\tmenuColors = [\r\n\t\t\t\t\"39.000000000000064,21.7391304347826%\",\r\n\t\t\t\t\"170.00000000000003,2.380952380952378%\",\r\n\t\t\t\t\"157.5,11.88118811881188%\",\r\n\t\t\t\t\"174.78260869565216,12.041884816753928%\",\r\n\t\t\t\t\"185.00000000000003,12.76595744680851%\",\r\n\t\t\t\t\"20,5.660377358490567%\",\r\n\t\t\t];\r\n\t\t\tattrib = {\r\n\t\t\t\turl: 'http://cargocollective.com/bluep',\r\n\t\t\t\ttitle: 'Shaymin',\r\n\t\t\t\tartist: 'Daniel Kong',\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase 'charizards':\r\n\t\t\tmenuColors = [\r\n\t\t\t\t\"37.159090909090914,74.57627118644066%\",\r\n\t\t\t\t\"10.874999999999998,70.79646017699115%\",\r\n\t\t\t\t\"179.51612903225808,52.10084033613446%\",\r\n\t\t\t\t\"20.833333333333336,36.73469387755102%\",\r\n\t\t\t\t\"192.3076923076923,80.41237113402063%\",\r\n\t\t\t\t\"210,29.629629629629633%\",\r\n\t\t\t];\r\n\t\t\tattrib = {\r\n\t\t\t\turl: 'https://lit.link/en/seiryuuden',\r\n\t\t\t\ttitle: 'Charizards',\r\n\t\t\t\tartist: 'Jessica Valencia',\r\n\t\t\t};\r\n\t\t\tbreak;\r\n\t\tcase 'digimon':\r\n\t\t\tmenuColors = [\r\n\t\t\t\t\"170.45454545454544,27.500000000000004%\",\r\n\t\t\t\t\"84.70588235294119,13.821138211382115%\",\r\n\t\t\t\t\"112.50000000000001,7.8431372549019605%\",\r\n\t\t\t\t\"217.82608695652175,54.761904761904766%\",\r\n\t\t\t\t\"0,1.6949152542372816%\",\r\n\t\t\t\t\"\",\r\n\t\t\t];\r\n\t\t}\r\n\t\tif (!menuColors && bgUrl.startsWith('#')) {\r\n\t\t\tconst r = parseInt(bgUrl.slice(1, 3), 16) / 255;\r\n\t\t\tconst g = parseInt(bgUrl.slice(3, 5), 16) / 255;\r\n\t\t\tconst b = parseInt(bgUrl.slice(5, 7), 16) / 255;\r\n\t\t\tconst hs = this.getHueSat(r, g, b);\r\n\t\t\tmenuColors = [hs, hs, hs, hs, hs, hs];\r\n\t\t}\r\n\t\tthis.attrib = attrib;\r\n\t\tthis.menuColors = menuColors;\r\n\t\tif (!menuColors) {\r\n\t\t\tthis.extractMenuColors(bgUrl);\r\n\t\t}\r\n\t\tthis.update(bgUrl);\r\n\t}\r\n\textractMenuColors(bgUrl: string) {\r\n\t\tconst changeCount = this.changeCount;\r\n\t\t// We need the image object to load it on a canvas to detect the main color.\r\n\t\tconst img = new Image();\r\n\t\timg.onload = () => {\r\n\t\t\tif (changeCount !== PSBackground.changeCount) return;\r\n\t\t\tif (window.ColorThief) {\r\n\t\t\t\tthis.extractMenuColorsFromImg(img, bgUrl);\r\n\t\t\t} else {\r\n\t\t\t\tPS.libsLoaded.then(() => {\r\n\t\t\t\t\tif (changeCount !== PSBackground.changeCount) return;\r\n\t\t\t\t\tthis.extractMenuColorsFromImg(img, bgUrl);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t};\r\n\t\timg.src = bgUrl;\r\n\t}\r\n\textractMenuColorsFromImg(img: HTMLImageElement, bgUrl: string) {\r\n\t\t// in case ColorThief throws from canvas,\r\n\t\t// or localStorage throws\r\n\t\ttry {\r\n\t\t\tconst colorThief = new ColorThief();\r\n\t\t\tconst colors = colorThief.getPalette(img, 5);\r\n\r\n\t\t\tlet menuColors = [];\r\n\t\t\tif (!colors) {\r\n\t\t\t\tmenuColors = ['0, 0%', '0, 0%', '0, 0%', '0, 0%', '0, 0%'];\r\n\t\t\t} else {\r\n\t\t\t\tfor (let i = 0; i < 5; i++) {\r\n\t\t\t\t\tconst color = colors[i];\r\n\t\t\t\t\tconst hs = PSBackground.getHueSat(color[0] / 255, color[1] / 255, color[2] / 255);\r\n\t\t\t\t\tmenuColors.unshift(hs);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.menuColors = menuColors;\r\n\t\t\tthis.update(null);\r\n\t\t\tPSBackground.save(bgUrl);\r\n\t\t} catch {}\r\n\t}\r\n\tgetHueSat(r: number, g: number, b: number) {\r\n\t\tconst max = Math.max(r, g, b);\r\n\t\tconst min = Math.min(r, g, b);\r\n\t\tif (max === min) {\r\n\t\t\treturn `0,0%`;\r\n\t\t}\r\n\t\tconst l = (max + min) / 2;\r\n\t\tconst d = max - min;\r\n\t\tconst s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\r\n\t\tlet h = 0;\r\n\t\tswitch (max) {\r\n\t\tcase r: h = (g - b) / d + (g < b ? 6 : 0); break;\r\n\t\tcase g: h = (b - r) / d + 2; break;\r\n\t\tcase b: h = (r - g) / d + 4; break;\r\n\t\t}\r\n\t\th /= 6;\r\n\t\treturn `${h * 360},${s * 100}%`;\r\n\t}\r\n};\r\n\r\n/**********************************************************************\r\n * Core Views\r\n *********************************************************************/\r\n\r\nPSBackground.subscribe(bgUrl => {\r\n\tif (!PSBackground.curId) {\r\n\t\tdocument.body.style.background = '';\r\n\t\tdocument.body.style.backgroundSize = '';\r\n\t\tconst buttonStyleElem = document.getElementById('mainmenubuttoncolors');\r\n\t\tif (buttonStyleElem) buttonStyleElem.textContent = ``;\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (bgUrl !== null) {\r\n\t\tlet background;\r\n\t\tif (bgUrl.startsWith('#')) {\r\n\t\t\tbackground = bgUrl;\r\n\t\t} else if (PSBackground.curId !== 'custom') {\r\n\t\t\tbackground = `#546bac url(${bgUrl}) no-repeat left center fixed`;\r\n\t\t} else {\r\n\t\t\tbackground = `#546bac url(${bgUrl}) no-repeat center center fixed`;\r\n\t\t}\r\n\t\tdocument.body.style.background = background;\r\n\t\tdocument.body.style.backgroundSize = 'cover';\r\n\t}\r\n\r\n\t// main menu button colors\r\n\tlet cssBuf = ``;\r\n\tlet n = 0;\r\n\tif (PSBackground.menuColors) {\r\n\t\tfor (const hs of PSBackground.menuColors) {\r\n\t\t\tn++;\r\n\t\t\tcssBuf += `body .button.mainmenu${n} { background: linear-gradient(to bottom,  hsl(${hs},72%),  hsl(${hs},52%)); border-color: hsl(${hs},40%); }\\n`;\r\n\t\t\tcssBuf += `body .button.mainmenu${n}:hover { background: linear-gradient(to bottom,  hsl(${hs},62%),  hsl(${hs},42%)); border-color: hsl(${hs},21%); }\\n`;\r\n\t\t\tcssBuf += `body .button.mainmenu${n}:active { background: linear-gradient(to bottom,  hsl(${hs},42%),  hsl(${hs},58%)); border-color: hsl(${hs},21%); }\\n`;\r\n\t\t}\r\n\t}\r\n\tlet buttonStyleElem = document.getElementById('mainmenubuttoncolors');\r\n\tif (!buttonStyleElem) {\r\n\t\tif (cssBuf) {\r\n\t\t\t// Create a <style> element the correct way\r\n\t\t\t// Direct construction like `new HTMLStyleElement()` throws an error,\r\n\t\t\t// so we use document.createElement instead\r\n\t\t\tbuttonStyleElem = document.createElement(\"style\");\r\n\t\t\tbuttonStyleElem.id = 'mainmenubuttoncolors';\r\n\t\t\tbuttonStyleElem.textContent = cssBuf;\r\n\t\t\tdocument.head.appendChild(buttonStyleElem);\r\n\t\t}\r\n\t} else {\r\n\t\tbuttonStyleElem.textContent = cssBuf;\r\n\t}\r\n});\r\n// '<a href=\"https://vtas.deviantart.com/art/Pokemon-Horizon-312267168\" target=\"_blank\" class=\"subtle\">\"Horizon\" <small>background by Vivian Zou</small></a>';\r\n// if (attrib) attrib = '<small style=\"display:block;padding-bottom:4px\">' + attrib + '</small>';\r\n"],"mappings":"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","ignoreList":[]}