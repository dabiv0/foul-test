{"version":3,"file":"client-connection.js","names":["PSConnection","_this","socket","connected","queue","reconnectDelay","reconnectCap","shouldReconnect","reconnectTimer","worker","loading","PSStorage","init","then","initConnection","_proto","prototype","tryConnectInWorker","directConnect","canReconnect","uptime","Date","now","PS","startTime","confirm","okButton","confirmed","_PS$room","room","send","_this2","Worker","postMessage","type","server","onmessage","event","_event$data","data","console","log","forEach","msg","update","receive","handleDisconnect","warn","onerror","e","_unused","_this3","port","protocol","httpport","url","host","prefix","SockJS","timeout","_unused2","WebSocket","replace","onopen","ev","onclose","isOffline","roomid","rooms","alert","retryConnection","_this4","setTimeout","mainmenu","Math","min","disconnect","_this$socket","_this$worker","close","terminate","connection","reconnectTest","_this$socket2","_this$worker2","push","connect","_PS$connection","prefs","doAutojoin","_this5","loaded","Config","testclient","location","hostname","origin","_Config","defaultserver","window","addEventListener","onMessage","document","routes","client","iframe","createElement","src","encodeURIComponent","pathname","substr","style","display","body","appendChild","_Config2","$","appendTo","Promise","resolve","loader","request","uri","requests","idx","requestCount","postCrossOriginMessage","JSON","stringify","_PSStorage","frame","source","charAt","parse","registered","id","link","rel","href","head","Object","assign","newData","load","save","prefData","storage","localStorage","setItem","_unused3","nodewebkit","oldTeams","teams","list","length","unpackAll","packedTeams","packAll","_unused4","concat","removeItem","getItem","_unused5","undefined","reqData","slice","_unused6","PSLoginServer","_class","_proto2","rawQuery","act","endsWith","POKEMON_SHOWDOWN_TESTCLIENT_KEY","sid","Net","get","method","res","query","arguments","HttpError","_Error","message","statusCode","_this6","call","name","Error","captureStackTrace","_unused7","_inheritsLoose","_wrapNativeSuper","NetRequest","_proto3","_this7","opts","reject","xhr","XMLHttpRequest","includes","encodeQuery","open","onreadystatechange","DONE","readyState","status","responseText","err","statusText","setRequestHeader","post","startsWith","defaultRoute","urlencodedData","key","value","formData","form","elements","querySelectorAll","out","_i2","element","getAttribute","checked"],"sources":["../src/client-connection.ts"],"sourcesContent":["/**\r\n * Connection library\r\n *\r\n * @author Guangcong Luo <guangcongluo@gmail.com>\r\n * @license MIT\r\n */\r\n\r\nimport { Config, PS } from \"./client-main\";\r\n\r\ndeclare const SockJS: any;\r\ndeclare const POKEMON_SHOWDOWN_TESTCLIENT_KEY: string | undefined;\r\n\r\nexport class PSConnection {\r\n\tsocket: WebSocket | null = null;\r\n\tconnected = false;\r\n\tqueue: string[] = [];\r\n\treconnectDelay = 1000;\r\n\tprivate reconnectCap = 15000;\r\n\tprivate shouldReconnect = true;\r\n\treconnectTimer: ReturnType<typeof setTimeout> | null = null;\r\n\tprivate worker: Worker | null = null;\r\n\r\n\tconstructor() {\r\n\t\tconst loading = PSStorage.init();\r\n\t\tif (loading) {\r\n\t\t\tloading.then(() => {\r\n\t\t\t\tthis.initConnection();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.initConnection();\r\n\t\t}\r\n\t}\r\n\r\n\tinitConnection() {\r\n\t\tif (!this.tryConnectInWorker()) this.directConnect();\r\n\t}\r\n\r\n\tcanReconnect() {\r\n\t\tconst uptime = Date.now() - PS.startTime;\r\n\t\tif (uptime > 24 * 60 * 60 * 1000) {\r\n\t\t\tPS.confirm(`It's been over a day since you first connected. Please refresh.`, {\r\n\t\t\t\tokButton: 'Refresh',\r\n\t\t\t}).then(confirmed => {\r\n\t\t\t\tif (confirmed) PS.room?.send(`/refresh`);\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\treturn this.shouldReconnect;\r\n\t}\r\n\r\n\ttryConnectInWorker(): boolean {\r\n\t\tif (this.socket) return false; // must be one or the other\r\n\r\n\t\ttry {\r\n\t\t\tconst worker = new Worker('/js/client-connection-worker.js');\r\n\t\t\tthis.worker = worker;\r\n\r\n\t\t\tworker.postMessage({ type: 'connect', server: PS.server });\r\n\r\n\t\t\tworker.onmessage = event => {\r\n\t\t\t\tconst { type, data } = event.data;\r\n\t\t\t\tswitch (type) {\r\n\t\t\t\tcase 'connected':\r\n\t\t\t\t\tconsole.log('\\u2705 (CONNECTED via worker)');\r\n\t\t\t\t\tthis.connected = true;\r\n\t\t\t\t\tPS.connected = true;\r\n\t\t\t\t\tthis.queue.forEach(msg => worker.postMessage({ type: 'send', data: msg }));\r\n\t\t\t\t\tthis.queue = [];\r\n\t\t\t\t\tPS.update();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'message':\r\n\t\t\t\t\tPS.receive(data);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'disconnected':\r\n\t\t\t\t\tthis.handleDisconnect();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'error':\r\n\t\t\t\t\tconsole.warn(`Worker connection error: ${data}`);\r\n\t\t\t\t\tthis.worker = null;\r\n\t\t\t\t\t// onerror can occur on abrupt disconnects or fatal errors.\r\n\t\t\t\t\t// handleDisconnect ensures proper cleanup and also attemps to reconnect.\r\n\t\t\t\t\tthis.handleDisconnect(); // fallback\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t\tworker.onerror = (e: ErrorEvent) => {\r\n\t\t\t\tconsole.warn('Worker connection error:', e);\r\n\t\t\t\tthis.worker = null;\r\n\t\t\t\tthis.directConnect(); // fallback\r\n\t\t\t};\r\n\r\n\t\t\treturn true;\r\n\t\t} catch {\r\n\t\t\tconsole.warn('Worker connection failed, falling back to regular connection.');\r\n\t\t\tthis.worker = null;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdirectConnect() {\r\n\t\tif (this.worker) return; // must be one or the other\r\n\r\n\t\tconst server = PS.server;\r\n\t\tconst port = server.protocol === 'https' ? `:${server.port}` : `:${server.httpport!}`;\r\n\t\tconst url = `${server.protocol}://${server.host}${port}${server.prefix}`;\r\n\r\n\t\ttry {\r\n\t\t\tthis.socket = new SockJS(url, [], { timeout: 5 * 60 * 1000 });\r\n\t\t} catch {\r\n\t\t\tthis.socket = new WebSocket(url.replace('http', 'ws') + '/websocket');\r\n\t\t}\r\n\r\n\t\tconst socket = this.socket!;\r\n\r\n\t\tsocket.onopen = () => {\r\n\t\t\tconsole.log('\\u2705 (CONNECTED)');\r\n\t\t\tthis.connected = true;\r\n\t\t\tPS.connected = true;\r\n\t\t\tthis.reconnectDelay = 1000;\r\n\t\t\tthis.queue.forEach(msg => socket.send(msg));\r\n\t\t\tthis.queue = [];\r\n\t\t\tPS.update();\r\n\t\t};\r\n\r\n\t\tsocket.onmessage = (ev: MessageEvent) => {\r\n\t\t\tPS.receive('' + ev.data);\r\n\t\t};\r\n\r\n\t\tsocket.onclose = () => {\r\n\t\t\tconsole.log('\\u274C (DISCONNECTED)');\r\n\t\t\tthis.handleDisconnect();\r\n\t\t\tconsole.log('\\u2705 (DISCONNECTED)');\r\n\t\t\tthis.connected = false;\r\n\t\t\tPS.connected = false;\r\n\t\t\tPS.isOffline = true;\r\n\t\t\tfor (const roomid in PS.rooms) {\r\n\t\t\t\tconst room = PS.rooms[roomid]!;\r\n\t\t\t\tif (room.connected === true) room.connected = 'autoreconnect';\r\n\t\t\t}\r\n\t\t\tthis.socket = null;\r\n\t\t\tPS.update();\r\n\t\t};\r\n\r\n\t\tsocket.onerror = (ev: Event) => {\r\n\t\t\tPS.connected = false;\r\n\t\t\tPS.isOffline = true;\r\n\t\t\t// no useful info to print from the event\r\n\t\t\tPS.alert(`Connection error`);\r\n\t\t\tthis.retryConnection();\r\n\t\t\tPS.update();\r\n\t\t};\r\n\t}\r\n\r\n\tprivate handleDisconnect() {\r\n\t\tthis.connected = false;\r\n\t\tPS.connected = false;\r\n\t\tPS.isOffline = true;\r\n\t\tthis.socket = null;\r\n\t\tfor (const roomid in PS.rooms) {\r\n\t\t\tconst room = PS.rooms[roomid]!;\r\n\t\t\tif (room.connected === true) room.connected = 'autoreconnect';\r\n\t\t}\r\n\t\tthis.retryConnection();\r\n\t\tPS.update();\r\n\t}\r\n\r\n\tprivate retryConnection() {\r\n\t\tif (!this.canReconnect()) return;\r\n\t\tif (this.reconnectTimer) return;\r\n\t\tthis.reconnectTimer = setTimeout(() => {\r\n\t\t\tthis.reconnectTimer = null;\r\n\t\t\tif (!this.connected && this.canReconnect()) {\r\n\t\t\t\tPS.mainmenu.send('/reconnect');\r\n\t\t\t\tthis.reconnectDelay = Math.min(this.reconnectDelay * 2, this.reconnectCap);\r\n\t\t\t}\r\n\t\t}, this.reconnectDelay);\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tthis.shouldReconnect = false;\r\n\t\tthis.socket?.close();\r\n\t\tthis.worker?.terminate();\r\n\t\tthis.worker = null;\r\n\t\tPS.connection = null;\r\n\t\tPS.connected = false;\r\n\t\tPS.isOffline = true;\r\n\t}\r\n\r\n\treconnectTest() {\r\n\t\tthis.socket?.close();\r\n\t\tthis.worker?.postMessage({ type: 'disconnect' });\r\n\t\tthis.worker = null;\r\n\t\tPS.connected = false;\r\n\t\tPS.isOffline = true;\r\n\t}\r\n\r\n\tsend(msg: string) {\r\n\t\tif (!this.connected) {\r\n\t\t\tthis.queue.push(msg);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.worker) {\r\n\t\t\tthis.worker.postMessage({ type: 'send', data: msg });\r\n\t\t} else if (this.socket) {\r\n\t\t\tthis.socket.send(msg);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic connect() {\r\n\t\tif (PS.connection?.socket) return;\r\n\t\tPS.isOffline = false;\r\n\t\tif (!PS.connection) {\r\n\t\t\tPS.connection = new PSConnection();\r\n\t\t} else {\r\n\t\t\tPS.connection.directConnect();\r\n\t\t}\r\n\t\tPS.prefs.doAutojoin();\r\n\t}\r\n}\r\n\r\nexport class PSStorage {\r\n\tstatic frame: WindowProxy | null = null;\r\n\tstatic requests: Record<string, (data: any) => void> | null = null;\r\n\tstatic requestCount = 0;\r\n\tstatic readonly origin = `https://${Config.routes.client}`;\r\n\tstatic loader?: () => void;\r\n\tstatic loaded: Promise<void> | boolean = false;\r\n\tstatic init(): void | Promise<void> {\r\n\t\tif (this.loaded) {\r\n\t\t\tif (this.loaded === true) return;\r\n\t\t\treturn this.loaded;\r\n\t\t}\r\n\t\tif (Config.testclient) {\r\n\t\t\treturn;\r\n\t\t} else if (`${location.protocol}//${location.hostname}` === PSStorage.origin) {\r\n\t\t\t// Same origin, everything can be kept as default\r\n\t\t\tConfig.server ||= Config.defaultserver;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Cross-origin\r\n\t\tif (!('postMessage' in window)) {\r\n\t\t\t// browser does not support cross-document messaging\r\n\t\t\tPS.alert(\"Sorry, psim connections are unsupported by your browser.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\twindow.addEventListener('message', this.onMessage);\r\n\r\n\t\tif (document.location.hostname !== Config.routes.client) {\r\n\t\t\tconst iframe = document.createElement('iframe');\r\n\t\t\tiframe.src = 'https://' + Config.routes.client + '/crossdomain.php?host=' +\r\n\t\t\t\tencodeURIComponent(document.location.hostname) +\r\n\t\t\t\t'&path=' + encodeURIComponent(document.location.pathname.substr(1)) +\r\n\t\t\t\t'&protocol=' + encodeURIComponent(document.location.protocol);\r\n\t\t\tiframe.style.display = 'none';\r\n\t\t\tdocument.body.appendChild(iframe);\r\n\t\t} else {\r\n\t\t\tConfig.server ||= Config.defaultserver;\r\n\t\t\t$(\r\n\t\t\t\t`<iframe src=\"https://${Config.routes.client}/crossprotocol.html?v1.2\" style=\"display: none;\"></iframe>`\r\n\t\t\t).appendTo('body');\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\t// HTTPS may be blocked\r\n\t\t\t\t// yes, this happens, blame Avast! and BitDefender and other antiviruses\r\n\t\t\t\t// that feel a need to MitM HTTPS poorly\r\n\t\t\t}, 2000);\r\n\t\t}\r\n\t\tthis.loaded = new Promise(resolve => {\r\n\t\t\tthis.loader = resolve;\r\n\t\t});\r\n\t\treturn this.loaded;\r\n\t}\r\n\r\n\tstatic onMessage = (e: MessageEvent) => {\r\n\t\tif (e.origin !== PSStorage.origin) return;\r\n\r\n\t\tthis.frame = e.source as WindowProxy;\r\n\t\tconst data = e.data;\r\n\t\t// console.log(`top recv: ${data}`);\r\n\t\tswitch (data.charAt(0)) {\r\n\t\tcase 'c':\r\n\t\t\tConfig.server = JSON.parse(data.substr(1));\r\n\t\t\tif (Config.server.registered && Config.server.id !== 'showdown' && Config.server.id !== 'smogtours') {\r\n\t\t\t\tconst link = document.createElement('link');\r\n\t\t\t\tlink.rel = 'stylesheet';\r\n\t\t\t\tlink.href = `//${Config.routes.client}/customcss.php?server=${encodeURIComponent(Config.server.id)}`;\r\n\t\t\t\tdocument.head.appendChild(link);\r\n\t\t\t}\r\n\t\t\tObject.assign(PS.server, Config.server);\r\n\t\t\tbreak;\r\n\t\tcase 'p':\r\n\t\t\tconst newData = JSON.parse(data.substr(1));\r\n\t\t\tif (newData) PS.prefs.load(newData, true);\r\n\t\t\tPS.prefs.save = function () {\r\n\t\t\t\tconst prefData = JSON.stringify(PS.prefs.storage);\r\n\t\t\t\tPSStorage.postCrossOriginMessage('P' + prefData);\r\n\r\n\t\t\t\t// in Safari, cross-origin local storage is apparently treated as session\r\n\t\t\t\t// storage, so mirror the storage in the current origin just in case\r\n\t\t\t\ttry {\r\n\t\t\t\t\tlocalStorage.setItem('showdown_prefs', prefData);\r\n\t\t\t\t} catch {}\r\n\t\t\t};\r\n\t\t\tPS.prefs.update(null);\r\n\t\t\tbreak;\r\n\t\tcase 't':\r\n\t\t\tif (window.nodewebkit) return;\r\n\t\t\tlet oldTeams;\r\n\t\t\tif (PS.teams.list.length) {\r\n\t\t\t\t// Teams are still stored in the old location; merge them with the\r\n\t\t\t\t// new teams.\r\n\t\t\t\toldTeams = PS.teams.list;\r\n\t\t\t}\r\n\t\t\tPS.teams.unpackAll(data.substr(1));\r\n\t\t\tPS.teams.save = function () {\r\n\t\t\t\tconst packedTeams = PS.teams.packAll(PS.teams.list);\r\n\t\t\t\tPSStorage.postCrossOriginMessage('T' + packedTeams);\r\n\r\n\t\t\t\t// in Safari, cross-origin local storage is apparently treated as session\r\n\t\t\t\t// storage, so mirror the storage in the current origin just in case\r\n\t\t\t\tif (document.location.hostname === Config.routes.client) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tlocalStorage.setItem('showdown_teams_local', packedTeams);\r\n\t\t\t\t\t} catch {}\r\n\t\t\t\t}\r\n\t\t\t\tPS.teams.update('team');\r\n\t\t\t};\r\n\t\t\tif (oldTeams) {\r\n\t\t\t\tPS.teams.list = PS.teams.list.concat(oldTeams);\r\n\t\t\t\tPS.teams.save();\r\n\t\t\t\tlocalStorage.removeItem('showdown_teams');\r\n\t\t\t}\r\n\t\t\tif (data === 'tnull' && !PS.teams.list.length) {\r\n\t\t\t\tPS.teams.unpackAll(localStorage.getItem('showdown_teams_local'));\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase 'a':\r\n\t\t\tif (data === 'a0') {\r\n\t\t\t\tPS.alert(\"Your browser doesn't support third-party cookies. Some things might not work correctly.\");\r\n\t\t\t}\r\n\t\t\tif (!window.nodewebkit) {\r\n\t\t\t\t// for whatever reason, Node-Webkit doesn't let us make remote\r\n\t\t\t\t// Ajax requests or something. Oh well, making them direct\r\n\t\t\t\t// isn't a problem, either.\r\n\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// I really hope this is a Chrome bug that this can fail\r\n\t\t\t\t\tPSStorage.frame!.postMessage(\"\", PSStorage.origin);\r\n\t\t\t\t} catch {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tPSStorage.requests = {};\r\n\t\t\t}\r\n\t\t\tPSStorage.loaded = true;\r\n\t\t\tPSStorage.loader?.();\r\n\t\t\tPSStorage.loader = undefined;\r\n\t\t\tbreak;\r\n\t\tcase 'r':\r\n\t\t\tconst reqData = JSON.parse(data.slice(1));\r\n\t\t\tconst idx = reqData[0];\r\n\t\t\tif (PSStorage.requests![idx]) {\r\n\t\t\t\tPSStorage.requests![idx](reqData[1]);\r\n\t\t\t\tdelete PSStorage.requests![idx];\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\t}\r\n\t};\r\n\tstatic request(type: 'GET' | 'POST', uri: string, data: any): void | Promise<string> {\r\n\t\tif (!PSStorage.requests) return;\r\n\t\tconst idx = PSStorage.requestCount++;\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tPSStorage.requests![idx] = resolve;\r\n\t\t\tPSStorage.postCrossOriginMessage((type === 'GET' ? 'R' : 'S') + JSON.stringify([uri, data, idx, 'text']));\r\n\t\t});\r\n\t}\r\n\tstatic postCrossOriginMessage = function (data: string) {\r\n\t\ttry {\r\n\t\t\t// I really hope this is a Chrome bug that this can fail\r\n\t\t\treturn PSStorage.frame!.postMessage(data, PSStorage.origin);\r\n\t\t} catch {\r\n\t\t}\r\n\t\treturn false;\r\n\t};\r\n};\r\n\r\nPSConnection.connect();\r\n\r\nexport const PSLoginServer = new class {\r\n\trawQuery(act: string, data: PostData): Promise<string | null> {\r\n\t\t// commenting out because for some reason this is working in Chrome????\r\n\t\t// if (location.protocol === 'file:') {\r\n\t\t// \talert(\"Sorry, login server queries don't work in the testclient. To log in, see README.md to set up testclient-key.js\");\r\n\t\t// \treturn Promise.resolve(null);\r\n\t\t// }\r\n\t\tdata.act = act;\r\n\t\tlet url = '/~~' + PS.server.id + '/action.php';\r\n\t\tif (location.pathname.endsWith('.html')) {\r\n\t\t\turl = 'https://' + Config.routes.client + url;\r\n\t\t\tif (typeof POKEMON_SHOWDOWN_TESTCLIENT_KEY === 'string') {\r\n\t\t\t\tdata.sid = POKEMON_SHOWDOWN_TESTCLIENT_KEY.replace(/%2C/g, ',');\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn PSStorage.request('POST', url, data) || Net(url).get({ method: 'POST', body: data }).then(\r\n\t\t\tres => res ?? null\r\n\t\t).catch(\r\n\t\t\t() => null\r\n\t\t);\r\n\t}\r\n\tquery(act: string, data: PostData = {}): Promise<{ [k: string]: any } | null> {\r\n\t\treturn this.rawQuery(act, data).then(\r\n\t\t\tres => res ? JSON.parse(res.slice(1)) : null\r\n\t\t).catch(\r\n\t\t\t() => null\r\n\t\t);\r\n\t}\r\n};\r\n\r\ninterface PostData {\r\n\t[key: string]: string | number | boolean | null | undefined;\r\n}\r\ninterface NetRequestOptions {\r\n\tmethod?: 'GET' | 'POST';\r\n\tbody?: string | PostData;\r\n\tquery?: PostData;\r\n}\r\nclass HttpError extends Error {\r\n\tstatusCode?: number;\r\n\tbody: string;\r\n\tconstructor(message: string, statusCode: number | undefined, body: string) {\r\n\t\tsuper(message);\r\n\t\tthis.name = 'HttpError';\r\n\t\tthis.statusCode = statusCode;\r\n\t\tthis.body = body;\r\n\t\ttry {\r\n\t\t\t(Error as any).captureStackTrace(this, HttpError);\r\n\t\t} catch {}\r\n\t}\r\n}\r\nclass NetRequest {\r\n\turi: string;\r\n\tconstructor(uri: string) {\r\n\t\tthis.uri = uri;\r\n\t}\r\n\r\n\t/**\r\n\t * Makes a basic http/https request to the URI.\r\n\t * Returns the response data.\r\n\t *\r\n\t * Will throw if the response code isn't 200 OK.\r\n\t *\r\n\t * @param opts request opts\r\n\t */\r\n\tget(opts: NetRequestOptions = {}): Promise<string> {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst xhr = new XMLHttpRequest();\r\n\t\t\tlet uri = this.uri;\r\n\t\t\tif (opts.query) {\r\n\t\t\t\turi += (uri.includes('?') ? '&' : '?') + Net.encodeQuery(opts.query);\r\n\t\t\t}\r\n\t\t\txhr.open(opts.method || 'GET', uri);\r\n\t\t\txhr.onreadystatechange = function () {\r\n\t\t\t\tconst DONE = 4;\r\n\t\t\t\tif (xhr.readyState === DONE) {\r\n\t\t\t\t\tif (xhr.status === 200) {\r\n\t\t\t\t\t\tresolve(xhr.responseText || '');\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst err = new HttpError(xhr.statusText || \"Connection error\", xhr.status, xhr.responseText);\r\n\t\t\t\t\treject(err);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tif (opts.body) {\r\n\t\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\r\n\t\t\t\txhr.send(Net.encodeQuery(opts.body));\r\n\t\t\t} else {\r\n\t\t\t\txhr.send();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Makes a http/https POST request to the given link.\r\n\t * @param opts request opts\r\n\t * @param body POST body\r\n\t */\r\n\tpost(opts: Omit<NetRequestOptions, 'body'>, body: PostData | string): Promise<string>;\r\n\t/**\r\n\t * Makes a http/https POST request to the given link.\r\n\t * @param opts request opts\r\n\t */\r\n\tpost(opts?: NetRequestOptions): Promise<string>;\r\n\tpost(opts: NetRequestOptions = {}, body?: PostData | string) {\r\n\t\tif (!body) body = opts.body;\r\n\t\treturn this.get({\r\n\t\t\t...opts,\r\n\t\t\tmethod: 'POST',\r\n\t\t\tbody,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport function Net(uri: string) {\r\n\tif (uri.startsWith('/') && !uri.startsWith('//') && Net.defaultRoute) uri = Net.defaultRoute + uri;\r\n\tif (uri.startsWith('//') && document.location.protocol === 'file:') uri = 'https:' + uri;\r\n\treturn new NetRequest(uri);\r\n}\r\n\r\nNet.defaultRoute = '';\r\n\r\nNet.encodeQuery = function (data: string | PostData): string {\r\n\tif (typeof data === 'string') return data;\r\n\tlet urlencodedData = '';\r\n\tfor (const key in data) {\r\n\t\tif (urlencodedData) urlencodedData += '&';\r\n\t\tlet value = data[key];\r\n\t\tif (value === true) value = 'on';\r\n\t\tif (value === false || value === null || value === undefined) value = '';\r\n\t\turlencodedData += encodeURIComponent(key) + '=' + encodeURIComponent(value);\r\n\t}\r\n\treturn urlencodedData;\r\n};\r\n\r\nNet.formData = function (form: HTMLFormElement): { [name: string]: string | boolean } {\r\n\t// not technically all `HTMLInputElement`s but who wants to cast all these?\r\n\tconst elements = form.querySelectorAll<HTMLInputElement>('input[name], select[name], textarea[name]');\r\n\tconst out: { [name: string]: string | boolean } = {};\r\n\tfor (const element of elements) {\r\n\t\tif (element.type === 'checkbox') {\r\n\t\t\tout[element.name] = element.getAttribute('value') ? (\r\n\t\t\t\telement.checked ? element.value : ''\r\n\t\t\t) : (\r\n\t\t\t\t!!element.checked\r\n\t\t\t);\r\n\t\t} else if (element.type !== 'radio' || element.checked) {\r\n\t\t\tout[element.name] = element.value;\r\n\t\t}\r\n\t}\r\n\treturn out;\r\n};\r\n"],"mappings":"mkDAAA;AACA;AACA;AACA;AACA;AACA,GALA;;;;;;;AAYaA,YAAY;;;;;;;;;;AAUxB,SAAAA,aAAA,CAAc,KAAAC,KAAA,WATdC,MAAM,CAAqB,IAAI,MAC/BC,SAAS,CAAG,KAAK,MACjBC,KAAK,CAAa,EAAE,MACpBC,cAAc,CAAG,IAAI,MACbC,YAAY,CAAG,KAAK,MACpBC,eAAe,CAAG,IAAI,MAC9BC,cAAc,CAAyC,IAAI,MACnDC,MAAM,CAAkB,IAAI;AAGnC,GAAM,CAAAC,OAAO,CAAGC,SAAS,CAACC,IAAI,CAAC,CAAC;AAChC,GAAIF,OAAO,CAAE;AACZA,OAAO,CAACG,IAAI,CAAC,UAAM;AAClBZ,KAAI,CAACa,cAAc,CAAC,CAAC;AACtB,CAAC,CAAC;AACH,CAAC,IAAM;AACN,IAAI,CAACA,cAAc,CAAC,CAAC;AACtB;AACD,CAAC,IAAAC,MAAA,CAAAf,YAAA,CAAAgB,SAAA,CAAAD,MAAA;;AAEDD,cAAc,CAAd,SAAAA,cAAcA,CAAA,CAAG;AAChB,GAAI,CAAC,IAAI,CAACG,kBAAkB,CAAC,CAAC,CAAE,IAAI,CAACC,aAAa,CAAC,CAAC;AACrD,CAAC,CAAAH,MAAA;;AAEDI,YAAY,CAAZ,SAAAA,YAAYA,CAAA,CAAG;AACd,GAAM,CAAAC,MAAM,CAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,CAAGC,EAAE,CAACC,SAAS;AACxC,GAAIJ,MAAM,CAAG,EAAE,CAAG,EAAE,CAAG,EAAE,CAAG,IAAI,CAAE;AACjCG,EAAE,CAACE,OAAO,mEAAoE;AAC7EC,QAAQ,CAAE;AACX,CAAC,CAAC,CAACb,IAAI,CAAC,SAAAc,SAAS,CAAI,KAAAC,QAAA;AACpB,GAAID,SAAS,CAAE,CAAAC,QAAA,CAAAL,EAAE,CAACM,IAAI,SAAPD,QAAA,CAASE,IAAI,WAAW,CAAC;AACzC,CAAC,CAAC;AACF,MAAO,MAAK;AACb;AACA,MAAO,KAAI,CAACvB,eAAe;AAC5B,CAAC,CAAAQ,MAAA;;AAEDE,kBAAkB,CAAlB,SAAAA,kBAAkBA,CAAA,CAAY,KAAAc,MAAA;AAC7B,GAAI,IAAI,CAAC7B,MAAM,CAAE,MAAO,MAAK;;AAE7B,GAAI;AACH,GAAM,CAAAO,MAAM,CAAG,GAAI,CAAAuB,MAAM,CAAC,iCAAiC,CAAC;AAC5D,IAAI,CAACvB,MAAM,CAAGA,MAAM;;AAEpBA,MAAM,CAACwB,WAAW,CAAC,CAAEC,IAAI,CAAE,SAAS,CAAEC,MAAM,CAAEZ,EAAE,CAACY,MAAO,CAAC,CAAC;;AAE1D1B,MAAM,CAAC2B,SAAS,CAAG,SAAAC,KAAK,CAAI;AAC3B,IAAAC,WAAA,CAAuBD,KAAK,CAACE,IAAI,CAAzBL,IAAI,CAAAI,WAAA,CAAJJ,IAAI,CAAEK,IAAI,CAAAD,WAAA,CAAJC,IAAI;AAClB,OAAQL,IAAI;AACZ,IAAK,WAAW;AACfM,OAAO,CAACC,GAAG,CAAC,+BAA+B,CAAC;AAC5CV,MAAI,CAAC5B,SAAS,CAAG,IAAI;AACrBoB,EAAE,CAACpB,SAAS,CAAG,IAAI;AACnB4B,MAAI,CAAC3B,KAAK,CAACsC,OAAO,CAAC,SAAAC,GAAG,QAAI,CAAAlC,MAAM,CAACwB,WAAW,CAAC,CAAEC,IAAI,CAAE,MAAM,CAAEK,IAAI,CAAEI,GAAI,CAAC,CAAC,GAAC;AAC1EZ,MAAI,CAAC3B,KAAK,CAAG,EAAE;AACfmB,EAAE,CAACqB,MAAM,CAAC,CAAC;AACX;AACD,IAAK,SAAS;AACbrB,EAAE,CAACsB,OAAO,CAACN,IAAI,CAAC;AAChB;AACD,IAAK,cAAc;AAClBR,MAAI,CAACe,gBAAgB,CAAC,CAAC;AACvB;AACD,IAAK,OAAO;AACXN,OAAO,CAACO,IAAI,6BAA6BR,IAAM,CAAC;AAChDR,MAAI,CAACtB,MAAM,CAAG,IAAI;;;AAGlBsB,MAAI,CAACe,gBAAgB,CAAC,CAAC;AACvB;AACD;AACD,CAAC;;AAEDrC,MAAM,CAACuC,OAAO,CAAG,SAACC,CAAa,CAAK;AACnCT,OAAO,CAACO,IAAI,CAAC,0BAA0B,CAAEE,CAAC,CAAC;AAC3ClB,MAAI,CAACtB,MAAM,CAAG,IAAI;AAClBsB,MAAI,CAACb,aAAa,CAAC,CAAC;AACrB,CAAC;;AAED,MAAO,KAAI;AACZ,CAAE,MAAAgC,OAAA,CAAM;AACPV,OAAO,CAACO,IAAI,CAAC,+DAA+D,CAAC;AAC7E,IAAI,CAACtC,MAAM,CAAG,IAAI;AAClB,MAAO,MAAK;AACb;AACD,CAAC,CAAAM,MAAA;;AAEDG,aAAa,CAAb,SAAAA,aAAaA,CAAA,CAAG,KAAAiC,MAAA;AACf,GAAI,IAAI,CAAC1C,MAAM,CAAE;;AAEjB,GAAM,CAAA0B,MAAM,CAAGZ,EAAE,CAACY,MAAM;AACxB,GAAM,CAAAiB,IAAI,CAAGjB,MAAM,CAACkB,QAAQ,GAAK,OAAO,KAAOlB,MAAM,CAACiB,IAAI,KAASjB,MAAM,CAACmB,QAAW;AACrF,GAAM,CAAAC,GAAG,CAAMpB,MAAM,CAACkB,QAAQ,OAAMlB,MAAM,CAACqB,IAAI,CAAGJ,IAAI,CAAGjB,MAAM,CAACsB,MAAQ;;AAExE,GAAI;AACH,IAAI,CAACvD,MAAM,CAAG,GAAI,CAAAwD,MAAM,CAACH,GAAG,CAAE,EAAE,CAAE,CAAEI,OAAO,CAAE,CAAC,CAAG,EAAE,CAAG,IAAK,CAAC,CAAC;AAC9D,CAAE,MAAAC,QAAA,CAAM;AACP,IAAI,CAAC1D,MAAM,CAAG,GAAI,CAAA2D,SAAS,CAACN,GAAG,CAACO,OAAO,CAAC,MAAM,CAAE,IAAI,CAAC,CAAG,YAAY,CAAC;AACtE;;AAEA,GAAM,CAAA5D,MAAM,CAAG,IAAI,CAACA,MAAO;;AAE3BA,MAAM,CAAC6D,MAAM,CAAG,UAAM;AACrBvB,OAAO,CAACC,GAAG,CAAC,oBAAoB,CAAC;AACjCU,MAAI,CAAChD,SAAS,CAAG,IAAI;AACrBoB,EAAE,CAACpB,SAAS,CAAG,IAAI;AACnBgD,MAAI,CAAC9C,cAAc,CAAG,IAAI;AAC1B8C,MAAI,CAAC/C,KAAK,CAACsC,OAAO,CAAC,SAAAC,GAAG,QAAI,CAAAzC,MAAM,CAAC4B,IAAI,CAACa,GAAG,CAAC,GAAC;AAC3CQ,MAAI,CAAC/C,KAAK,CAAG,EAAE;AACfmB,EAAE,CAACqB,MAAM,CAAC,CAAC;AACZ,CAAC;;AAED1C,MAAM,CAACkC,SAAS,CAAG,SAAC4B,EAAgB,CAAK;AACxCzC,EAAE,CAACsB,OAAO,CAAC,EAAE,CAAGmB,EAAE,CAACzB,IAAI,CAAC;AACzB,CAAC;;AAEDrC,MAAM,CAAC+D,OAAO,CAAG,UAAM;AACtBzB,OAAO,CAACC,GAAG,CAAC,uBAAuB,CAAC;AACpCU,MAAI,CAACL,gBAAgB,CAAC,CAAC;AACvBN,OAAO,CAACC,GAAG,CAAC,uBAAuB,CAAC;AACpCU,MAAI,CAAChD,SAAS,CAAG,KAAK;AACtBoB,EAAE,CAACpB,SAAS,CAAG,KAAK;AACpBoB,EAAE,CAAC2C,SAAS,CAAG,IAAI;AACnB,IAAK,GAAM,CAAAC,MAAM,GAAI,CAAA5C,EAAE,CAAC6C,KAAK,CAAE;AAC9B,GAAM,CAAAvC,IAAI,CAAGN,EAAE,CAAC6C,KAAK,CAACD,MAAM,CAAE;AAC9B,GAAItC,IAAI,CAAC1B,SAAS,GAAK,IAAI,CAAE0B,IAAI,CAAC1B,SAAS,CAAG,eAAe;AAC9D;AACAgD,MAAI,CAACjD,MAAM,CAAG,IAAI;AAClBqB,EAAE,CAACqB,MAAM,CAAC,CAAC;AACZ,CAAC;;AAED1C,MAAM,CAAC8C,OAAO,CAAG,SAACgB,EAAS,CAAK;AAC/BzC,EAAE,CAACpB,SAAS,CAAG,KAAK;AACpBoB,EAAE,CAAC2C,SAAS,CAAG,IAAI;;AAEnB3C,EAAE,CAAC8C,KAAK,mBAAmB,CAAC;AAC5BlB,MAAI,CAACmB,eAAe,CAAC,CAAC;AACtB/C,EAAE,CAACqB,MAAM,CAAC,CAAC;AACZ,CAAC;AACF,CAAC,CAAA7B,MAAA;;AAEO+B,gBAAgB,CAAxB,QAAQ,CAAAA,gBAAgBA,CAAA,CAAG;AAC1B,IAAI,CAAC3C,SAAS,CAAG,KAAK;AACtBoB,EAAE,CAACpB,SAAS,CAAG,KAAK;AACpBoB,EAAE,CAAC2C,SAAS,CAAG,IAAI;AACnB,IAAI,CAAChE,MAAM,CAAG,IAAI;AAClB,IAAK,GAAM,CAAAiE,MAAM,GAAI,CAAA5C,EAAE,CAAC6C,KAAK,CAAE;AAC9B,GAAM,CAAAvC,IAAI,CAAGN,EAAE,CAAC6C,KAAK,CAACD,MAAM,CAAE;AAC9B,GAAItC,IAAI,CAAC1B,SAAS,GAAK,IAAI,CAAE0B,IAAI,CAAC1B,SAAS,CAAG,eAAe;AAC9D;AACA,IAAI,CAACmE,eAAe,CAAC,CAAC;AACtB/C,EAAE,CAACqB,MAAM,CAAC,CAAC;AACZ,CAAC,CAAA7B,MAAA;;AAEOuD,eAAe,CAAvB,QAAQ,CAAAA,eAAeA,CAAA,CAAG,KAAAC,MAAA;AACzB,GAAI,CAAC,IAAI,CAACpD,YAAY,CAAC,CAAC,CAAE;AAC1B,GAAI,IAAI,CAACX,cAAc,CAAE;AACzB,IAAI,CAACA,cAAc,CAAGgE,UAAU,CAAC,UAAM;AACtCD,MAAI,CAAC/D,cAAc,CAAG,IAAI;AAC1B,GAAI,CAAC+D,MAAI,CAACpE,SAAS,EAAIoE,MAAI,CAACpD,YAAY,CAAC,CAAC,CAAE;AAC3CI,EAAE,CAACkD,QAAQ,CAAC3C,IAAI,CAAC,YAAY,CAAC;AAC9ByC,MAAI,CAAClE,cAAc,CAAGqE,IAAI,CAACC,GAAG,CAACJ,MAAI,CAAClE,cAAc,CAAG,CAAC,CAAEkE,MAAI,CAACjE,YAAY,CAAC;AAC3E;AACD,CAAC,CAAE,IAAI,CAACD,cAAc,CAAC;AACxB,CAAC,CAAAU,MAAA;;AAED6D,UAAU,CAAV,SAAAA,UAAUA,CAAA,CAAG,KAAAC,YAAA,CAAAC,YAAA;AACZ,IAAI,CAACvE,eAAe,CAAG,KAAK;AAC5B,CAAAsE,YAAA,KAAI,CAAC3E,MAAM,SAAX2E,YAAA,CAAaE,KAAK,CAAC,CAAC;AACpB,CAAAD,YAAA,KAAI,CAACrE,MAAM,SAAXqE,YAAA,CAAaE,SAAS,CAAC,CAAC;AACxB,IAAI,CAACvE,MAAM,CAAG,IAAI;AAClBc,EAAE,CAAC0D,UAAU,CAAG,IAAI;AACpB1D,EAAE,CAACpB,SAAS,CAAG,KAAK;AACpBoB,EAAE,CAAC2C,SAAS,CAAG,IAAI;AACpB,CAAC,CAAAnD,MAAA;;AAEDmE,aAAa,CAAb,SAAAA,aAAaA,CAAA,CAAG,KAAAC,aAAA,CAAAC,aAAA;AACf,CAAAD,aAAA,KAAI,CAACjF,MAAM,SAAXiF,aAAA,CAAaJ,KAAK,CAAC,CAAC;AACpB,CAAAK,aAAA,KAAI,CAAC3E,MAAM,SAAX2E,aAAA,CAAanD,WAAW,CAAC,CAAEC,IAAI,CAAE,YAAa,CAAC,CAAC;AAChD,IAAI,CAACzB,MAAM,CAAG,IAAI;AAClBc,EAAE,CAACpB,SAAS,CAAG,KAAK;AACpBoB,EAAE,CAAC2C,SAAS,CAAG,IAAI;AACpB,CAAC,CAAAnD,MAAA;;AAEDe,IAAI,CAAJ,SAAAA,IAAIA,CAACa,GAAW,CAAE;AACjB,GAAI,CAAC,IAAI,CAACxC,SAAS,CAAE;AACpB,IAAI,CAACC,KAAK,CAACiF,IAAI,CAAC1C,GAAG,CAAC;AACpB;AACD;AACA,GAAI,IAAI,CAAClC,MAAM,CAAE;AAChB,IAAI,CAACA,MAAM,CAACwB,WAAW,CAAC,CAAEC,IAAI,CAAE,MAAM,CAAEK,IAAI,CAAEI,GAAI,CAAC,CAAC;AACrD,CAAC,IAAM,IAAI,IAAI,CAACzC,MAAM,CAAE;AACvB,IAAI,CAACA,MAAM,CAAC4B,IAAI,CAACa,GAAG,CAAC;AACtB;AACD,CAAC,CAAA3C,YAAA;;AAEMsF,OAAO,CAAd,QAAO,CAAAA,OAAOA,CAAA,CAAG,KAAAC,cAAA;AAChB,IAAAA,cAAA,CAAIhE,EAAE,CAAC0D,UAAU,SAAbM,cAAA,CAAerF,MAAM,CAAE;AAC3BqB,EAAE,CAAC2C,SAAS,CAAG,KAAK;AACpB,GAAI,CAAC3C,EAAE,CAAC0D,UAAU,CAAE;AACnB1D,EAAE,CAAC0D,UAAU,CAAG,GAAI,CAAAjF,YAAY,CAAC,CAAC;AACnC,CAAC,IAAM;AACNuB,EAAE,CAAC0D,UAAU,CAAC/D,aAAa,CAAC,CAAC;AAC9B;AACAK,EAAE,CAACiE,KAAK,CAACC,UAAU,CAAC,CAAC;AACtB,CAAC,QAAAzF,YAAA;;;AAGWW,SAAS,qBAAAA,UAAA,GAAAA,SAAA;;;;;;;AAOdC,IAAI,CAAX,QAAO,CAAAA,IAAIA,CAAA,CAAyB,KAAA8E,MAAA;AACnC,GAAI,IAAI,CAACC,MAAM,CAAE;AAChB,GAAI,IAAI,CAACA,MAAM,GAAK,IAAI,CAAE;AAC1B,MAAO,KAAI,CAACA,MAAM;AACnB;AACA,GAAIC,MAAM,CAACC,UAAU,CAAE;AACtB;AACD,CAAC,IAAM,IAAOC,QAAQ,CAACzC,QAAQ,MAAKyC,QAAQ,CAACC,QAAQ,GAAOpF,SAAS,CAACqF,MAAM,CAAE,KAAAC,OAAA;;AAE7E,CAAAA,OAAA,CAAAL,MAAM,EAACzD,MAAM,GAAb8D,OAAA,CAAO9D,MAAM,CAAKyD,MAAM,CAACM,aAAa;AACtC;AACD;;;AAGA,GAAI,EAAE,aAAa,EAAI,CAAAC,MAAM,CAAC,CAAE;;AAE/B5E,EAAE,CAAC8C,KAAK,CAAC,0DAA0D,CAAC;AACpE;AACD;;AAEA8B,MAAM,CAACC,gBAAgB,CAAC,SAAS,CAAE,IAAI,CAACC,SAAS,CAAC;;AAElD,GAAIC,QAAQ,CAACR,QAAQ,CAACC,QAAQ,GAAKH,MAAM,CAACW,MAAM,CAACC,MAAM,CAAE;AACxD,GAAM,CAAAC,MAAM,CAAGH,QAAQ,CAACI,aAAa,CAAC,QAAQ,CAAC;AAC/CD,MAAM,CAACE,GAAG,CAAG,UAAU,CAAGf,MAAM,CAACW,MAAM,CAACC,MAAM,CAAG,wBAAwB;AACxEI,kBAAkB,CAACN,QAAQ,CAACR,QAAQ,CAACC,QAAQ,CAAC;AAC9C,QAAQ,CAAGa,kBAAkB,CAACN,QAAQ,CAACR,QAAQ,CAACe,QAAQ,CAACC,MAAM,CAAC,CAAC,CAAC,CAAC;AACnE,YAAY,CAAGF,kBAAkB,CAACN,QAAQ,CAACR,QAAQ,CAACzC,QAAQ,CAAC;AAC9DoD,MAAM,CAACM,KAAK,CAACC,OAAO,CAAG,MAAM;AAC7BV,QAAQ,CAACW,IAAI,CAACC,WAAW,CAACT,MAAM,CAAC;AAClC,CAAC,IAAM,KAAAU,QAAA;AACN,CAAAA,QAAA,CAAAvB,MAAM,EAACzD,MAAM,GAAbgF,QAAA,CAAOhF,MAAM,CAAKyD,MAAM,CAACM,aAAa;AACtCkB,CAAC;AACwBxB,MAAM,CAACW,MAAM,CAACC,MAAM;AAC7C,CAAC,CAACa,QAAQ,CAAC,MAAM,CAAC;AAClB7C,UAAU,CAAC,UAAM;;;;AAIjB,CAAC,CAAE,IAAI,CAAC;AACT;AACA,IAAI,CAACmB,MAAM,CAAG,GAAI,CAAA2B,OAAO,CAAC,SAAAC,OAAO,CAAI;AACpC7B,MAAI,CAAC8B,MAAM,CAAGD,OAAO;AACtB,CAAC,CAAC;AACF,MAAO,KAAI,CAAC5B,MAAM;AACnB,CAAC,CAAAhF,SAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiGM8G,OAAO,CAAd,QAAO,CAAAA,OAAOA,CAACvF,IAAoB,CAAEwF,GAAW,CAAEnF,IAAS,CAA0B;AACpF,GAAI,CAAC5B,SAAS,CAACgH,QAAQ,CAAE;AACzB,GAAM,CAAAC,GAAG,CAAGjH,SAAS,CAACkH,YAAY,EAAE;AACpC,MAAO,IAAI,CAAAP,OAAO,CAAC,SAAAC,OAAO,CAAI;AAC7B5G,SAAS,CAACgH,QAAQ,CAAEC,GAAG,CAAC,CAAGL,OAAO;AAClC5G,SAAS,CAACmH,sBAAsB,CAAC,CAAC5F,IAAI,GAAK,KAAK,CAAG,GAAG,CAAG,GAAG,EAAI6F,IAAI,CAACC,SAAS,CAAC,CAACN,GAAG,CAAEnF,IAAI,CAAEqF,GAAG,CAAE,MAAM,CAAC,CAAC,CAAC;AAC1G,CAAC,CAAC;AACH,CAAC,QAAAjH,SAAA,KAAAsH,UAAA,CA5JWtH,SAAS,CAATA,SAAS,CACduH,KAAK,CAAuB,IAAI,CAD3BvH,SAAS,CAEdgH,QAAQ,CAA+C,IAAI,CAFtDhH,SAAS,CAGdkH,YAAY,CAAG,CAAC,CAHXlH,SAAS,CAILqF,MAAM,YAAcJ,MAAM,CAACW,MAAM,CAACC,MAAM,CAJ5C7F,SAAS,CAKd6G,MAAM,QALD7G,SAAS,CAMdgF,MAAM,CAA4B,KAAK,CANlChF,SAAS,CAsDd0F,SAAS,CAAG,SAACpD,CAAe,CAAK,CACvC,GAAIA,CAAC,CAAC+C,MAAM,GAAKrF,UAAS,CAACqF,MAAM,CAAE,OAEnCiC,UAAA,CAAKC,KAAK,CAAGjF,CAAC,CAACkF,MAAqB,CACpC,GAAM,CAAA5F,IAAI,CAAGU,CAAC,CAACV,IAAI,CAEnB,OAAQA,IAAI,CAAC6F,MAAM,CAAC,CAAC,CAAC,EACtB,IAAK,GAAG,CACPxC,MAAM,CAACzD,MAAM,CAAG4F,IAAI,CAACM,KAAK,CAAC9F,IAAI,CAACuE,MAAM,CAAC,CAAC,CAAC,CAAC,CAC1C,GAAIlB,MAAM,CAACzD,MAAM,CAACmG,UAAU,EAAI1C,MAAM,CAACzD,MAAM,CAACoG,EAAE,GAAK,UAAU,EAAI3C,MAAM,CAACzD,MAAM,CAACoG,EAAE,GAAK,WAAW,CAAE,CACpG,GAAM,CAAAC,IAAI,CAAGlC,QAAQ,CAACI,aAAa,CAAC,MAAM,CAAC,CAC3C8B,IAAI,CAACC,GAAG,CAAG,YAAY,CACvBD,IAAI,CAACE,IAAI,MAAQ9C,MAAM,CAACW,MAAM,CAACC,MAAM,0BAAyBI,kBAAkB,CAAChB,MAAM,CAACzD,MAAM,CAACoG,EAAE,CAAG,CACpGjC,QAAQ,CAACqC,IAAI,CAACzB,WAAW,CAACsB,IAAI,CAAC,CAChC,CACAI,MAAM,CAACC,MAAM,CAACtH,EAAE,CAACY,MAAM,CAAEyD,MAAM,CAACzD,MAAM,CAAC,CACvC,MACD,IAAK,GAAG,CACP,GAAM,CAAA2G,OAAO,CAAGf,IAAI,CAACM,KAAK,CAAC9F,IAAI,CAACuE,MAAM,CAAC,CAAC,CAAC,CAAC,CAC1C,GAAIgC,OAAO,CAAEvH,EAAE,CAACiE,KAAK,CAACuD,IAAI,CAACD,OAAO,CAAE,IAAI,CAAC,CACzCvH,EAAE,CAACiE,KAAK,CAACwD,IAAI,CAAG,UAAY,CAC3B,GAAM,CAAAC,QAAQ,CAAGlB,IAAI,CAACC,SAAS,CAACzG,EAAE,CAACiE,KAAK,CAAC0D,OAAO,CAAC,CACjDvI,UAAS,CAACmH,sBAAsB,CAAC,GAAG,CAAGmB,QAAQ,CAAC,CAIhD,GAAI,CACHE,YAAY,CAACC,OAAO,CAAC,gBAAgB,CAAEH,QAAQ,CAAC,CACjD,CAAE,MAAAI,QAAA,CAAM,CAAC,CACV,CAAC,CACD9H,EAAE,CAACiE,KAAK,CAAC5C,MAAM,CAAC,IAAI,CAAC,CACrB,MACD,IAAK,GAAG,CACP,GAAIuD,MAAM,CAACmD,UAAU,CAAE,OACvB,GAAI,CAAAC,QAAQ,CACZ,GAAIhI,EAAE,CAACiI,KAAK,CAACC,IAAI,CAACC,MAAM,CAAE,CAGzBH,QAAQ,CAAGhI,EAAE,CAACiI,KAAK,CAACC,IAAI,CACzB,CACAlI,EAAE,CAACiI,KAAK,CAACG,SAAS,CAACpH,IAAI,CAACuE,MAAM,CAAC,CAAC,CAAC,CAAC,CAClCvF,EAAE,CAACiI,KAAK,CAACR,IAAI,CAAG,UAAY,CAC3B,GAAM,CAAAY,WAAW,CAAGrI,EAAE,CAACiI,KAAK,CAACK,OAAO,CAACtI,EAAE,CAACiI,KAAK,CAACC,IAAI,CAAC,CACnD9I,UAAS,CAACmH,sBAAsB,CAAC,GAAG,CAAG8B,WAAW,CAAC,CAInD,GAAItD,QAAQ,CAACR,QAAQ,CAACC,QAAQ,GAAKH,MAAM,CAACW,MAAM,CAACC,MAAM,CAAE,CACxD,GAAI,CACH2C,YAAY,CAACC,OAAO,CAAC,sBAAsB,CAAEQ,WAAW,CAAC,CAC1D,CAAE,MAAAE,QAAA,CAAM,CAAC,CACV,CACAvI,EAAE,CAACiI,KAAK,CAAC5G,MAAM,CAAC,MAAM,CAAC,CACxB,CAAC,CACD,GAAI2G,QAAQ,CAAE,CACbhI,EAAE,CAACiI,KAAK,CAACC,IAAI,CAAGlI,EAAE,CAACiI,KAAK,CAACC,IAAI,CAACM,MAAM,CAACR,QAAQ,CAAC,CAC9ChI,EAAE,CAACiI,KAAK,CAACR,IAAI,CAAC,CAAC,CACfG,YAAY,CAACa,UAAU,CAAC,gBAAgB,CAAC,CAC1C,CACA,GAAIzH,IAAI,GAAK,OAAO,EAAI,CAAChB,EAAE,CAACiI,KAAK,CAACC,IAAI,CAACC,MAAM,CAAE,CAC9CnI,EAAE,CAACiI,KAAK,CAACG,SAAS,CAACR,YAAY,CAACc,OAAO,CAAC,sBAAsB,CAAC,CAAC,CACjE,CACA,MACD,IAAK,GAAG,CACP,GAAI1H,IAAI,GAAK,IAAI,CAAE,CAClBhB,EAAE,CAAC8C,KAAK,CAAC,yFAAyF,CAAC,CACpG,CACA,GAAI,CAAC8B,MAAM,CAACmD,UAAU,CAAE,CAKvB,GAAI,CAEH3I,UAAS,CAACuH,KAAK,CAAEjG,WAAW,CAAC,EAAE,CAAEtB,UAAS,CAACqF,MAAM,CAAC,CACnD,CAAE,MAAAkE,QAAA,CAAM,CACP,OACD,CAEAvJ,UAAS,CAACgH,QAAQ,CAAG,CAAC,CAAC,CACxB,CACAhH,UAAS,CAACgF,MAAM,CAAG,IAAI,CACvBhF,UAAS,CAAC6G,MAAM,QAAhB7G,UAAS,CAAC6G,MAAM,CAAG,CAAC,CACpB7G,UAAS,CAAC6G,MAAM,CAAG2C,SAAS,CAC5B,MACD,IAAK,GAAG,CACP,GAAM,CAAAC,OAAO,CAAGrC,IAAI,CAACM,KAAK,CAAC9F,IAAI,CAAC8H,KAAK,CAAC,CAAC,CAAC,CAAC,CACzC,GAAM,CAAAzC,GAAG,CAAGwC,OAAO,CAAC,CAAC,CAAC,CACtB,GAAIzJ,UAAS,CAACgH,QAAQ,CAAEC,GAAG,CAAC,CAAE,CAC7BjH,UAAS,CAACgH,QAAQ,CAAEC,GAAG,CAAC,CAACwC,OAAO,CAAC,CAAC,CAAC,CAAC,CACpC,MAAO,CAAAzJ,UAAS,CAACgH,QAAQ,CAAEC,GAAG,CAAC,CAChC,CACA,MACD,CACD,CAAC,CApJWjH,SAAS;AA6JdmH,sBAAsB,CAAG,SAAUvF,IAAY,CAAE;AACvD,GAAI;;AAEH,MAAO,CAAA5B,UAAS,CAACuH,KAAK,CAAEjG,WAAW,CAACM,IAAI,CAAE5B,UAAS,CAACqF,MAAM,CAAC;AAC5D,CAAE,MAAAsE,QAAA,CAAM;AACR;AACA,MAAO,MAAK;AACb,CAAC;AACD;;AAEDtK,YAAY,CAACsF,OAAO,CAAC,CAAC;;AAEf,GAAM,CAAAiF,aAAa,CAAG,wBAAAC,OAAA,OAAAC,OAAA,CAAAD,MAAA,CAAAxJ,SAAA,CAAAyJ,OAAA;AAC5BC,QAAQ,CAAR,SAAAA,QAAQA,CAACC,GAAW,CAAEpI,IAAc,CAA0B;;;;;;AAM7DA,IAAI,CAACoI,GAAG,CAAGA,GAAG;AACd,GAAI,CAAApH,GAAG,CAAG,KAAK,CAAGhC,EAAE,CAACY,MAAM,CAACoG,EAAE,CAAG,aAAa;AAC9C,GAAIzC,QAAQ,CAACe,QAAQ,CAAC+D,QAAQ,CAAC,OAAO,CAAC,CAAE;AACxCrH,GAAG,CAAG,UAAU,CAAGqC,MAAM,CAACW,MAAM,CAACC,MAAM,CAAGjD,GAAG;AAC7C,GAAI,MAAO,CAAAsH,+BAA+B,GAAK,QAAQ,CAAE;AACxDtI,IAAI,CAACuI,GAAG,CAAGD,+BAA+B,CAAC/G,OAAO,CAAC,MAAM,CAAE,GAAG,CAAC;AAChE;AACD;AACA,MAAO,CAAAnD,SAAS,CAAC8G,OAAO,CAAC,MAAM,CAAElE,GAAG,CAAEhB,IAAI,CAAC,EAAIwI,GAAG,CAACxH,GAAG,CAAC,CAACyH,GAAG,CAAC,CAAEC,MAAM,CAAE,MAAM,CAAEhE,IAAI,CAAE1E,IAAK,CAAC,CAAC,CAAC1B,IAAI;AAC/F,SAAAqK,GAAG,QAAI,CAAAA,GAAG,OAAHA,GAAG,CAAI,IAAI;AACnB,CAAC,SAAM;AACN,iBAAM,KAAI;AACX,CAAC;AACF,CAAC,CAAAT,OAAA;AACDU,KAAK,CAAL,SAAAA,KAAKA,CAACR,GAAW,CAA6D,IAA3D,CAAApI,IAAc,CAAA6I,SAAA,CAAA1B,MAAA,IAAA0B,SAAA,MAAAjB,SAAA,CAAAiB,SAAA,IAAG,CAAC,CAAC;AACrC,MAAO,KAAI,CAACV,QAAQ,CAACC,GAAG,CAAEpI,IAAI,CAAC,CAAC1B,IAAI;AACnC,SAAAqK,GAAG,QAAI,CAAAA,GAAG,CAAGnD,IAAI,CAACM,KAAK,CAAC6C,GAAG,CAACb,KAAK,CAAC,CAAC,CAAC,CAAC,CAAG,IAAI;AAC7C,CAAC,SAAM;AACN,iBAAM,KAAI;AACX,CAAC;AACF,CAAC,QAAAG,MAAA;AACF,CAAC,CAAC;;;;;;;;;;AAUIa,SAAS,UAAAC,MAAA;;;AAGd,SAAAD,UAAYE,OAAe,CAAEC,UAA8B,CAAEvE,IAAY,CAAE,KAAAwE,MAAA;AAC1EA,MAAA,CAAAH,MAAA,CAAAI,IAAA,MAAMH,OAAO,CAAC,OAACE,MAAA,CAHhBD,UAAU,QAAAC,MAAA,CACVxE,IAAI;AAGHwE,MAAA,CAAKE,IAAI,CAAG,WAAW;AACvBF,MAAA,CAAKD,UAAU,CAAGA,UAAU;AAC5BC,MAAA,CAAKxE,IAAI,CAAGA,IAAI;AAChB,GAAI;AACF2E,KAAK,CAASC,iBAAiB,CAAAJ,MAAA,CAAOJ,SAAS,CAAC;AAClD,CAAE,MAAAS,QAAA,CAAM,CAAC,CAAC,OAAAL,MAAA;AACX,CAACM,cAAA,CAAAV,SAAA,CAAAC,MAAA,SAAAD,SAAA,GAAAW,gBAAA,CAXsBJ,KAAK;;AAavBK,UAAU;;AAEf,SAAAA,WAAYvE,GAAW,CAAE,MADzBA,GAAG;AAEF,IAAI,CAACA,GAAG,CAAGA,GAAG;AACf,CAAC,IAAAwE,OAAA,CAAAD,UAAA,CAAAjL,SAAA,CAAAkL,OAAA;;;;;;;;;;AAUDlB,GAAG,CAAH,SAAAA,GAAGA,CAAA,CAAgD,KAAAmB,MAAA,SAA/C,CAAAC,IAAuB,CAAAhB,SAAA,CAAA1B,MAAA,IAAA0B,SAAA,MAAAjB,SAAA,CAAAiB,SAAA,IAAG,CAAC,CAAC;AAC/B,MAAO,IAAI,CAAA9D,OAAO,CAAC,SAACC,OAAO,CAAE8E,MAAM,CAAK;AACvC,GAAM,CAAAC,GAAG,CAAG,GAAI,CAAAC,cAAc,CAAC,CAAC;AAChC,GAAI,CAAA7E,GAAG,CAAGyE,MAAI,CAACzE,GAAG;AAClB,GAAI0E,IAAI,CAACjB,KAAK,CAAE;AACfzD,GAAG,EAAI,CAACA,GAAG,CAAC8E,QAAQ,CAAC,GAAG,CAAC,CAAG,GAAG,CAAG,GAAG,EAAIzB,GAAG,CAAC0B,WAAW,CAACL,IAAI,CAACjB,KAAK,CAAC;AACrE;AACAmB,GAAG,CAACI,IAAI,CAACN,IAAI,CAACnB,MAAM,EAAI,KAAK,CAAEvD,GAAG,CAAC;AACnC4E,GAAG,CAACK,kBAAkB,CAAG,UAAY;AACpC,GAAM,CAAAC,IAAI,CAAG,CAAC;AACd,GAAIN,GAAG,CAACO,UAAU,GAAKD,IAAI,CAAE;AAC5B,GAAIN,GAAG,CAACQ,MAAM,GAAK,GAAG,CAAE;AACvBvF,OAAO,CAAC+E,GAAG,CAACS,YAAY,EAAI,EAAE,CAAC;AAC/B;AACD;AACA,GAAM,CAAAC,GAAG,CAAG,GAAI,CAAA3B,SAAS,CAACiB,GAAG,CAACW,UAAU,EAAI,kBAAkB,CAAEX,GAAG,CAACQ,MAAM,CAAER,GAAG,CAACS,YAAY,CAAC;AAC7FV,MAAM,CAACW,GAAG,CAAC;AACZ;AACD,CAAC;AACD,GAAIZ,IAAI,CAACnF,IAAI,CAAE;AACdqF,GAAG,CAACY,gBAAgB,CAAC,cAAc,CAAE,mCAAmC,CAAC;AACzEZ,GAAG,CAACxK,IAAI,CAACiJ,GAAG,CAAC0B,WAAW,CAACL,IAAI,CAACnF,IAAI,CAAC,CAAC;AACrC,CAAC,IAAM;AACNqF,GAAG,CAACxK,IAAI,CAAC,CAAC;AACX;AACD,CAAC,CAAC;AACH,CAAC,CAAAoK,OAAA;;;;;;;;;;;;;AAaDiB,IAAI,CAAJ,SAAAA,IAAIA,CAAA,CAAyD,IAAxD,CAAAf,IAAuB,CAAAhB,SAAA,CAAA1B,MAAA,IAAA0B,SAAA,MAAAjB,SAAA,CAAAiB,SAAA,IAAG,CAAC,CAAC,IAAE,CAAAnE,IAAwB,CAAAmE,SAAA,CAAA1B,MAAA,GAAA0B,SAAA,IAAAjB,SAAA;AAC1D,GAAI,CAAClD,IAAI,CAAEA,IAAI,CAAGmF,IAAI,CAACnF,IAAI;AAC3B,MAAO,KAAI,CAAC+D,GAAG,CAAApC,MAAA,CAAAC,MAAA;AACXuD,IAAI;AACPnB,MAAM,CAAE,MAAM;AACdhE,IAAI,CAAJA,IAAI;AACJ,CAAC;AACH,CAAC,QAAAgF,UAAA;;;AAGK,QAAS,CAAAlB,GAAGA,CAACrD,GAAW,CAAE;AAChC,GAAIA,GAAG,CAAC0F,UAAU,CAAC,GAAG,CAAC,EAAI,CAAC1F,GAAG,CAAC0F,UAAU,CAAC,IAAI,CAAC,EAAIrC,GAAG,CAACsC,YAAY,CAAE3F,GAAG,CAAGqD,GAAG,CAACsC,YAAY,CAAG3F,GAAG;AAClG,GAAIA,GAAG,CAAC0F,UAAU,CAAC,IAAI,CAAC,EAAI9G,QAAQ,CAACR,QAAQ,CAACzC,QAAQ,GAAK,OAAO,CAAEqE,GAAG,CAAG,QAAQ,CAAGA,GAAG;AACxF,MAAO,IAAI,CAAAuE,UAAU,CAACvE,GAAG,CAAC;AAC3B;;AAEAqD,GAAG,CAACsC,YAAY,CAAG,EAAE;;AAErBtC,GAAG,CAAC0B,WAAW,CAAG,SAAUlK,IAAuB,CAAU;AAC5D,GAAI,MAAO,CAAAA,IAAI,GAAK,QAAQ,CAAE,MAAO,CAAAA,IAAI;AACzC,GAAI,CAAA+K,cAAc,CAAG,EAAE;AACvB,IAAK,GAAM,CAAAC,IAAG,GAAI,CAAAhL,IAAI,CAAE;AACvB,GAAI+K,cAAc,CAAEA,cAAc,EAAI,GAAG;AACzC,GAAI,CAAAE,KAAK,CAAGjL,IAAI,CAACgL,IAAG,CAAC;AACrB,GAAIC,KAAK,GAAK,IAAI,CAAEA,KAAK,CAAG,IAAI;AAChC,GAAIA,KAAK,GAAK,KAAK,EAAIA,KAAK,GAAK,IAAI,EAAIA,KAAK,GAAKrD,SAAS,CAAEqD,KAAK,CAAG,EAAE;AACxEF,cAAc,EAAI1G,kBAAkB,CAAC2G,IAAG,CAAC,CAAG,GAAG,CAAG3G,kBAAkB,CAAC4G,KAAK,CAAC;AAC5E;AACA,MAAO,CAAAF,cAAc;AACtB,CAAC;;AAEDvC,GAAG,CAAC0C,QAAQ,CAAG,SAAUC,IAAqB,CAAwC;;AAErF,GAAM,CAAAC,QAAQ,CAAGD,IAAI,CAACE,gBAAgB,CAAmB,2CAA2C,CAAC;AACrG,GAAM,CAAAC,GAAyC,CAAG,CAAC,CAAC,CAAC,QAAAC,GAAA,GAAAA,GAAA;AAC/BH,QAAQ,CAAAjE,MAAA,CAAAoE,GAAA,GAAE,CAA3B,GAAM,CAAAC,OAAO,CAAIJ,QAAQ,CAAAG,GAAA,CAAZ;AACjB,GAAIC,OAAO,CAAC7L,IAAI,GAAK,UAAU,CAAE;AAChC2L,GAAG,CAACE,OAAO,CAACpC,IAAI,CAAC,CAAGoC,OAAO,CAACC,YAAY,CAAC,OAAO,CAAC;AAChDD,OAAO,CAACE,OAAO,CAAGF,OAAO,CAACP,KAAK,CAAG,EAAE;;AAEpC,CAAC,CAACO,OAAO,CAACE,OACV;;AACF,CAAC,IAAM,IAAIF,OAAO,CAAC7L,IAAI,GAAK,OAAO,EAAI6L,OAAO,CAACE,OAAO,CAAE;AACvDJ,GAAG,CAACE,OAAO,CAACpC,IAAI,CAAC,CAAGoC,OAAO,CAACP,KAAK;AAClC;AACD;AACA,MAAO,CAAAK,GAAG;AACX,CAAC","ignoreList":[]}