{
  "version": 3,
  "sources": ["../../../client/src/client-connection-worker.ts"],
  "sourcesContent": ["declare const SockJS: any;\r\nimport type { ServerInfo } from \"./client-main\";\r\n\r\nlet socket: WebSocket | null = null;\r\nlet serverInfo: ServerInfo;\r\nlet reconnectTimeout: ReturnType<typeof setTimeout> | null = null;\r\nlet queue: string[] = [];\r\n\r\nself.onmessage = (event: MessageEvent) => {\r\n\tconst { type, server, data } = event.data;\r\n\tif (type === 'connect') {\r\n\t\tserverInfo = server;\r\n\t\tconnectToServer();\r\n\t} else if (type === 'send') {\r\n\t\tif (socket && socket.readyState === WebSocket.OPEN) {\r\n\t\t\tsocket.send(data);\r\n\t\t} else {\r\n\t\t\tqueue.push(data);\r\n\t\t}\r\n\t} else if (type === 'disconnect') {\r\n\t\tif (socket) socket.close();\r\n\t\tif (reconnectTimeout) clearTimeout(reconnectTimeout);\r\n\t\tsocket = null;\r\n\t}\r\n};\r\n\r\nfunction connectToServer() {\r\n\tif (!serverInfo) return;\r\n\r\n\tconst port = serverInfo.protocol === 'https' ? '' : `:${serverInfo.port}`;\r\n\tconst url = `${serverInfo.protocol}://${serverInfo.host}${port}${serverInfo.prefix}`;\r\n\r\n\ttry {\r\n\t\tsocket = new SockJS(url, [], { timeout: 5 * 60 * 1000 });\r\n\t} catch {\r\n\t\tsocket = new WebSocket(url.replace('http', 'ws') + '/websocket');\r\n\t}\r\n\tif (socket) {\r\n\t\tsocket.onopen = () => {\r\n\t\t\tpostMessage({ type: 'connected' });\r\n\t\t\tfor (const msg of queue) socket?.send(msg);\r\n\t\t\tqueue = [];\r\n\t\t};\r\n\r\n\t\tsocket.onmessage = (e: MessageEvent) => {\r\n\t\t\tpostMessage({ type: 'message', data: e.data });\r\n\t\t};\r\n\r\n\t\tsocket.onclose = () => {\r\n\t\t\tpostMessage({ type: 'disconnected' });\r\n\t\t\t// scheduleReconnect();\r\n\t\t};\r\n\r\n\t\tsocket.onerror = (err: Event) => {\r\n\t\t\tpostMessage({ type: 'error', data: (err as any).message || '' });\r\n\t\t\tsocket?.close();\r\n\t\t};\r\n\t\treturn;\r\n\t}\r\n\treturn postMessage({ type: 'error' });\r\n}\r\n"],
  "mappings": ";AAGA,IAAI,SAA2B;AAC/B,IAAI;AACJ,IAAI,mBAAyD;AAC7D,IAAI,QAAkB,CAAC;AAEvB,KAAK,YAAY,CAAC,UAAwB;AACzC,QAAM,EAAE,MAAM,QAAQ,KAAK,IAAI,MAAM;AACrC,MAAI,SAAS,WAAW;AACvB,iBAAa;AACb,oBAAgB;AAAA,EACjB,WAAW,SAAS,QAAQ;AAC3B,QAAI,UAAU,OAAO,eAAe,UAAU,MAAM;AACnD,aAAO,KAAK,IAAI;AAAA,IACjB,OAAO;AACN,YAAM,KAAK,IAAI;AAAA,IAChB;AAAA,EACD,WAAW,SAAS,cAAc;AACjC,QAAI,OAAQ,QAAO,MAAM;AACzB,QAAI,iBAAkB,cAAa,gBAAgB;AACnD,aAAS;AAAA,EACV;AACD;AAEA,SAAS,kBAAkB;AAC1B,MAAI,CAAC,WAAY;AAEjB,QAAM,OAAO,WAAW,aAAa,UAAU,KAAK,IAAI,WAAW,IAAI;AACvE,QAAM,MAAM,GAAG,WAAW,QAAQ,MAAM,WAAW,IAAI,GAAG,IAAI,GAAG,WAAW,MAAM;AAElF,MAAI;AACH,aAAS,IAAI,OAAO,KAAK,CAAC,GAAG,EAAE,SAAS,IAAI,KAAK,IAAK,CAAC;AAAA,EACxD,QAAQ;AACP,aAAS,IAAI,UAAU,IAAI,QAAQ,QAAQ,IAAI,IAAI,YAAY;AAAA,EAChE;AACA,MAAI,QAAQ;AACX,WAAO,SAAS,MAAM;AACrB,kBAAY,EAAE,MAAM,YAAY,CAAC;AACjC,iBAAW,OAAO,MAAO,SAAQ,KAAK,GAAG;AACzC,cAAQ,CAAC;AAAA,IACV;AAEA,WAAO,YAAY,CAAC,MAAoB;AACvC,kBAAY,EAAE,MAAM,WAAW,MAAM,EAAE,KAAK,CAAC;AAAA,IAC9C;AAEA,WAAO,UAAU,MAAM;AACtB,kBAAY,EAAE,MAAM,eAAe,CAAC;AAAA,IAErC;AAEA,WAAO,UAAU,CAAC,QAAe;AAChC,kBAAY,EAAE,MAAM,SAAS,MAAO,IAAY,WAAW,GAAG,CAAC;AAC/D,cAAQ,MAAM;AAAA,IACf;AACA;AAAA,EACD;AACA,SAAO,YAAY,EAAE,MAAM,QAAQ,CAAC;AACrC;",
  "names": []
}
