{
  "version": 3,
  "sources": ["../../../client/src/client-main.ts"],
  "sourcesContent": ["/**\r\n * Client main\r\n *\r\n * Dependencies: client-core\r\n *\r\n * Sets up the main client models: Prefs, Teams, User, and PS.\r\n *\r\n * @author Guangcong Luo <guancongluo@gmail.com>\r\n * @license AGPLv3\r\n */\r\n\r\nimport { PSConnection, PSLoginServer } from './client-connection';\r\nimport { PSModel, PSStreamModel } from './client-core';\r\nimport type { PSRoomPanel, PSRouter } from './panels';\r\nimport { ChatRoom } from './panel-chat';\r\nimport type { MainMenuRoom } from './panel-mainmenu';\r\nimport { Dex, toID, type ID } from './battle-dex';\r\nimport { BattleTextParser, type Args } from './battle-text-parser';\r\nimport type { BattleRoom } from './panel-battle';\r\nimport { Teams } from './battle-teams';\r\n\r\ndeclare const BattleTextAFD: any;\r\ndeclare const BattleTextNotAFD: any;\r\n\r\n/**********************************************************************\r\n * Config\r\n *********************************************************************/\r\n\r\nexport interface ServerInfo {\r\n\tid: ID;\r\n\tprotocol: string;\r\n\thost: string;\r\n\tport: number;\r\n\thttpport?: number;\r\n\taltport?: number;\r\n\tprefix: string;\r\n\tafd?: boolean;\r\n\tregistered?: boolean;\r\n}\r\nexport interface PSConfig {\r\n\tserver: ServerInfo;\r\n\tdefaultserver: ServerInfo;\r\n\troutes: {\r\n\t\troot: string,\r\n\t\tclient: string,\r\n\t\tdex: string,\r\n\t\treplays: string,\r\n\t\tusers: string,\r\n\t\tteams: string,\r\n\t};\r\n\tcustomcolors: Record<string, string>;\r\n\twhitelist?: string[];\r\n\ttestclient?: boolean;\r\n}\r\nexport declare const Config: PSConfig;\r\n\r\n/**********************************************************************\r\n * Prefs\r\n *********************************************************************/\r\n\r\n/**\r\n * String that contains only lowercase alphanumeric characters.\r\n */\r\nexport type RoomID = Lowercase<string> & { __isRoomID: true };\r\nexport type TimestampOptions = 'minutes' | 'seconds' | undefined;\r\n\r\nconst PSPrefsDefaults: { [key: string]: any } = {};\r\n\r\n/**\r\n * Tracks user preferences, stored in localStorage. Contains most local\r\n * data, with the exception of backgrounds, teams, and session data,\r\n * which get their own models.\r\n *\r\n * Updates will name the key updated, so you don't need to overreact.\r\n */\r\nclass PSPrefs extends PSStreamModel<string | null> {\r\n\t// PREFS START HERE\r\n\r\n\t/**\r\n\t * The theme to use. \"system\" matches the theme of the system accessing the client.\r\n\t */\r\n\ttheme: 'light' | 'dark' | 'system' = 'light';\r\n\t/**\r\n\t * Disables animated GIFs, but keeps other animations enabled.\r\n\t * Workaround for a Chrome 64 bug with GIFs.\r\n\t * true - Disable GIFs, will be automatically re-enabled if you\r\n\t *   switch away from Chrome 64.\r\n\t * false - Enable GIFs all the time.\r\n\t * null - Enable GIFs only on Chrome 64.\r\n\t */\r\n\tnogif: boolean | null = null;\r\n\r\n\t/* Graphics Preferences */\r\n\tnoanim: boolean | null = null;\r\n\tbwgfx: boolean | null = null;\r\n\tnopastgens: boolean | null = null;\r\n\r\n\t/* Chat Preferences */\r\n\tblockPMs: boolean | null = null;\r\n\tblockChallenges: boolean | null = null;\r\n\tinchatpm: boolean | null = null;\r\n\tnoselfhighlight: boolean | null = null;\r\n\ttemporarynotifications: boolean | null = null;\r\n\tleavePopupRoom: boolean | null = null;\r\n\trefreshprompt: boolean | null = null;\r\n\tlanguage = 'english';\r\n\tchatformatting: Record<string, boolean> = {\r\n\t\thidegreentext: false,\r\n\t\thideme: false,\r\n\t\thidespoiler: false,\r\n\t\thidelinks: false,\r\n\t\thideinterstice: true,\r\n\t};\r\n\tnounlink: boolean | null = null;\r\n\r\n\t/* Battle preferences */\r\n\tignorenicks: boolean | null = null;\r\n\tignorespects: boolean | null = null;\r\n\tignoreopp: boolean | null = null;\r\n\tautotimer: boolean | null = null;\r\n\trightpanelbattles: boolean | null = null;\r\n\tdisallowspectators: boolean | null = null;\r\n\tstarredformats: { [formatid: string]: true | undefined } | null = null;\r\n\r\n\t/**\r\n\t * Show \"User joined\" and \"User left\" messages. serverid:roomid\r\n\t * table. Uses 1 and 0 instead of true/false for JSON packing\r\n\t * reasons.\r\n\t */\r\n\tshowjoins: { [serverid: string]: { [roomid: string]: 1 | 0 } } | null = null;\r\n\tshowdebug: boolean | null = null;\r\n\tshowbattles = true;\r\n\t/**\r\n\t * Comma-separated lists of room titles to autojoin. Single\r\n\t * string is for Main.\r\n\t */\r\n\tautojoin: { [serverid: string]: string } | string | null = null;\r\n\t/**\r\n\t * List of users whose messages should be ignored. userid table.\r\n\t * Uses 1 and 0 instead of true/false for JSON packing reasons.\r\n\t */\r\n\tignore: { [userid: string]: 1 | 0 } | null = null;\r\n\t/**\r\n\t * hide = hide regular display, notify = notify on new tours, null = notify on joined tours.\r\n\t */\r\n\ttournaments: 'hide' | 'notify' | null = null;\r\n\t/**\r\n\t * true = one panel, false = two panels, left and right\r\n\t */\r\n\tonepanel: boolean | 'vertical' = false;\r\n\ttimestamps: { chatrooms?: TimestampOptions, pms?: TimestampOptions } = {};\r\n\r\n\tmute = false;\r\n\teffectvolume = 50;\r\n\tmusicvolume = 50;\r\n\tnotifvolume = 50;\r\n\tuploadprivacy = false;\r\n\r\n\tafd: boolean | 'sprites' = false;\r\n\r\n\thighlights: Record<string, string[]> | null = null;\r\n\tlogtimes: Record<string, { [roomid: RoomID]: number }> | null = null;\r\n\r\n\t// PREFS END HERE\r\n\r\n\tstorageEngine: 'localStorage' | 'iframeLocalStorage' | '' = '';\r\n\tstorage: { [k: string]: any } = {};\r\n\treadonly origin = `https://${Config.routes.client}`;\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tfor (const key in this) {\r\n\t\t\tconst value = (this as any)[key];\r\n\t\t\tif (['storage', 'subscriptions', 'origin', 'storageEngine', 'updates'].includes(key)) continue;\r\n\t\t\tif (typeof value === 'function') continue;\r\n\t\t\tPSPrefsDefaults[key] = value;\r\n\t\t}\r\n\r\n\t\t// set up local loading\r\n\t\ttry {\r\n\t\t\tif (window.localStorage) {\r\n\t\t\t\tthis.storageEngine = 'localStorage';\r\n\t\t\t\tthis.load(JSON.parse(localStorage.getItem('showdown_prefs')!) || {}, true);\r\n\t\t\t}\r\n\t\t} catch {}\r\n\t}\r\n\t/**\r\n\t * Change a preference.\r\n\t */\r\n\tset<T extends keyof PSPrefs>(key: T, value: PSPrefs[T] | null) {\r\n\t\tif (value === null) {\r\n\t\t\tdelete this.storage[key];\r\n\t\t\t(this as any)[key] = PSPrefsDefaults[key];\r\n\t\t} else {\r\n\t\t\tthis.storage[key] = value;\r\n\t\t\t(this as any)[key] = value;\r\n\t\t}\r\n\t\tthis.update(key);\r\n\t\tthis.save();\r\n\t}\r\n\r\n\tload(newPrefs: object, noSave?: boolean) {\r\n\t\tthis.fixPrefs(newPrefs);\r\n\t\tObject.assign(this, PSPrefsDefaults);\r\n\t\tthis.storage = newPrefs;\r\n\t\tfor (const key in PSPrefsDefaults) {\r\n\t\t\tif (key in newPrefs) (this as any)[key] = (newPrefs as any)[key];\r\n\t\t}\r\n\t\tthis.setAFD();\r\n\t\tthis.update(null);\r\n\t\tif (!noSave) this.save();\r\n\t}\r\n\tsave() {\r\n\t\tswitch (this.storageEngine) {\r\n\t\tcase 'localStorage':\r\n\t\t\tlocalStorage.setItem('showdown_prefs', JSON.stringify(this.storage));\r\n\t\t}\r\n\t}\r\n\tfixPrefs(newPrefs: any) {\r\n\t\tconst oldShowjoins = newPrefs['showjoins'];\r\n\t\tif (oldShowjoins !== undefined && typeof oldShowjoins !== 'object') {\r\n\t\t\tconst showjoins: { [serverid: string]: { [roomid: string]: 1 | 0 } } = {};\r\n\t\t\tconst serverShowjoins: { [roomid: string]: 1 | 0 } = { global: (oldShowjoins ? 1 : 0) };\r\n\t\t\tconst showroomjoins = newPrefs['showroomjoins'] as { [roomid: string]: boolean };\r\n\t\t\tfor (const roomid in showroomjoins) {\r\n\t\t\t\tserverShowjoins[roomid] = (showroomjoins[roomid] ? 1 : 0);\r\n\t\t\t}\r\n\t\t\tdelete newPrefs['showroomjoins'];\r\n\t\t\tshowjoins[Config.server.id] = serverShowjoins;\r\n\t\t\tnewPrefs['showjoins'] = showjoins;\r\n\t\t}\r\n\r\n\t\tconst isChrome64 = navigator.userAgent.includes(' Chrome/64.');\r\n\t\tif (newPrefs['nogif'] !== undefined) {\r\n\t\t\tif (!isChrome64) {\r\n\t\t\t\tdelete newPrefs['nogif'];\r\n\t\t\t}\r\n\t\t} else if (isChrome64) {\r\n\t\t\tnewPrefs['nogif'] = true;\r\n\t\t\tPS.alert('Your version of Chrome has a bug that makes animated GIFs freeze games sometimes, so certain animations have been disabled. Only some people have the problem, so you can experiment and enable them in the Options menu setting \"Disable GIFs for Chrome 64 bug\".');\r\n\t\t}\r\n\r\n\t\tconst colorSchemeQuerySupported = window.matchMedia?.('(prefers-color-scheme: dark)').media !== 'not all';\r\n\t\tif (newPrefs['theme'] === 'system' && !colorSchemeQuerySupported) {\r\n\t\t\tnewPrefs['theme'] = 'light';\r\n\t\t}\r\n\t\tif (newPrefs['dark'] !== undefined) {\r\n\t\t\tif (newPrefs['dark']) {\r\n\t\t\t\tnewPrefs['theme'] = 'dark';\r\n\t\t\t}\r\n\t\t\tdelete newPrefs['dark'];\r\n\t\t}\r\n\t}\r\n\r\n\tsetAFD(mode?: typeof this['afd']) {\r\n\t\tif (mode === undefined) {\r\n\t\t\t// init\r\n\t\t\tif (typeof BattleTextAFD !== 'undefined') {\r\n\t\t\t\tfor (const id in BattleTextNotAFD) {\r\n\t\t\t\t\tif (!BattleTextAFD[id]) {\r\n\t\t\t\t\t\tBattleTextAFD[id] = BattleTextNotAFD[id];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tBattleTextAFD[id] = { ...BattleTextNotAFD[id], ...BattleTextAFD[id] };\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (Config.server?.afd) {\r\n\t\t\t\tmode = true;\r\n\t\t\t} else if (this.afd !== undefined) {\r\n\t\t\t\tmode = this.afd;\r\n\t\t\t} else {\r\n\t\t\t\t// uncomment on April Fools' Day\r\n\t\t\t\t// mode = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tDex.afdMode = mode;\r\n\r\n\t\tif (typeof BattleTextAFD !== 'undefined') {\r\n\t\t\tif (mode === true) {\r\n\t\t\t\t(BattleText as any) = BattleTextAFD;\r\n\t\t\t} else {\r\n\t\t\t\t(BattleText as any) = BattleTextNotAFD;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tdoAutojoin() {\r\n\t\tlet autojoin = PS.prefs.autojoin;\r\n\t\tif (autojoin) {\r\n\t\t\tif (typeof autojoin === 'string') {\r\n\t\t\t\tautojoin = { showdown: autojoin };\r\n\t\t\t}\r\n\t\t\tlet rooms = autojoin[PS.server.id] || '';\r\n\t\t\tfor (let title of rooms.split(\",\")) {\r\n\t\t\t\tPS.addRoom({ id: toID(title) as string as RoomID, title, connected: true }, true);\r\n\t\t\t};\r\n\t\t\tconst cmd = `/autojoin ${rooms}`;\r\n\t\t\tif (PS.connection?.queue.includes(cmd)) {\r\n\t\t\t\t// don't jam up the queue with autojoin requests\r\n\t\t\t\t// sending autojoin again after a prior autojoin successfully resolves likely returns an error from the server\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// send even if `rooms` is empty, for server autojoins\r\n\t\t\tPS.send(cmd);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**********************************************************************\r\n * Teams\r\n *********************************************************************/\r\n\r\nexport interface Team {\r\n\tname: string;\r\n\tformat: ID;\r\n\tfolder: string;\r\n\t/** note that this can be wrong if .uploaded?.loaded === false */\r\n\tpackedTeam: string;\r\n\t/** The icon cache must be cleared (to `null`) whenever `packedTeam` is modified */\r\n\ticonCache: preact.ComponentChildren;\r\n\tkey: string;\r\n\t/** `uploaded` will only exist if you're logged into the correct account. otherwise teamid is still tracked */\r\n\tisBox: boolean;\r\n\tteamid?: number;\r\n\tuploaded?: {\r\n\t\tteamid: number,\r\n\t\tnotLoaded: boolean | Promise<void>,\r\n\t\t/** password, if private. null = public, undefined = unknown, not loaded yet */\r\n\t\tprivate?: string | null,\r\n\t};\r\n\t/** team at the point it was last uploaded. outside of `uploaded` so it can track loading state */\r\n\tuploadedPackedTeam?: string;\r\n}\r\ninterface UploadedTeam {\r\n\tname: string;\r\n\tteamid: number;\r\n\tformat: ID;\r\n\t/** comma-separated list of species, for generating the icon cache */\r\n\tteam: string;\r\n\t/** password, if private */\r\n\tprivate?: string | null;\r\n}\r\nif (!window.BattleFormats) window.BattleFormats = {};\r\n\r\n/**\r\n * This model tracks teams and formats, updating when either is updated.\r\n */\r\nclass PSTeams extends PSStreamModel<'team' | 'format'> {\r\n\t/** false if it uses the ladder in the website */\r\n\tusesLocalLadder = false;\r\n\tlist: Team[] = [];\r\n\tbyKey: { [key: string]: Team | undefined } = {};\r\n\tdeletedTeams: [Team, number][] = [];\r\n\tuploading: Team | null = null;\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\ttry {\r\n\t\t\tthis.unpackAll(localStorage.getItem('showdown_teams'));\r\n\t\t} catch {}\r\n\t}\r\n\tteambuilderFormat(format: string): ID {\r\n\t\tconst ruleSepIndex = format.indexOf('@@@');\r\n\t\tif (ruleSepIndex >= 0) format = format.slice(0, ruleSepIndex);\r\n\t\tconst formatid = toID(format);\r\n\t\tif (!window.BattleFormats) return formatid;\r\n\t\tconst formatEntry = BattleFormats[formatid];\r\n\t\treturn formatEntry?.teambuilderFormat || formatid;\r\n\t}\r\n\tgetKey(name: string) {\r\n\t\tconst baseKey: string = toID(name) || '0';\r\n\t\tlet key = baseKey;\r\n\t\tlet i = 1;\r\n\t\twhile (key in this.byKey) {\r\n\t\t\ti++;\r\n\t\t\tkey = `${baseKey}-${i}`;\r\n\t\t}\r\n\t\treturn key;\r\n\t}\r\n\tunpackAll(buffer: string | null) {\r\n\t\tif (!buffer) {\r\n\t\t\tthis.list = [];\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (buffer.startsWith('[') && !buffer.trim().includes('\\n')) {\r\n\t\t\tthis.unpackOldBuffer(buffer);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.list = [];\r\n\t\tfor (const line of buffer.split('\\n')) {\r\n\t\t\tconst team = this.unpackLine(line);\r\n\t\t\tif (team) this.push(team);\r\n\t\t}\r\n\t\tthis.update('team');\r\n\t}\r\n\tpush(team: Team) {\r\n\t\tteam.key = this.getKey(team.name);\r\n\t\tthis.list.push(team);\r\n\t\tthis.byKey[team.key] = team;\r\n\t}\r\n\tunshift(team: Team) {\r\n\t\tteam.key = this.getKey(team.name);\r\n\t\tthis.list.unshift(team);\r\n\t\tthis.byKey[team.key] = team;\r\n\t}\r\n\tdelete(team: Team) {\r\n\t\tconst teamIndex = this.list.indexOf(team);\r\n\t\tif (teamIndex < 0) return false;\r\n\t\tthis.deletedTeams.push([team, teamIndex]);\r\n\t\tthis.list.splice(teamIndex, 1);\r\n\t\tdelete this.byKey[team.key];\r\n\t}\r\n\tundelete() {\r\n\t\tif (!this.deletedTeams.length) return;\r\n\t\tconst [team, teamIndex] = this.deletedTeams.pop()!;\r\n\t\tthis.list.splice(teamIndex, 0, team);\r\n\t\tif (this.byKey[team.key]) team.key = this.getKey(team.name);\r\n\t\tthis.byKey[team.key] = team;\r\n\t}\r\n\tunpackOldBuffer(buffer: string) {\r\n\t\tPS.alert(`Your team storage format is too old for PS. You'll need to upgrade it at https://${Config.routes.client}/recoverteams.html`);\r\n\t\tthis.list = [];\r\n\t}\r\n\tpackAll(teams: Team[]) {\r\n\t\treturn teams.map(team => (\r\n\t\t\t(team.teamid ? `${team.teamid}[` : '') +\r\n\t\t\t(team.format || team.isBox ? `${team.format || ''}${team.isBox ? '-box' : ''}]` : ``) +\r\n\t\t\t(team.folder ? `${team.folder}/` : ``) +\r\n\t\t\tteam.name + `|` + team.packedTeam\r\n\t\t)).join('\\n');\r\n\t}\r\n\tsave() {\r\n\t\ttry {\r\n\t\t\tlocalStorage.setItem('showdown_teams', this.packAll(this.list));\r\n\t\t} catch {}\r\n\t\tthis.update('team');\r\n\t}\r\n\tunpackLine(line: string): Team | null {\r\n\t\tconst pipeIndex = line.indexOf('|');\r\n\t\tif (pipeIndex < 0) return null;\r\n\t\tlet bracketIndex = line.indexOf(']');\r\n\t\tif (bracketIndex > pipeIndex) bracketIndex = -1;\r\n\t\tlet leftBracketIndex = line.indexOf('[');\r\n\t\tif (leftBracketIndex < 0) leftBracketIndex = 0;\r\n\t\tconst isBox = line.slice(0, bracketIndex).endsWith('-box');\r\n\t\tlet slashIndex = line.lastIndexOf('/', pipeIndex);\r\n\t\tif (slashIndex < 0) slashIndex = bracketIndex; // line.slice(slashIndex + 1, pipeIndex) will be ''\r\n\t\tlet format = bracketIndex > 0 ? line.slice(\r\n\t\t\t(leftBracketIndex ? leftBracketIndex + 1 : 0), isBox ? bracketIndex - 4 : bracketIndex\r\n\t\t) : 'gen9';\r\n\t\tif (!format.startsWith('gen')) format = 'gen6' + format;\r\n\t\tconst name = line.slice(slashIndex + 1, pipeIndex);\r\n\t\tconst teamid = leftBracketIndex > 0 ? Number(line.slice(0, leftBracketIndex)) : undefined;\r\n\t\treturn {\r\n\t\t\tname,\r\n\t\t\tformat: format as ID,\r\n\t\t\tfolder: line.slice(bracketIndex + 1, slashIndex > 0 ? slashIndex : bracketIndex + 1),\r\n\t\t\tpackedTeam: line.slice(pipeIndex + 1),\r\n\t\t\ticonCache: null,\r\n\t\t\tkey: '',\r\n\t\t\tisBox,\r\n\t\t\tteamid,\r\n\t\t};\r\n\t}\r\n\tloadRemoteTeams() {\r\n\t\tPSLoginServer.query('getteams').then(data => {\r\n\t\t\tif (!data) return;\r\n\t\t\tif (data.actionerror) {\r\n\t\t\t\treturn PS.alert('Error loading uploaded teams: ' + data.actionerror);\r\n\t\t\t}\r\n\t\t\tconst teams: { [key: string]: UploadedTeam } = {};\r\n\t\t\tfor (const team of data.teams) {\r\n\t\t\t\tteams[team.teamid] = team;\r\n\t\t\t}\r\n\r\n\t\t\t// find exact teamid matches\r\n\t\t\tfor (const localTeam of this.list) {\r\n\t\t\t\tif (localTeam.teamid) {\r\n\t\t\t\t\tconst team = teams[localTeam.teamid];\r\n\t\t\t\t\tif (!team) {\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlocalTeam.uploaded = {\r\n\t\t\t\t\t\tteamid: team.teamid,\r\n\t\t\t\t\t\tnotLoaded: false,\r\n\t\t\t\t\t\tprivate: team.private,\r\n\t\t\t\t\t};\r\n\t\t\t\t\tdelete teams[localTeam.teamid];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// do best-guess matches for teams that don't have a local team with matching teamid\r\n\t\t\tfor (const team of Object.values(teams)) {\r\n\t\t\t\tlet matched = false;\r\n\t\t\t\tfor (const localTeam of this.list) {\r\n\t\t\t\t\tif (localTeam.teamid) continue;\r\n\r\n\t\t\t\t\tconst compare = this.compareTeams(team, localTeam);\r\n\t\t\t\t\tif (compare === 'rename') {\r\n\t\t\t\t\t\tif (!localTeam.name.endsWith(' (local version)')) localTeam.name += ' (local version)';\r\n\t\t\t\t\t} else if (compare) {\r\n\t\t\t\t\t\t// prioritize locally saved teams over remote\r\n\t\t\t\t\t\t// as so to not overwrite changes\r\n\t\t\t\t\t\tmatched = true;\r\n\t\t\t\t\t\tlocalTeam.teamid = team.teamid;\r\n\t\t\t\t\t\tlocalTeam.uploaded = {\r\n\t\t\t\t\t\t\tteamid: team.teamid,\r\n\t\t\t\t\t\t\tnotLoaded: false,\r\n\t\t\t\t\t\t\tprivate: team.private,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (!matched) {\r\n\t\t\t\t\tconst mons = team.team.split(',').map((m: string) => ({ species: m, moves: [] }));\r\n\t\t\t\t\tconst newTeam: Team = {\r\n\t\t\t\t\t\tname: team.name,\r\n\t\t\t\t\t\tformat: team.format,\r\n\t\t\t\t\t\tfolder: '',\r\n\t\t\t\t\t\tpackedTeam: Teams.pack(mons),\r\n\t\t\t\t\t\ticonCache: null,\r\n\t\t\t\t\t\tisBox: false,\r\n\t\t\t\t\t\tkey: this.getKey(team.name),\r\n\t\t\t\t\t\tuploaded: {\r\n\t\t\t\t\t\t\tteamid: team.teamid,\r\n\t\t\t\t\t\t\tnotLoaded: true,\r\n\t\t\t\t\t\t\tprivate: team.private,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t};\r\n\t\t\t\t\tthis.push(newTeam);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tloadTeam(team: Team | undefined | null, ifNeeded: true): void | Promise<void>;\r\n\tloadTeam(team: Team | undefined | null): Promise<void>;\r\n\tloadTeam(team: Team | undefined | null, ifNeeded?: boolean): void | Promise<void> {\r\n\t\tif (!team?.uploaded || team.uploadedPackedTeam) return ifNeeded ? undefined : Promise.resolve();\r\n\t\tif (team.uploaded.notLoaded && team.uploaded.notLoaded !== true) return team.uploaded.notLoaded;\r\n\r\n\t\tconst notLoaded = team.uploaded.notLoaded;\r\n\t\treturn (team.uploaded.notLoaded = PSLoginServer.query('getteam', {\r\n\t\t\tteamid: team.uploaded.teamid,\r\n\t\t}).then(data => {\r\n\t\t\tif (!team.uploaded) return;\r\n\t\t\tif (!data?.team) {\r\n\t\t\t\tPS.alert(`Failed to load team: ${data?.actionerror || \"Error unknown. Try again later.\"}`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tteam.uploaded.notLoaded = false;\r\n\t\t\tteam.uploadedPackedTeam = data.team;\r\n\t\t\tif (notLoaded) {\r\n\t\t\t\tteam.packedTeam = data.team;\r\n\t\t\t\tPS.teams.save();\r\n\t\t\t}\r\n\t\t}));\r\n\t}\r\n\tcompareTeams(serverTeam: UploadedTeam, localTeam: Team) {\r\n\t\t// TODO: decide if we want this\r\n\t\t// if (serverTeam.teamid === localTeam.teamid && localTeam.teamid) return true;\r\n\r\n\t\t// if titles match exactly and mons are the same, assume they're the same team\r\n\t\t// if they don't match, it might be edited, but we'll go ahead and add it to the user's\r\n\t\t// teambuilder since they may want that old version around. just go ahead and edit the name\r\n\t\tlet sanitize = (name: string) => (name || \"\").replace(/\\s+\\(server version\\)/g, '').trim();\r\n\t\tconst nameMatches = sanitize(serverTeam.name) === sanitize(localTeam.name);\r\n\t\tif (!(nameMatches && serverTeam.format === localTeam.format)) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// if it's been edited since, invalidate the team id on this one (count it as new)\r\n\t\t// and load from server\r\n\t\tconst mons = serverTeam.team.split(',').map(toID).sort().join(',');\r\n\t\tconst otherMons = Teams.unpackSpeciesOnly(localTeam.packedTeam).map(toID).sort().join(',');\r\n\t\tif (mons !== otherMons) return 'rename';\r\n\t\treturn true;\r\n\t}\r\n}\r\n\r\n/**********************************************************************\r\n * User\r\n *********************************************************************/\r\n\r\nexport type PSLoginState = { error?: string, success?: true, name?: string, needsPassword?: true, needsGoogle?: true };\r\nclass PSUser extends PSStreamModel<PSLoginState | null> {\r\n\tname = \"\";\r\n\tgroup = '';\r\n\tuserid = \"\" as ID;\r\n\tnamed = false;\r\n\tregistered: { name: string, userid: ID } | null = null;\r\n\tavatar = \"lucas\";\r\n\tchallstr = '';\r\n\tloggingIn: string | null = null;\r\n\tinitializing = true;\r\n\tgapiLoaded = false;\r\n\tnameRegExp: RegExp | null = null;\r\n\tsetName(fullName: string, named: boolean, avatar: string) {\r\n\t\tconst loggingIn = (!this.named && named);\r\n\t\tconst { name, group } = BattleTextParser.parseNameParts(fullName);\r\n\t\tthis.name = name;\r\n\t\tthis.group = group;\r\n\t\tthis.userid = toID(name);\r\n\t\tthis.named = named;\r\n\t\tthis.avatar = avatar;\r\n\t\tthis.update(null);\r\n\t\tif (loggingIn) {\r\n\t\t\tfor (const roomid in PS.rooms) {\r\n\t\t\t\tconst room = PS.rooms[roomid]!;\r\n\t\t\t\tif (room.connectWhenLoggedIn) room.connect();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.updateRegExp();\r\n\t}\r\n\tvalidateName(name: string): string {\r\n\t\t// | , ; are not valid characters in names\r\n\t\tname = name.replace(/[|,;]+/g, '');\r\n\t\tconst replaceList = {\r\n\t\t\t'A': '\uFF21\u2C6F\u023A', 'B': '\uFF22\u0182\u0181\u0243', 'C': '\uFF23\uA73E\u023B', 'D': '\uFF24\u0110\u018B\u018A\u0189\uA779', 'E': '\uFF25\u0190\u018E', 'F': '\uFF26\u0191\uA77B', 'G': '\uFF27\uA7A0\uA77D\uA77E', 'H': '\uFF28\u0126\u2C67\u2C75\uA78D', 'I': '\uFF29\u0197', 'J': '\uFF2A\u0248', 'K': '\uFF2B\uA7A2', 'L': '\uFF2C\uA746\uA780', 'M': '\uFF2D\u2C6E\u019C', 'N': '\uFF2E\u0220\u019D\uA790\uA7A4', 'O': '\uFF2F\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C', 'P': '\uFF30\u01A4\u2C63\uA750\uA752\uA754', 'Q': '\uFF31\uA756\uA758\u024A', 'R': '\uFF32\u024C\u2C64\uA75A\uA7A6\uA782', 'S': '\uFF33\u1E9E\uA7A8\uA784', 'T': '\uFF34\u0166\u01AC\u01AE\u023E\uA786', 'U': '\uFF35\u0244', 'V': '\uFF36\u01B2\uA75E\u0245', 'W': '\uFF37\u2C72', 'X': '\uFF38', 'Y': '\uFF39\u024E\u1EFE', 'Z': '\uFF3A\u01B5\u0224\u2C7F\u2C6B\uA762', 'a': '\uFF41\u0105\u2C65\u0250', 'b': '\uFF42\u0180\u0183\u0253', 'c': '\uFF43\u023C\uA73F\u2184', 'd': '\uFF44\u0111\u018C\u0256\u0257\uA77A', 'e': '\uFF45\u0247\u025B\u01DD', 'f': '\uFF46\u1E1F\u0192\uA77C', 'g': '\uFF47\u0260\uA7A1\u1D79\uA77F', 'h': '\uFF48\u0127\u2C68\u2C76\u0265', 'i': '\uFF49\u0268\u0131', 'j': '\uFF4A\u0249', 'k': '\uFF4B\u0199\u2C6A\uA741\uA743\uA745\uA7A3', 'l': '\uFF4C\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747', 'm': '\uFF4D\u0271\u026F', 'n': '\uFF4E\u019E\u0272\u0149\uA791\uA7A5', 'o': '\uFF4F\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275', 'p': '\uFF50\u01A5\u1D7D\uA751\uA753\uA755', 'q': '\uFF51\u024B\uA757\uA759', 'r': '\uFF52\u024D\u027D\uA75B\uA7A7\uA783', 's': '\uFF53\uA7A9\uA785\u1E9B', 't': '\uFF54\u0167\u01AD\u0288\u2C66\uA787', 'u': '\uFF55\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u0173\u1E77\u1E75\u0289', 'v': '\uFF56\u028B\uA75F\u028C', 'w': '\uFF57\u2C73', 'x': '\uFF58', 'y': '\uFF59\u024F\u1EFF', 'z': '\uFF5A\u01B6\u0225\u0240\u2C6C\uA763', 'AA': '\uA732', 'AE': '\u00C6\u01FC\u01E2', 'AO': '\uA734', 'AU': '\uA736', 'AV': '\uA738\uA73A', 'AY': '\uA73C', 'DZ': '\u01F1\u01C4', 'Dz': '\u01F2\u01C5', 'LJ': '\u01C7', 'Lj': '\u01C8', 'NJ': '\u01CA', 'Nj': '\u01CB', 'OI': '\u01A2', 'OO': '\uA74E', 'OU': '\u0222', 'TZ': '\uA728', 'VY': '\uA760', 'aa': '\uA733', 'ae': '\u00E6\u01FD\u01E3', 'ao': '\uA735', 'au': '\uA737', 'av': '\uA739\uA73B', 'ay': '\uA73D', 'dz': '\u01F3\u01C6', 'hv': '\u0195', 'lj': '\u01C9', 'nj': '\u01CC', 'oi': '\u01A3', 'ou': '\u0223', 'oo': '\uA74F', 'ss': '\u00DF', 'tz': '\uA729', 'vy': '\uA761',\r\n\t\t};\r\n\t\tconst normalizeList = {\r\n\t\t\t'A': '\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104', 'B': '\u1E02\u1E04\u1E06', 'C': '\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187', 'D': '\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E', 'E': '\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A', 'F': '\u1E1E', 'G': '\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193', 'H': '\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A', 'I': '\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C', 'J': '\u0134', 'K': '\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744', 'L': '\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748', 'M': '\u1E3E\u1E40\u1E42', 'N': '\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48', 'O': '\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8', 'P': '\u1E54\u1E56', 'Q': '', 'R': '\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E', 'S': '\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E', 'T': '\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E', 'U': '\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74', 'V': '\u1E7C\u1E7E', 'W': '\u1E80\u1E82\u0174\u1E86\u1E84\u1E88', 'X': '\u1E8A\u1E8C', 'Y': '\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3', 'Z': '\u0179\u1E90\u017B\u017D\u1E92\u1E94', 'a': '\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01', 'b': '\u1E03\u1E05\u1E07', 'c': '\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188', 'd': '\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F', 'e': '\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B', 'f': '', 'g': '\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5', 'h': '\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96', 'i': '\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D', 'j': '\u0135\u01F0', 'k': '\u1E31\u01E9\u1E33\u0137\u1E35', 'l': '\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B', 'm': '\u1E3F\u1E41\u1E43', 'n': '\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49', 'o': '\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9', 'p': '\u1E55\u1E57', 'q': '', 'r': '\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F', 's': '\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F', 't': '\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F', 'u': '\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u1EE5\u1E73', 'v': '\u1E7D\u1E7F', 'w': '\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89', 'x': '\u1E8B\u1E8D', 'y': '\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4', 'z': '\u017A\u1E91\u017C\u017E\u1E93\u1E95',\r\n\t\t};\r\n\t\tconst replaceRegexes: [RegExp, string][] = [];\r\n\t\tfor (const i in replaceList) {\r\n\t\t\treplaceRegexes.push([new RegExp('[' + replaceList[i as 'A'] + ']', 'g'), i]);\r\n\t\t}\r\n\t\tconst normalizeRegexes: [RegExp, string][] = [];\r\n\t\tfor (const i in normalizeList) {\r\n\t\t\tnormalizeRegexes.push([new RegExp('[' + normalizeList[i as 'A'] + ']', 'g'), i]);\r\n\t\t}\r\n\r\n\t\tfor (const [regex, replacement] of replaceRegexes) {\r\n\t\t\tname = name.replace(regex, replacement);\r\n\t\t}\r\n\t\tfor (const [regex, replacement] of normalizeRegexes) {\r\n\t\t\tname = name.replace(regex, replacement);\r\n\t\t}\r\n\t\treturn name.trim();\r\n\t}\r\n\tchangeName(name: string) {\r\n\t\tname = this.validateName(name);\r\n\t\tconst userid = toID(name);\r\n\t\tif (!userid) {\r\n\t\t\tthis.updateLogin({ name, error: \"Usernames must contain at least one letter.\" });\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (userid === this.userid) {\r\n\t\t\tPS.send(`/trn ${name}`);\r\n\t\t\tthis.update({ success: true });\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.loggingIn = name;\r\n\t\tthis.update(null);\r\n\t\tPSLoginServer.rawQuery(\r\n\t\t\t'getassertion', { userid, challstr: this.challstr }\r\n\t\t).then(res => {\r\n\t\t\tthis.handleAssertion(name, res);\r\n\t\t\tthis.updateRegExp();\r\n\t\t});\r\n\t}\r\n\tchangeNameWithPassword(name: string, password: string, special: PSLoginState = { needsPassword: true }) {\r\n\t\tthis.loggingIn = name;\r\n\t\tif (!password && !special) {\r\n\t\t\tthis.updateLogin({\r\n\t\t\t\tname,\r\n\t\t\t\terror: \"Password can't be empty.\",\r\n\t\t\t\t...special as any,\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.update(null);\r\n\t\tPSLoginServer.query(\r\n\t\t\t'login', { name, pass: password, challstr: this.challstr }\r\n\t\t).then(data => {\r\n\t\t\tthis.loggingIn = null;\r\n\t\t\tif (data?.curuser?.loggedin) {\r\n\t\t\t\t// success!\r\n\t\t\t\tconst username = data.curuser.loggedin.username;\r\n\t\t\t\tthis.registered = { name: username, userid: toID(username) };\r\n\t\t\t\tthis.handleAssertion(name, data.assertion);\r\n\t\t\t} else {\r\n\t\t\t\t// wrong password\r\n\t\t\t\tif (special.needsGoogle) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\t// @ts-expect-error gapi included dynamically\r\n\t\t\t\t\t\tgapi.auth2.getAuthInstance().signOut();\r\n\t\t\t\t\t} catch {}\r\n\t\t\t\t}\r\n\t\t\t\tthis.updateLogin({\r\n\t\t\t\t\tname,\r\n\t\t\t\t\terror: data?.error || 'Wrong password.',\r\n\t\t\t\t\t...special as any,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tupdateLogin(update: PSLoginState) {\r\n\t\tthis.update(update);\r\n\t\tif (!PS.rooms['login']) {\r\n\t\t\tPS.join('login' as RoomID, { args: update });\r\n\t\t}\r\n\t}\r\n\thandleAssertion(name: string, assertion?: string | null) {\r\n\t\tif (!assertion) {\r\n\t\t\tPS.alert(\"Error logging in.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.loggingIn = null;\r\n\t\tif (assertion.slice(0, 14).toLowerCase() === '<!doctype html') {\r\n\t\t\t// some sort of MitM proxy; ignore it\r\n\t\t\tconst endIndex = assertion.indexOf('>');\r\n\t\t\tif (endIndex > 0) assertion = assertion.slice(endIndex + 1);\r\n\t\t}\r\n\t\tif (assertion.startsWith('\\r')) assertion = assertion.slice(1);\r\n\t\tif (assertion.startsWith('\\n')) assertion = assertion.slice(1);\r\n\t\tif (assertion.includes('<')) {\r\n\t\t\tPS.alert(\"Something is interfering with our connection to the login server. Most likely, your internet provider needs you to re-log-in, or your internet provider is blocking Pok\u00E9mon Showdown.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (assertion === ';') {\r\n\t\t\tthis.updateLogin({ name, needsPassword: true });\r\n\t\t} else if (assertion === ';;@gmail') {\r\n\t\t\tthis.updateLogin({ name, needsGoogle: true });\r\n\t\t} else if (assertion.startsWith(';;')) {\r\n\t\t\tthis.updateLogin({ error: assertion.slice(2) });\r\n\t\t} else if (assertion.includes('\\n') || !assertion) {\r\n\t\t\tPS.alert(\"Something is interfering with our connection to the login server.\");\r\n\t\t} else {\r\n\t\t\tPS.send(`/trn ${name},0,${assertion}`);\r\n\t\t\tthis.update({ success: true });\r\n\t\t}\r\n\t}\r\n\tlogOut() {\r\n\t\tPSLoginServer.query(\r\n\t\t\t'logout', { userid: this.userid }\r\n\t\t);\r\n\t\tPS.send(`/logout`);\r\n\t\tPS.connection?.disconnect();\r\n\r\n\t\tPS.alert(\"You have been logged out and disconnected.\\n\\nIf you wanted to change your name while staying connected, use the 'Change Name' button or the '/nick' command.\");\r\n\t\tthis.name = \"\";\r\n\t\tthis.group = '';\r\n\t\tthis.userid = \"\" as ID;\r\n\t\tthis.named = false;\r\n\t\tthis.registered = null;\r\n\t\tthis.update(null);\r\n\t}\r\n\r\n\tupdateRegExp() {\r\n\t\tif (!this.named) {\r\n\t\t\tthis.nameRegExp = null;\r\n\t\t} else {\r\n\t\t\tlet escaped = this.name.replace(/[^A-Za-z0-9]+$/, '');\r\n\t\t\t// we'll use `,` as a sentinel character to mean \"any non-alphanumeric char\"\r\n\t\t\t// unicode characters can be replaced with any non-alphanumeric char\r\n\t\t\tfor (let i = escaped.length - 1; i > 0; i--) {\r\n\t\t\t\tif (/[^ -~]/.test(escaped[i])) {\r\n\t\t\t\t\tescaped = escaped.slice(0, i) + ',' + escaped.slice(i + 1);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tescaped = escaped.replace(/[[\\]/{}()*+?.\\\\^$|-]/g, \"\\\\$&\");\r\n\t\t\tescaped = escaped.replace(/,/g, \"[^A-Za-z0-9]?\");\r\n\t\t\tthis.nameRegExp = new RegExp('(?:\\\\b|(?!\\\\w))' + escaped + '(?:\\\\b|\\\\B(?!\\\\w))', 'i');\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**********************************************************************\r\n * Server\r\n *********************************************************************/\r\n\r\ninterface PSGroup {\r\n\tname?: string;\r\n\ttype?: 'leadership' | 'staff' | 'punishment';\r\n\torder: number;\r\n}\r\n\r\nclass PSServer {\r\n\tid = Config.defaultserver.id;\r\n\thost = Config.defaultserver.host;\r\n\tport = Config.defaultserver.port;\r\n\thttpport = Config.defaultserver.httpport;\r\n\taltport = Config.defaultserver.altport;\r\n\tregistered = Config.defaultserver.registered;\r\n\tprefix = '/showdown';\r\n\tprotocol: 'http' | 'https' = Config.defaultserver.httpport ? 'https' : 'http';\r\n\tgroups: { [symbol: string]: PSGroup } = {\r\n\t\t'#': {\r\n\t\t\tname: \"Room Owner (#)\",\r\n\t\t\ttype: 'leadership',\r\n\t\t\torder: 101,\r\n\t\t},\r\n\t\t'~': {\r\n\t\t\tname: \"Administrator (~)\",\r\n\t\t\ttype: 'leadership',\r\n\t\t\torder: 102,\r\n\t\t},\r\n\t\t'&': {\r\n\t\t\tname: \"Administrator (&)\",\r\n\t\t\ttype: 'leadership',\r\n\t\t\torder: 103,\r\n\t\t},\r\n\t\t'\\u2605': {\r\n\t\t\tname: \"Host (\\u2605)\",\r\n\t\t\ttype: 'staff',\r\n\t\t\torder: 104,\r\n\t\t},\r\n\t\t'@': {\r\n\t\t\tname: \"Moderator (@)\",\r\n\t\t\ttype: 'staff',\r\n\t\t\torder: 105,\r\n\t\t},\r\n\t\t'%': {\r\n\t\t\tname: \"Driver (%)\",\r\n\t\t\ttype: 'staff',\r\n\t\t\torder: 106,\r\n\t\t},\r\n\t\t// by default, unrecognized ranks go here, between driver and bot\r\n\t\t'*': {\r\n\t\t\tname: \"Bot (*)\",\r\n\t\t\torder: 109,\r\n\t\t},\r\n\t\t'\\u2606': {\r\n\t\t\tname: \"Player (\\u2606)\",\r\n\t\t\torder: 110,\r\n\t\t},\r\n\t\t'+': {\r\n\t\t\tname: \"Voice (+)\",\r\n\t\t\torder: 200,\r\n\t\t},\r\n\t\t' ': {\r\n\t\t\torder: 201,\r\n\t\t},\r\n\t\t'!': {\r\n\t\t\tname: \"Muted (!)\",\r\n\t\t\ttype: 'punishment',\r\n\t\t\torder: 301,\r\n\t\t},\r\n\t\t'\u2716': {\r\n\t\t\tname: \"Namelocked (\\u2716)\",\r\n\t\t\ttype: 'punishment',\r\n\t\t\torder: 302,\r\n\t\t},\r\n\t\t'\\u203d': {\r\n\t\t\tname: \"Locked (\\u203d)\",\r\n\t\t\ttype: 'punishment',\r\n\t\t\torder: 303,\r\n\t\t},\r\n\t};\r\n\tdefaultGroup: PSGroup = {\r\n\t\torder: 108,\r\n\t};\r\n\tgetGroup(symbol: string | undefined) {\r\n\t\treturn this.groups[(symbol || ' ').charAt(0)] || this.defaultGroup;\r\n\t}\r\n}\r\n\r\n/**********************************************************************\r\n * Rooms\r\n *********************************************************************/\r\n\r\ntype PSRoomLocation = 'left' | 'right' | 'popup' | 'mini-window' | 'modal-popup' | 'semimodal-popup';\r\n\r\nexport interface RoomOptions {\r\n\tid: RoomID;\r\n\ttitle?: string;\r\n\t/** @see {PS.roomTypes} */\r\n\ttype?: string;\r\n\tlocation?: PSRoomLocation | null;\r\n\t/**\r\n\t * In case the room received messages before it was ready for them.\r\n\t */\r\n\tbacklog?: Args[] | null;\r\n\t/**\r\n\t * Popup parent element. If it exists, a popup shows up right above/below that element.\r\n\t *\r\n\t * No effect on non-popup panels.\r\n\t */\r\n\tparentElem?: HTMLElement | null;\r\n\t/**\r\n\t * Popup's parent room. Inferred from `parentElem`. Closes any popup that isn't this popup.\r\n\t *\r\n\t * No effect on non-popup panels.\r\n\t */\r\n\tparentRoomid?: RoomID | null;\r\n\t/** Opens the popup to the right of its parent, instead of the default above/below (for userlists) */\r\n\trightPopup?: boolean;\r\n\tconnected?: 'autoreconnect' | 'client-only' | 'expired' | boolean;\r\n\t/** @see {PSRoomPanelSubclass#noURL} */\r\n\tnoURL?: boolean;\r\n\targs?: Record<string, unknown> | null;\r\n}\r\n\r\ninterface PSNotificationState {\r\n\ttitle: string;\r\n\tbody?: string;\r\n\t/** Used to identify notifications to be dismissed - '' if you only want to autodismiss */\r\n\tid: string;\r\n\t/** normally: automatically dismiss the notification when viewing the room; set this to require manual dismissing */\r\n\tnoAutoDismiss: boolean;\r\n\tnotification?: Notification | null;\r\n}\r\n\r\ntype ClientCommands<RoomT extends PSRoom> = {\r\n\t/** return true to send the original command on to the server, or a string to send that command */\r\n\t[command: Lowercase<string>]: (\r\n\t\tthis: RoomT, target: string, cmd: string, element: HTMLElement | null\r\n\t) => string | boolean | null | void,\r\n};\r\n/** The command signature is a lie but TypeScript and string validation amirite? */\r\ntype ParsedClientCommands = {\r\n\t[command: `parsed${string}`]: (\r\n\t\tthis: PSRoom, target: string, cmd: string, element: HTMLElement | null\r\n\t) => string | boolean | null | void,\r\n};\r\n\r\nexport function makeLoadTracker() {\r\n\tlet resolver: () => void;\r\n\tconst tracker: Promise<void> & { loaded: () => void } = new Promise<void>(resolve => {\r\n\t\tresolver = resolve;\r\n\t}) as any;\r\n\ttracker.loaded = () => {\r\n\t\tresolver();\r\n\t};\r\n\treturn tracker;\r\n}\r\n\r\n/**\r\n * As a PSStreamModel, PSRoom can emit `Args` to mean \"we received a message\",\r\n * and `null` to mean \"tell Preact to re-render this room\"\r\n */\r\nexport class PSRoom extends PSStreamModel<Args | null> implements RoomOptions {\r\n\tid: RoomID;\r\n\ttitle = \"\";\r\n\ttype = '';\r\n\tisPlaceholder = false;\r\n\treadonly classType: string = '';\r\n\tlocation: PSRoomLocation = 'left';\r\n\tclosable = true;\r\n\t/**\r\n\t * Whether the room is connected to the server. This is _eager_,\r\n\t * we set it to `true` when we send `/join`, not when the server\r\n\t * tells us we're connected. That's because it tracks whether we\r\n\t * still need to send `/join` or `/leave`.\r\n\t *\r\n\t * Only connected to server when `=== true`. String options mean\r\n\t * the room isn't connected to the game server but to something\r\n\t * else.\r\n\t *\r\n\t * `true` for DMs for historical reasons (TODO: fix)\r\n\t */\r\n\tconnected: 'autoreconnect' | 'client-only' | 'expired' | boolean = false;\r\n\t/**\r\n\t * Can this room even be connected to at all?\r\n\t * `true` = pass messages from the server to subscribers\r\n\t * `false` = throw an error if we receive messages from the server\r\n\t */\r\n\treadonly canConnect: boolean = false;\r\n\tconnectWhenLoggedIn = false;\r\n\tonParentEvent: ((eventId: 'focus' | 'keydown', e?: Event) => false | void) | null = null;\r\n\r\n\twidth = 0;\r\n\theight = 0;\r\n\t/**\r\n\t * Preact means that the DOM state lags behind the app state. This means\r\n\t * rooms frequently have `display: none` at the time we want to focus them.\r\n\t * And popups sometimes initialize hidden, to calculate their position from\r\n\t * their width/height without flickering. But hidden HTML elements can't be\r\n\t * focused, so this is a note-to-self to focus the next time they can be.\r\n\t */\r\n\tfocusNextUpdate = false;\r\n\tparentElem: HTMLElement | null = null;\r\n\tparentRoomid: RoomID | null = null;\r\n\trightPopup = false;\r\n\r\n\tnotifications: PSNotificationState[] = [];\r\n\tisSubtleNotifying = false;\r\n\r\n\t/** only affects mini-windows */\r\n\tminimized = false;\r\n\tcaughtError: string | undefined;\r\n\t/** @see {PSRoomPanelSubclass#noURL} */\r\n\tnoURL: boolean;\r\n\targs: Record<string, unknown> | null;\r\n\r\n\tconstructor(options: RoomOptions) {\r\n\t\tsuper();\r\n\t\tthis.id = options.id;\r\n\t\tthis.title = options.title || this.title || this.id;\r\n\t\tif (options.type) this.type = options.type;\r\n\t\tif (options.location) this.location = options.location;\r\n\t\tif (options.parentElem) this.parentElem = options.parentElem;\r\n\t\tif (options.parentRoomid) this.parentRoomid = options.parentRoomid;\r\n\t\tif (this.location !== 'popup' && this.location !== 'semimodal-popup') this.parentElem = null;\r\n\t\tif (options.rightPopup) this.rightPopup = true;\r\n\t\tif (options.connected) this.connected = options.connected;\r\n\t\tif (options.backlog) this.backlog = options.backlog;\r\n\t\tthis.noURL = options.noURL || false;\r\n\t\tthis.args = options.args || null;\r\n\t}\r\n\tgetParent() {\r\n\t\tif (this.parentRoomid) return PS.rooms[this.parentRoomid] || null;\r\n\t\treturn null;\r\n\t}\r\n\tnotify(options: { title: string, body?: string, noAutoDismiss?: boolean, id?: string }) {\r\n\t\tlet desktopNotification: Notification | null = null;\r\n\t\tconst roomIsFocused = document.hasFocus?.() && PS.isVisible(this);\r\n\t\tif (roomIsFocused && !options.noAutoDismiss) return;\r\n\t\tif (!roomIsFocused) {\r\n\t\t\tPS.playNotificationSound();\r\n\t\t\ttry {\r\n\t\t\t\tdesktopNotification = new Notification(options.title, { body: options.body });\r\n\t\t\t\tif (desktopNotification) {\r\n\t\t\t\t\tdesktopNotification.onclick = () => {\r\n\t\t\t\t\t\twindow.focus();\r\n\t\t\t\t\t\tPS.focusRoom(this.id);\r\n\t\t\t\t\t};\r\n\t\t\t\t\tif (PS.prefs.temporarynotifications) {\r\n\t\t\t\t\t\tsetTimeout(() => { desktopNotification?.close(); }, 5000);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} catch {}\r\n\t\t}\r\n\t\tif (options.noAutoDismiss && !options.id) {\r\n\t\t\tthrow new Error(`Must specify id for manual dismissing`);\r\n\t\t}\r\n\t\tif (options.id) {\r\n\t\t\tthis.notifications = this.notifications.filter(notification => notification.id !== options.id);\r\n\t\t}\r\n\t\tthis.notifications.push({\r\n\t\t\ttitle: options.title,\r\n\t\t\tbody: options.body,\r\n\t\t\tid: options.id || '',\r\n\t\t\tnoAutoDismiss: options.noAutoDismiss || false,\r\n\t\t\tnotification: desktopNotification,\r\n\t\t});\r\n\t\tPS.update();\r\n\t}\r\n\tsubtleNotify() {\r\n\t\tif (PS.isVisible(this)) return;\r\n\t\tthis.isSubtleNotifying = true;\r\n\t\tPS.update();\r\n\t}\r\n\tdismissNotification(id: string) {\r\n\t\tconst index = this.notifications.findIndex(n => n.id === id);\r\n\t\tif (index !== -1) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.notifications[index].notification?.close();\r\n\t\t\t} catch {}\r\n\t\t\tthis.notifications.splice(index, 1);\r\n\t\t}\r\n\t\tPS.update();\r\n\t}\r\n\tautoDismissNotifications() {\r\n\t\tlet room = PS.rooms[this.id] as ChatRoom;\r\n\t\tif (room.lastMessageTime) {\r\n\t\t\t// Mark chat messages as read to avoid double-notifying on reload\r\n\t\t\tlet lastMessageDates = PS.prefs.logtimes || {};\r\n\t\t\tif (!lastMessageDates[PS.server.id]) lastMessageDates[PS.server.id] = {};\r\n\t\t\tlastMessageDates[PS.server.id][room.id] = room.lastMessageTime || 0;\r\n\t\t\tPS.prefs.set('logtimes', lastMessageDates);\r\n\t\t}\r\n\t\tthis.notifications = this.notifications.filter(notification => notification.noAutoDismiss);\r\n\t\tthis.isSubtleNotifying = false;\r\n\t}\r\n\tconnect(): void {\r\n\t\tthrow new Error(`This room is not designed to connect to a server room`);\r\n\t}\r\n\t/**\r\n\t * By default, a reconnected room will receive the init message as a bunch\r\n\t * of `receiveLine`s as normal. Before that happens, handleReconnect is\r\n\t * called, and you can return true to stop that behavior. You could also\r\n\t * prep for a bunch of `receiveLine`s and then not return anything.\r\n\t */\r\n\thandleReconnect(msg: string): boolean | void {}\r\n\treceiveLine(args: Args): void {\r\n\t\tswitch (args[0]) {\r\n\t\tcase 'title': {\r\n\t\t\tthis.title = args[1];\r\n\t\t\tPS.update();\r\n\t\t\tbreak;\r\n\t\t} case 'tempnotify': {\r\n\t\t\tconst [, id, title, body, toHighlight] = args;\r\n\t\t\tthis.notify({ title, body, id });\r\n\t\t\tbreak;\r\n\t\t} case 'tempnotifyoff': {\r\n\t\t\tconst [, id] = args;\r\n\t\t\tthis.dismissNotification(id);\r\n\t\t\tbreak;\r\n\t\t} default: {\r\n\t\t\tif (this.canConnect) {\r\n\t\t\t\tthis.update(args);\r\n\t\t\t} else {\r\n\t\t\t\tthrow new Error(`This room is not designed to receive messages`);\r\n\t\t\t}\r\n\t\t}\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * Used only by commands; messages from the server go directly from\r\n\t * `PS.receive` to `room.receiveLine`\r\n\t */\r\n\tadd(line: string, ifChat?: boolean) {\r\n\t\tif (this.type !== 'chat' && this.type !== 'battle') {\r\n\t\t\tif (!ifChat) {\r\n\t\t\t\tPS.mainmenu.handlePM(PS.user.userid, PS.user.userid);\r\n\t\t\t\tPS.rooms['dm-' as RoomID]?.receiveLine(BattleTextParser.parseLine(line));\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.receiveLine(BattleTextParser.parseLine(line));\r\n\t\t}\r\n\t}\r\n\terrorReply(message: string, element = this.currentElement) {\r\n\t\tif (element?.tagName === 'BUTTON') {\r\n\t\t\tPS.alert(message, { parentElem: element });\r\n\t\t} else {\r\n\t\t\tthis.add(`|error|${message}`);\r\n\t\t}\r\n\t}\r\n\tparseClientCommands(commands: ClientCommands<this>) {\r\n\t\tconst parsedCommands: ParsedClientCommands = {};\r\n\t\tfor (const cmd in commands) {\r\n\t\t\tconst names = cmd.split(',').map(name => name.trim());\r\n\t\t\tfor (const name of names) {\r\n\t\t\t\tif (name.includes(' ')) throw new Error(`Client command names cannot contain spaces: ${name}`);\r\n\t\t\t\t// good luck convincing TypeScript that these types are compatible\r\n\t\t\t\tparsedCommands[name as 'parsed'] = commands[cmd as 'cmd'] as any;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn parsedCommands;\r\n\t}\r\n\tglobalClientCommands = this.parseClientCommands({\r\n\t\t'j,join'(target, cmd, elem) {\r\n\t\t\ttarget = PS.router.extractRoomID(target) || target;\r\n\t\t\tconst roomid = /[^a-z0-9-]/.test(target) ? toID(target) as any as RoomID : target as RoomID;\r\n\t\t\tPS.join(roomid, { parentElem: elem });\r\n\t\t},\r\n\t\t'part,leave,close'(target, cmd, elem) {\r\n\t\t\tconst roomid = (/[^a-z0-9-]/.test(target) ? toID(target) as any as RoomID : target as RoomID) || this.id;\r\n\t\t\tconst room = PS.rooms[roomid];\r\n\t\t\tconst battle = (room as BattleRoom)?.battle;\r\n\r\n\t\t\tif (room?.type === \"battle\" && !battle.ended && battle.mySide.id === PS.user.userid) {\r\n\t\t\t\tPS.join(\"forfeitbattle\" as RoomID, { parentElem: elem });\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (room?.type === \"chat\" && room.connected === true && PS.prefs.leavePopupRoom && !target) {\r\n\t\t\t\tPS.join(\"confirmleaveroom\" as RoomID, { parentElem: elem });\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tPS.leave(roomid);\r\n\t\t},\r\n\t\t'closeand'(target) {\r\n\t\t\t// we actually do the close last, because a lot of things stop working\r\n\t\t\t// after you delete the room\r\n\t\t\tthis.send(target);\r\n\t\t\tPS.leave(this.id);\r\n\t\t},\r\n\t\t'receivepopup'(target) {\r\n\t\t\tPS.alert(target);\r\n\t\t},\r\n\t\t'inopener,inparent'(target) {\r\n\t\t\t// do this command in the popup opener\r\n\t\t\tlet room = this.getParent();\r\n\t\t\tif (room && PS.isPopup(room)) room = room.getParent();\r\n\t\t\t// will crash if the parent doesn't exist, which is fine\r\n\t\t\troom!.send(target);\r\n\t\t},\r\n\t\t'maximize'(target) {\r\n\t\t\tconst roomid = /[^a-z0-9-]/.test(target) ? toID(target) as any as RoomID : target as RoomID;\r\n\t\t\tconst targetRoom = roomid ? PS.rooms[roomid] : this;\r\n\t\t\tif (!targetRoom) return this.errorReply(`Room '${roomid}' not found.`);\r\n\t\t\tif (PS.isNormalRoom(targetRoom)) {\r\n\t\t\t\tthis.errorReply(`'${roomid}' is already maximized.`);\r\n\t\t\t} else if (!PS.isPopup(targetRoom)) {\r\n\t\t\t\tPS.moveRoom(targetRoom, 'left', false, 0);\r\n\t\t\t\tPS.update();\r\n\t\t\t} else {\r\n\t\t\t\tthis.errorReply(`'${roomid}' is a popup and can't be maximized.`);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'logout'() {\r\n\t\t\tPS.user.logOut();\r\n\t\t},\r\n\t\t'reconnect'() {\r\n\t\t\tif (!PS.isOffline) {\r\n\t\t\t\treturn this.add(`|error|You are already connected.`);\r\n\t\t\t}\r\n\t\t\tconst uptime = Date.now() - PS.startTime;\r\n\t\t\tif (uptime > 24 * 60 * 60 * 1000) {\r\n\t\t\t\tPS.confirm(`It's been over a day since you first connected. Please refresh.`, {\r\n\t\t\t\t\tokButton: 'Refresh',\r\n\t\t\t\t}).then(confirmed => {\r\n\t\t\t\t\tif (confirmed) this.send(`/refresh`);\r\n\t\t\t\t});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tPSConnection.connect();\r\n\t\t},\r\n\t\t'refresh'() {\r\n\t\t\tdocument.location.reload();\r\n\t\t},\r\n\t\t'workoffline'() {\r\n\t\t\tif (PS.isOffline) {\r\n\t\t\t\treturn this.add(`|error|You are already offline.`);\r\n\t\t\t}\r\n\t\t\tPS.connection?.disconnect();\r\n\t\t\tthis.add(`||You are now offline.`);\r\n\t\t},\r\n\t\t'connect'() {\r\n\t\t\tif (this.connected && this.connected !== 'autoreconnect') {\r\n\t\t\t\treturn this.errorReply(`You are already connected.`);\r\n\t\t\t}\r\n\t\t\ttry {\r\n\t\t\t\tthis.connect();\r\n\t\t\t} catch (err: any) {\r\n\t\t\t\tthis.errorReply(err.message);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'cancelsearch'() {\r\n\t\t\tif (PS.mainmenu.cancelSearch()) {\r\n\t\t\t\tthis.add(`||Search cancelled.`, true);\r\n\t\t\t} else {\r\n\t\t\t\tthis.errorReply(`You're not currently searching.`);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'disallowspectators'(target) {\r\n\t\t\tPS.prefs.set('disallowspectators', target !== 'off');\r\n\t\t},\r\n\t\t'star'(target) {\r\n\t\t\tconst id = toID(target);\r\n\t\t\tif (!window.BattleFormats[id] && !/^gen[1-9]$/.test(id)) {\r\n\t\t\t\tthis.errorReply(`Format ${id} does not exist`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tlet starred = PS.prefs.starredformats || {};\r\n\t\t\tstarred[id] = true;\r\n\t\t\tPS.prefs.set('starredformats', starred);\r\n\t\t\tthis.add(`||Added format ${id} to favourites`);\r\n\t\t\tthis.update(null);\r\n\t\t},\r\n\t\t'unstar'(target) {\r\n\t\t\tconst id = toID(target);\r\n\t\t\tif (!window.BattleFormats[id] && !/^gen[1-9]$/.test(id)) {\r\n\t\t\t\tthis.errorReply(`Format ${id} does not exist`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tlet starred = PS.prefs.starredformats || {};\r\n\t\t\tif (!starred[id]) {\r\n\t\t\t\tthis.errorReply(`${id} is not in your favourites!`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tdelete starred[id];\r\n\t\t\tPS.prefs.set('starredformats', starred);\r\n\t\t\tthis.add(`||Removed format ${id} from favourites`);\r\n\t\t\tthis.update(null);\r\n\t\t},\r\n\t\t'nick'(target, cmd, element) {\r\n\t\t\tconst noNameChange = PS.user.userid === toID(target);\r\n\t\t\tif (!noNameChange) PS.join('login' as RoomID, { parentElem: element });\r\n\t\t\tif (target) {\r\n\t\t\t\tPS.user.changeName(target);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'avatar'(target) {\r\n\t\t\ttarget = target.toLowerCase();\r\n\t\t\tif (/[^a-z0-9-]/.test(target)) target = toID(target);\r\n\t\t\tconst avatar = window.BattleAvatarNumbers?.[target] || target;\r\n\t\t\tPS.user.avatar = avatar;\r\n\t\t\tif (this.type !== 'chat' && this.type !== 'battle') {\r\n\t\t\t\tPS.send(`/avatar ${avatar}`);\r\n\t\t\t} else {\r\n\t\t\t\tthis.sendDirect(`/avatar ${avatar}`);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'open,user'(target) {\r\n\t\t\tlet roomid = `user-${toID(target)}` as RoomID;\r\n\t\t\tPS.join(roomid, {\r\n\t\t\t\targs: { username: target },\r\n\t\t\t});\r\n\t\t},\r\n\t\t'ignore'(target) {\r\n\t\t\tconst ignore = PS.prefs.ignore || {};\r\n\t\t\tif (!target) return true;\r\n\t\t\tif (toID(target) === PS.user.userid) {\r\n\t\t\t\tthis.add(`||You are not able to ignore yourself.`);\r\n\t\t\t} else if (ignore[toID(target)]) {\r\n\t\t\t\tthis.add(`||User '${target}' is already on your ignore list. ` +\r\n\t\t\t\t\t`(Moderator messages will not be ignored.)`);\r\n\t\t\t} else {\r\n\t\t\t\tignore[toID(target)] = 1;\r\n\t\t\t\tthis.add(`||User '${target}' ignored. (Moderator messages will not be ignored.)`);\r\n\t\t\t\tPS.prefs.set(\"ignore\", ignore);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'unignore'(target) {\r\n\t\t\tconst ignore = PS.prefs.ignore || {};\r\n\t\t\tif (!target) return false;\r\n\t\t\tif (!ignore[toID(target)]) {\r\n\t\t\t\tthis.add(`||User '${target}' isn't on your ignore list.`);\r\n\t\t\t} else {\r\n\t\t\t\tignore[toID(target)] = 0;\r\n\t\t\t\tthis.add(`||User '${target}' no longer ignored.`);\r\n\t\t\t\tPS.prefs.set(\"ignore\", ignore);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'clearignore'(target) {\r\n\t\t\tif (toID(target) !== 'confirm') {\r\n\t\t\t\tthis.add(\"||Are you sure you want to clear your ignore list?\");\r\n\t\t\t\tthis.add('|html|If you\\'re sure, use <code>/clearignore confirm</code>');\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\tlet ignoreList = PS.prefs.ignore || {};\r\n\t\t\tif (!Object.keys(ignoreList).length) return this.add(\"You have no ignored users.\");\r\n\t\t\tPS.prefs.set('ignore', null);\r\n\t\t\tthis.add(\"||Your ignore list was cleared.\");\r\n\t\t},\r\n\t\t'ignorelist'(target) {\r\n\t\t\tlet ignoreList = Object.keys(PS.prefs.ignore || {});\r\n\t\t\tif (ignoreList.length === 0) {\r\n\t\t\t\tthis.add('||You are currently not ignoring anyone.');\r\n\t\t\t} else {\r\n\t\t\t\tlet ignoring: string[] = [];\r\n\t\t\t\tfor (const key in PS.prefs.ignore) {\r\n\t\t\t\t\tif (PS.prefs.ignore[key] === 1) ignoring.push(key);\r\n\t\t\t\t}\r\n\t\t\t\tif (!ignoring.length) return this.add('||You are currently not ignoring anyone.');\r\n\t\t\t\tthis.add(`||You are currently ignoring: ${ignoring.join(', ')}`);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'showjoins'(target) {\r\n\t\t\tlet showjoins = PS.prefs.showjoins || {};\r\n\t\t\tlet serverShowjoins = showjoins[PS.server.id] || {};\r\n\t\t\tif (target) {\r\n\t\t\t\tlet room = toID(target);\r\n\t\t\t\tif (serverShowjoins['global']) {\r\n\t\t\t\t\tdelete serverShowjoins[room];\r\n\t\t\t\t} else {\r\n\t\t\t\t\tserverShowjoins[room] = 1;\r\n\t\t\t\t}\r\n\t\t\t\tthis.add(`||Join/leave messages in room ${room}: ALWAYS ON`);\r\n\t\t\t} else {\r\n\t\t\t\tserverShowjoins = { global: 1 };\r\n\t\t\t\tthis.add(`||Join/leave messages: ALWAYS ON`);\r\n\t\t\t}\r\n\t\t\tshowjoins[PS.server.id] = serverShowjoins;\r\n\t\t\tPS.prefs.set(\"showjoins\", showjoins);\r\n\t\t},\r\n\t\t'hidejoins'(target) {\r\n\t\t\tlet showjoins = PS.prefs.showjoins || {};\r\n\t\t\tlet serverShowjoins = showjoins[PS.server.id] || {};\r\n\t\t\tif (target) {\r\n\t\t\t\tlet room = toID(target);\r\n\t\t\t\tif (!serverShowjoins['global']) {\r\n\t\t\t\t\tdelete serverShowjoins[room];\r\n\t\t\t\t} else {\r\n\t\t\t\t\tserverShowjoins[room] = 0;\r\n\t\t\t\t}\r\n\t\t\t\tthis.add(`||Join/leave messages on room ${room}: OFF`);\r\n\t\t\t} else {\r\n\t\t\t\tserverShowjoins = { global: 0 };\r\n\t\t\t\tthis.add(`||Join/leave messages: OFF`);\r\n\t\t\t}\r\n\t\t\tshowjoins[PS.server.id] = serverShowjoins;\r\n\t\t\tPS.prefs.set('showjoins', showjoins);\r\n\t\t},\r\n\t\t'showdebug'() {\r\n\t\t\tPS.prefs.set('showdebug', true);\r\n\t\t\tthis.add('||Debug battle messages: ON');\r\n\t\t\tlet onCSS = '.debug {display: block;}';\r\n\t\t\tlet style = document.querySelector('style[id=debugstyle]');\r\n\t\t\tif (style) {\r\n\t\t\t\tstyle.innerHTML = onCSS;\r\n\t\t\t} else {\r\n\t\t\t\tstyle = document.createElement('style');\r\n\t\t\t\tstyle.id = \"debugstyle\";\r\n\t\t\t\tstyle.innerHTML = onCSS;\r\n\t\t\t\tdocument.querySelector('head')?.append(style);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'hidedebug'() {\r\n\t\t\tPS.prefs.set('showdebug', true);\r\n\t\t\tthis.add('||Debug battle messages: OFF');\r\n\t\t\tlet onCSS = '.debug {display: none;}';\r\n\t\t\tlet style = document.querySelector('style[id=debugstyle]');\r\n\t\t\tif (style) {\r\n\t\t\t\tstyle.innerHTML = onCSS;\r\n\t\t\t} else {\r\n\t\t\t\tstyle = document.createElement('style');\r\n\t\t\t\tstyle.id = \"debugstyle\";\r\n\t\t\t\tstyle.innerHTML = onCSS;\r\n\t\t\t\tdocument.querySelector('head')?.append(style);\r\n\t\t\t}\r\n\t\t},\r\n\t\t'showbattles'() {\r\n\t\t\tPS.prefs.set('showbattles', true);\r\n\t\t\tthis.add('||Battle Messages: ON');\r\n\t\t},\r\n\t\t'hidebattles'() {\r\n\t\t\tPS.prefs.set('showbattles', false);\r\n\t\t\tthis.add('||Battle Messages: HIDDEN');\r\n\t\t},\r\n\t\t'afd'(target) {\r\n\t\t\tif (!target) return this.send('/help afd');\r\n\t\t\tlet mode = toID(target);\r\n\t\t\tif (mode === 'sprites') {\r\n\t\t\t\tPS.prefs.set('afd', 'sprites');\r\n\t\t\t\tPS.prefs.setAFD('sprites');\r\n\t\t\t\tthis.add('||April Fools\\' Day mode set to SPRITES.');\r\n\t\t\t} else if (mode === 'off') {\r\n\t\t\t\tPS.prefs.set('afd', null);\r\n\t\t\t\tPS.prefs.setAFD();\r\n\t\t\t\tthis.add('||April Fools\\' Day mode set to OFF temporarily.');\r\n\t\t\t\tthis.add('||Trying to turn it off permanently? Use /afd never');\r\n\t\t\t} else if (mode === 'default') {\r\n\t\t\t\tPS.prefs.setAFD();\r\n\t\t\t\tPS.prefs.set('afd', null);\r\n\t\t\t\tthis.add('||April Fools\\' Day mode set to DEFAULT (Currently ' + (Dex.afdMode ? 'FULL' : 'OFF') + ').');\r\n\t\t\t} else if (mode === 'full') {\r\n\t\t\t\tPS.prefs.set('afd', true);\r\n\t\t\t\tPS.prefs.setAFD(true);\r\n\t\t\t\tthis.add('||April Fools\\' Day mode set to FULL.');\r\n\t\t\t} else if (target === 'never') {\r\n\t\t\t\tPS.prefs.set('afd', false);\r\n\t\t\t\tPS.prefs.setAFD(false);\r\n\t\t\t\tthis.add('||April Fools\\' Day mode set to NEVER.');\r\n\t\t\t\tif (Config.server?.afd) {\r\n\t\t\t\t\tthis.add('||You\\'re using the AFD URL, which will still override this setting and enable AFD mode on refresh.');\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (target) this.add('||AFD option \"' + target + '\" not recognized');\r\n\t\t\t\tlet curMode = PS.prefs.afd as string | boolean;\r\n\t\t\t\tif (curMode === true) curMode = 'FULL';\r\n\t\t\t\tif (curMode === false) curMode = 'NEVER';\r\n\t\t\t\tif (curMode) curMode = curMode.toUpperCase();\r\n\t\t\t\tif (!curMode) curMode = 'DEFAULT (currently ' + (Dex.afdMode ? 'FULL' : 'OFF') + ')';\r\n\t\t\t\tthis.add('||AFD is currently set to ' + mode);\r\n\t\t\t\tthis.send('/help afd');\r\n\t\t\t}\r\n\t\t\tfor (let roomid in PS.rooms) {\r\n\t\t\t\tlet battle = PS.rooms[roomid] && (PS.rooms[roomid] as BattleRoom).battle;\r\n\t\t\t\tif (!battle) continue;\r\n\t\t\t\tbattle.resetToCurrentTurn();\r\n\t\t\t}\r\n\t\t},\r\n\t\t'clearpms'() {\r\n\t\t\tlet rooms = PS.miniRoomList.filter(roomid => roomid.startsWith('dm-'));\r\n\t\t\tif (!rooms.length) return this.add('||You do not have any PM windows open.');\r\n\t\t\tfor (const roomid of rooms) {\r\n\t\t\t\tPS.leave(roomid);\r\n\t\t\t}\r\n\t\t\tthis.add(\"||All PM windows cleared and closed.\");\r\n\t\t},\r\n\t\t'unpackhidden'() {\r\n\t\t\tPS.prefs.set('nounlink', true);\r\n\t\t\tthis.add('||Locked/banned users\\' chat messages: ON');\r\n\t\t},\r\n\t\t'packhidden'() {\r\n\t\t\tPS.prefs.set('nounlink', false);\r\n\t\t\tthis.add('||Locked/banned users\\' chat messages: HIDDEN');\r\n\t\t},\r\n\t\t'hl,highlight'(target) {\r\n\t\t\tlet highlights = PS.prefs.highlights || {};\r\n\t\t\tif (target.includes(' ')) {\r\n\t\t\t\tlet targets = target.split(' ');\r\n\t\t\t\tlet subCmd = targets[0];\r\n\t\t\t\ttargets = targets.slice(1).join(' ').match(/([^,]+?({\\d*,\\d*})?)+/g) as string[];\r\n\t\t\t\t// trim the targets to be safe\r\n\t\t\t\tfor (let i = 0, len = targets.length; i < len; i++) {\r\n\t\t\t\t\ttargets[i] = targets[i].replace(/\\n/g, '').trim();\r\n\t\t\t\t}\r\n\t\t\t\tswitch (subCmd) {\r\n\t\t\t\tcase 'add': case 'roomadd': {\r\n\t\t\t\t\tlet key = subCmd === 'roomadd' ? (PS.server.id + '#' + this.id) : 'global';\r\n\t\t\t\t\tlet highlightList = highlights[key] || [];\r\n\t\t\t\t\tfor (let i = 0, len = targets.length; i < len; i++) {\r\n\t\t\t\t\t\tif (!targets[i]) continue;\r\n\t\t\t\t\t\tif (/[\\\\^$*+?()|{}[\\]]/.test(targets[i])) {\r\n\t\t\t\t\t\t\t// Catch any errors thrown by newly added regular expressions so they don't break the entire highlight list\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tnew RegExp(targets[i]);\r\n\t\t\t\t\t\t\t} catch (e: any) {\r\n\t\t\t\t\t\t\t\treturn this.add(`|error|${(e.message.substr(0, 28) === 'Invalid regular expression: ' ? e.message : 'Invalid regular expression: /' + targets[i] + '/: ' + e.message)}`);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (highlightList.includes(targets[i])) {\r\n\t\t\t\t\t\t\treturn this.add(`|error|${targets[i]} is already on your highlights list.`);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\thighlights[key] = highlightList.concat(targets);\r\n\t\t\t\t\tthis.add(`||Now highlighting on ${(key === 'global' ? \"(everywhere): \" : \"(in \" + key + \"): \")} ${highlights[key].join(', ')}`);\r\n\t\t\t\t\t// We update the regex\r\n\t\t\t\t\tChatRoom.updateHighlightRegExp(highlights);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase 'delete': case 'roomdelete': {\r\n\t\t\t\t\tlet key = subCmd === 'roomdelete' ? (PS.server.id + '#' + this.id) : 'global';\r\n\t\t\t\t\tlet highlightList = highlights[key] || [];\r\n\t\t\t\t\tlet newHls: string[] = [];\r\n\t\t\t\t\tfor (let i = 0, len = highlightList.length; i < len; i++) {\r\n\t\t\t\t\t\tif (!targets.includes(highlightList[i])) {\r\n\t\t\t\t\t\t\tnewHls.push(highlightList[i]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\thighlights[key] = newHls;\r\n\t\t\t\t\tthis.add(`||Now highlighting on ${(key === 'global' ? \"(everywhere): \" : \"(in \" + key + \"): \")} ${highlights[key].join(', ')}`);\r\n\t\t\t\t\t// We update the regex\r\n\t\t\t\t\tChatRoom.updateHighlightRegExp(highlights);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tdefault:\r\n\t\t\t\t\t// Wrong command\r\n\t\t\t\t\tthis.errorReply('Invalid /highlight command.');\r\n\t\t\t\t\tthis.handleSend('/help highlight'); // show help\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tPS.prefs.set('highlights', highlights);\r\n\t\t\t} else {\r\n\t\t\t\tif (['clear', 'roomclear', 'clearall'].includes(target)) {\r\n\t\t\t\t\tlet key = (target === 'roomclear' ? (PS.server.id + '#' + this.id) : (target === 'clearall' ? '' : 'global'));\r\n\t\t\t\t\tif (key) {\r\n\t\t\t\t\t\thighlights[key] = [];\r\n\t\t\t\t\t\tthis.add(`||All highlights (${(key === 'global' ? \"everywhere\" : \"in \" + key)}) cleared.`);\r\n\t\t\t\t\t\tChatRoom.updateHighlightRegExp(highlights);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tPS.prefs.set('highlights', null);\r\n\t\t\t\t\t\tthis.add(\"||All highlights (in all rooms and globally) cleared.\");\r\n\t\t\t\t\t\tChatRoom.updateHighlightRegExp({});\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (['show', 'list', 'roomshow', 'roomlist'].includes(target)) {\r\n\t\t\t\t\t// Shows a list of the current highlighting words\r\n\t\t\t\t\tlet key = target.startsWith('room') ? (PS.server.id + '#' + this.id) : 'global';\r\n\t\t\t\t\tif (highlights[key] && highlights[key].length > 0) {\r\n\t\t\t\t\t\tthis.add(`||Current highlight list ${(key === 'global' ? \"(everywhere): \" : \"(in \" + key + \"): \")}${highlights[key].join(\", \")}`);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.add(`||Your highlight list${(key === 'global' ? '' : ' in ' + key)} is empty.`);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Wrong command\r\n\t\t\t\t\tthis.errorReply('Invalid /highlight command.');\r\n\t\t\t\t\tthis.handleSend('/help highlight'); // show help\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t'senddirect'(target) {\r\n\t\t\tthis.sendDirect(target);\r\n\t\t},\r\n\t\t'h,help'(target) {\r\n\t\t\tswitch (toID(target)) {\r\n\t\t\tcase 'chal':\r\n\t\t\tcase 'chall':\r\n\t\t\tcase 'challenge':\r\n\t\t\t\tthis.add('||/challenge - Open a prompt to challenge a user to a battle.');\r\n\t\t\t\tthis.add('||/challenge [user] - Challenge the user [user] to a battle.');\r\n\t\t\t\tthis.add('||/challenge [user], [format] - Challenge the user [user] to a battle in the specified [format].');\r\n\t\t\t\tthis.add('||/challenge [user], [format] @@@ [rules] - Challenge the user [user] to a battle with custom rules.');\r\n\t\t\t\tthis.add('||[rules] can be a comma-separated list of: [added rule], ![removed rule], -[banned thing], *[restricted thing], +[unbanned/unrestricted thing]');\r\n\t\t\t\tthis.add('||/battlerules - Detailed information on what can go in [rules].');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'accept':\r\n\t\t\t\tthis.add('||/accept - Accept a challenge if only one is pending.');\r\n\t\t\t\tthis.add('||/accept [user] - Accept a challenge from the specified user.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'reject':\r\n\t\t\t\tthis.add('||/reject - Reject a challenge if only one is pending.');\r\n\t\t\t\tthis.add('||/reject [user] - Reject a challenge from the specified user.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'user':\r\n\t\t\tcase 'open':\r\n\t\t\t\tthis.add('||/user [user] - Open a popup containing the user [user]\\'s avatar, name, rank, and chatroom list.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'news':\r\n\t\t\t\tthis.add('||/news - Opens a popup containing the news.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'ignore':\r\n\t\t\tcase 'unignore':\r\n\t\t\t\tthis.add('||/ignore [user] - Ignore all messages from the user [user].');\r\n\t\t\t\tthis.add('||/unignore [user] - Remove the user [user] from your ignore list.');\r\n\t\t\t\tthis.add('||/ignorelist - List all the users that you currently ignore.');\r\n\t\t\t\tthis.add('||/clearignore - Remove all users on your ignore list.');\r\n\t\t\t\tthis.add('||Note that staff messages cannot be ignored.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'nick':\r\n\t\t\t\tthis.add('||/nick [new username] - Change your username.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'clear':\r\n\t\t\t\tthis.add('||/clear - Clear the room\\'s chat log.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'showdebug':\r\n\t\t\tcase 'hidedebug':\r\n\t\t\t\tthis.add('||/showdebug - Receive debug messages from battle events.');\r\n\t\t\t\tthis.add('||/hidedebug - Ignore debug messages from battle events.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'showjoins':\r\n\t\t\tcase 'hidejoins':\r\n\t\t\t\tthis.add('||/showjoins [room] - Receive users\\' join/leave messages. Optionally for only specified room.');\r\n\t\t\t\tthis.add('||/hidejoins [room] - Ignore users\\' join/leave messages. Optionally for only specified room.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'showbattles':\r\n\t\t\tcase 'hidebattles':\r\n\t\t\t\tthis.add('||/showbattles - Receive links to new battles in Lobby.');\r\n\t\t\t\tthis.add('||/hidebattles - Ignore links to new battles in Lobby.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'unpackhidden':\r\n\t\t\tcase 'packhidden':\r\n\t\t\t\tthis.add('||/unpackhidden - Suppress hiding locked or banned users\\' chat messages after the fact.');\r\n\t\t\t\tthis.add('||/packhidden - Hide locked or banned users\\' chat messages after the fact.');\r\n\t\t\t\tthis.add('||Hidden messages from a user can be restored by clicking the button underneath their lock/ban reason.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'timestamps':\r\n\t\t\t\tthis.add('||Set your timestamps preference:');\r\n\t\t\t\tthis.add('||/timestamps [all|lobby|pms], [minutes|seconds|off]');\r\n\t\t\t\tthis.add('||all - Change all timestamps preferences, lobby - Change only lobby chat preferences, pms - Change only PM preferences.');\r\n\t\t\t\tthis.add('||off - Set timestamps off, minutes - Show timestamps of the form [hh:mm], seconds - Show timestamps of the form [hh:mm:ss].');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'highlight':\r\n\t\t\tcase 'hl':\r\n\t\t\t\tthis.add('||Set up highlights:');\r\n\t\t\t\tthis.add('||/highlight add [word 1], [word 2], [...] - Add the provided list of words to your highlight list.');\r\n\t\t\t\tthis.add('||/highlight roomadd [word 1], [word 2], [...] - Add the provided list of words to the highlight list of whichever room you used the command in.');\r\n\t\t\t\tthis.add('||/highlight list - List all words that currently highlight you.');\r\n\t\t\t\tthis.add('||/highlight roomlist - List all words that currently highlight you in whichever room you used the command in.');\r\n\t\t\t\tthis.add('||/highlight delete [word 1], [word 2], [...] - Delete the provided list of words from your entire highlight list.');\r\n\t\t\t\tthis.add('||/highlight roomdelete [word 1], [word 2], [...] - Delete the provided list of words from the highlight list of whichever room you used the command in.');\r\n\t\t\t\tthis.add('||/highlight clear - Clear your global highlight list.');\r\n\t\t\t\tthis.add('||/highlight roomclear - Clear the highlight list of whichever room you used the command in.');\r\n\t\t\t\tthis.add('||/highlight clearall - Clear your entire highlight list (all rooms and globally).');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'rank':\r\n\t\t\tcase 'ranking':\r\n\t\t\tcase 'rating':\r\n\t\t\tcase 'ladder':\r\n\t\t\t\tthis.add('||/rating - Get your own rating.');\r\n\t\t\t\tthis.add('||/rating [username] - Get user [username]\\'s rating.');\r\n\t\t\t\treturn;\r\n\t\t\tcase 'afd':\r\n\t\t\t\tthis.add('||/afd full - Enable all April Fools\\' Day jokes.');\r\n\t\t\t\tthis.add('||/afd sprites - Enable April Fools\\' Day sprites.');\r\n\t\t\t\tthis.add('||/afd default - Set April Fools\\' Day to default (full on April 1st, off otherwise).');\r\n\t\t\t\tthis.add('||/afd off - Disable April Fools\\' Day jokes until the next refresh, and set /afd default.');\r\n\t\t\t\tthis.add('||/afd never - Disable April Fools\\' Day jokes permanently.');\r\n\t\t\t\treturn;\r\n\t\t\tdefault:\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t},\r\n\t\t'autojoin,cmd,crq,query'() {\r\n\t\t\tthis.errorReply(`This is a PS system command; do not use it.`);\r\n\t\t},\r\n\t});\r\n\tclientCommands: ParsedClientCommands | null = null;\r\n\tcurrentElement: HTMLElement | null = null;\r\n\t/**\r\n\t * Handles outgoing messages, like `/logout`. Return `true` to prevent\r\n\t * the line from being sent to servers.\r\n\t */\r\n\thandleSend(line: string, element = this.currentElement) {\r\n\t\tif (!line.startsWith('/') || line.startsWith('//')) return line;\r\n\t\tconst spaceIndex = line.indexOf(' ');\r\n\t\tconst cmd = (spaceIndex >= 0 ? line.slice(1, spaceIndex) : line.slice(1)) as 'parsed';\r\n\t\tconst target = spaceIndex >= 0 ? line.slice(spaceIndex + 1).trim() : '';\r\n\r\n\t\tconst cmdHandler = this.globalClientCommands[cmd] || this.clientCommands?.[cmd];\r\n\t\tif (!cmdHandler) return line;\r\n\r\n\t\tconst previousElement = this.currentElement;\r\n\t\tthis.currentElement = element;\r\n\t\tconst cmdResult = cmdHandler.call(this, target, cmd, element);\r\n\t\tthis.currentElement = previousElement;\r\n\t\tif (cmdResult === true) return line;\r\n\t\treturn cmdResult || null;\r\n\t}\r\n\tsend(msg: string | null, element?: HTMLElement) {\r\n\t\tif (!msg) return;\r\n\t\tmsg = this.handleSend(msg, element);\r\n\t\tif (!msg) return;\r\n\t\tthis.sendDirect(msg);\r\n\t}\r\n\tsendDirect(msg: string) {\r\n\t\tPS.send(msg, this.id);\r\n\t}\r\n\tdestroy() {\r\n\t\tif (this.connected === true) {\r\n\t\t\tthis.sendDirect(`/noreply /leave ${this.id}`);\r\n\t\t\tthis.connected = false;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass PlaceholderRoom extends PSRoom {\r\n\toverride readonly classType = 'placeholder';\r\n\tconstructor(options: RoomOptions) {\r\n\t\tsuper(options);\r\n\t\tthis.isPlaceholder = true;\r\n\t}\r\n\toverride receiveLine(args: Args) {\r\n\t\t(this.backlog ||= []).push(args);\r\n\t}\r\n}\r\n\r\n/**********************************************************************\r\n * PS\r\n *********************************************************************/\r\n\r\ntype PSRoomPanelSubclass<T extends PSRoom = PSRoom> = (new () => PSRoomPanel<T>) & {\r\n\treadonly id: string,\r\n\treadonly routes: string[],\r\n\t/** optional Room class */\r\n\treadonly Model?: new (options: RoomOptions) => T,\r\n\treadonly location?: PSRoomLocation,\r\n\t/** do not put the roomid into the URL */\r\n\tnoURL?: boolean,\r\n\ticon?: preact.ComponentChildren,\r\n\ttitle?: string,\r\n};\r\n\r\n/**\r\n * This model updates:\r\n * - when a room is joined or left\r\n * - changing which room is focused\r\n * - changing the width of the left room, in two-panel mode\r\n */\r\nexport const PS = new class extends PSModel {\r\n\tdown: string | boolean = false;\r\n\r\n\tprefs = new PSPrefs();\r\n\tteams = new PSTeams();\r\n\tuser = new PSUser();\r\n\tserver = new PSServer();\r\n\tconnection: PSConnection | null = null;\r\n\tconnected = false;\r\n\t/**\r\n\t * While PS is technically disconnected while it's trying to connect,\r\n\t * it still shows UI like it's connected, so you can click buttons\r\n\t * before the server connection is established.\r\n\t *\r\n\t * `isOffline` is only set if PS is neither connected nor trying to\r\n\t * connect.\r\n\t */\r\n\tisOffline = false;\r\n\treadonly startTime = Date.now();\r\n\r\n\trouter: PSRouter = null!;\r\n\r\n\trooms: { [roomid: string]: PSRoom | undefined } = {};\r\n\troomTypes: {\r\n\t\t[type: string]: PSRoomPanelSubclass | undefined,\r\n\t} = {};\r\n\t/**\r\n\t * If a route starts with `*`, it's a cached room location for the room placeholder.\r\n\t * Otherwise, it's a RoomType ID.\r\n\t *\r\n\t * Routes are filled in by `PS.updateRoomTypes()` and do not need to be manually\r\n\t * filled.\r\n\t */\r\n\troutes: Record<string, string> = Object.assign(Object.create(null), {\r\n\t\t// locations cached here because it needs to be guessed before roomTypes is filled in\r\n\t\t// this cache is optional, but prevents some flickering during loading\r\n\t\t// to update:\r\n\t\t// console.log('\\t\\t' + JSON.stringify(Object.fromEntries(Object.entries(PS.routes).filter(([k, v]) => k !== 'dm-*').map(([k, v]) => [k, '*' + (PS.roomTypes[v].location || '')]))).replaceAll(',', ',\\n\\t\\t').replaceAll('\":\"', '\": \"').slice(1, -1) + ',')\r\n\t\t\"teambuilder\": \"*\",\r\n\t\t\"news\": \"*mini-window\",\r\n\t\t\"\": \"*\",\r\n\t\t\"rooms\": \"*right\",\r\n\t\t\"user-*\": \"*popup\",\r\n\t\t\"viewuser-*\": \"*popup\",\r\n\t\t\"volume\": \"*popup\",\r\n\t\t\"options\": \"*popup\",\r\n\t\t\"*\": \"*right\",\r\n\t\t\"battle-*\": \"*\",\r\n\t\t\"battles\": \"*right\",\r\n\t\t\"teamdropdown\": \"*semimodal-popup\",\r\n\t\t\"formatdropdown\": \"*semimodal-popup\",\r\n\t\t\"team-*\": \"*\",\r\n\t\t\"ladder\": \"*\",\r\n\t\t\"ladder-*\": \"*\",\r\n\t\t\"view-*\": \"*\",\r\n\t\t\"login\": \"*semimodal-popup\",\r\n\t});\r\n\t/** List of rooms on the left side of the top tabbar */\r\n\tleftRoomList: RoomID[] = [];\r\n\t/** List of rooms on the right side of the top tabbar */\r\n\trightRoomList: RoomID[] = [];\r\n\t/** List of mini-rooms in the Main Menu */\r\n\tminiRoomList: RoomID[] = [];\r\n\t/** Currently active popups, in stack order (bottom to top) */\r\n\tpopups: RoomID[] = [];\r\n\r\n\t/**\r\n\t * The currently focused room. Should always be the topmost popup\r\n\t * if it exists. If no popups are open, it should be\r\n\t * `PS.panel`.\r\n\t *\r\n\t * Determines which room receives keyboard shortcuts.\r\n\t *\r\n\t * Clicking inside a panel will focus it, in two-panel mode.\r\n\t */\r\n\troom: PSRoom = null!;\r\n\t/**\r\n\t * The currently active panel. Should always be either `PS.leftPanel`\r\n\t * or `PS.leftPanel`. If no popups are open, should be `PS.room`.\r\n\t *\r\n\t * In one-panel mode, determines whether the left or right panel is\r\n\t * visible. Otherwise, it just tracks which panel will be in focus\r\n\t * after all popups are closed.\r\n\t */\r\n\tpanel: PSRoom = null!;\r\n\t/**\r\n\t * Currently active left room.\r\n\t *\r\n\t * In two-panel mode, this will be the visible left panel.\r\n\t *\r\n\t * In one-panel mode, this is the visible room only if it is\r\n\t * `PS.panel`. Still tracked when not visible, so we know which\r\n\t * panels to display if PS is resized to two-panel mode.\r\n\t */\r\n\tleftPanel: PSRoom = null!;\r\n\t/**\r\n\t * Currently active right room.\r\n\t *\r\n\t * In two-panel mode, this will be the visible right panel.\r\n\t *\r\n\t * In one-panel mode, this is the visible room only if it is\r\n\t * `PS.panel`. Still tracked when not visible, so we know which\r\n\t * panels to display if PS is resized to two-panel mode.\r\n\t */\r\n\trightPanel: PSRoom | null = null;\r\n\t/**\r\n\t * * 0 = only one panel visible\r\n\t * * null = vertical nav layout\r\n\t * n.b. PS will only update if the left room width changes. Resizes\r\n\t * that don't change the left room width will not trigger an update.\r\n\t */\r\n\tleftPanelWidth: number | null = 0;\r\n\tmainmenu: MainMenuRoom = null!;\r\n\r\n\t/**\r\n\t * The drag-and-drop API is incredibly dumb and doesn't let us know\r\n\t * what's being dragged until the `drop` event, so we track it here.\r\n\t *\r\n\t * Note that `PS.dragging` will be null if the drag was initiated\r\n\t * outside PS (e.g. dragging a team from File Explorer to PS), and\r\n\t * for security reasons it's impossible to know what they are until\r\n\t * they're dropped.\r\n\t */\r\n\tdragging: { type: 'room', roomid: RoomID, foreground?: boolean } |\r\n\t\t{ type: 'team', team: Team | number, folder: string | null } |\r\n\t\t{ type: '?' } | // just a note not to try to figure out what type the dragged thing is\r\n\t\tnull = null;\r\n\tlastMessageTime = '';\r\n\r\n\t/** Tracks whether or not to display the \"Use arrow keys\" hint */\r\n\tarrowKeysUsed = false;\r\n\r\n\tnewsHTML = document.querySelector('#room-news .readable-bg')?.innerHTML || '';\r\n\r\n\tlibsLoaded = makeLoadTracker();\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis.mainmenu = this.addRoom({\r\n\t\t\tid: '' as RoomID,\r\n\t\t\ttitle: \"Home\",\r\n\t\t}) as MainMenuRoom;\r\n\r\n\t\tthis.addRoom({\r\n\t\t\tid: 'rooms' as RoomID,\r\n\t\t\ttitle: \"Rooms\",\r\n\t\t}, true);\r\n\t\tthis.rightPanel = this.rooms['rooms']!;\r\n\r\n\t\tif (this.newsHTML) {\r\n\t\t\tthis.addRoom({\r\n\t\t\t\tid: 'news' as RoomID,\r\n\t\t\t\ttitle: \"News\",\r\n\t\t\t}, true);\r\n\t\t}\r\n\r\n\t\t// Create rooms before /autojoin is sent to the server\r\n\t\tlet autojoin = this.prefs.autojoin;\r\n\t\tif (autojoin) {\r\n\t\t\tif (typeof autojoin === 'string') {\r\n\t\t\t\tautojoin = { showdown: autojoin };\r\n\t\t\t}\r\n\t\t\tlet rooms = autojoin[this.server.id] || '';\r\n\t\t\tfor (let title of rooms.split(\",\")) {\r\n\t\t\t\tthis.addRoom({ id: toID(title) as unknown as RoomID, title, connected: true }, true);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// for old versions of Safari\r\n\t\tif (window.webkitNotification) {\r\n\t\t\twindow.Notification ||= window.webkitNotification;\r\n\t\t}\r\n\r\n\t\tthis.updateLayout();\r\n\t\twindow.addEventListener('resize', () => {\r\n\t\t\t// super.update() skips another updateLayout() call\r\n\t\t\tif (this.updateLayout()) super.update();\r\n\t\t});\r\n\t}\r\n\r\n\t// Panel layout\r\n\t///////////////\r\n\t/**\r\n\t * \"minWidth\" and \"maxWidth\" are a bit deceptive here - to be clear,\r\n\t * all PS rooms are expected to responsively support any width from\r\n\t * 320px up, when in single panel mode. These metrics are used purely\r\n\t * to calculate the location of the separator in two-panel mode.\r\n\t *\r\n\t * - `minWidth` - minimum width as a right-panel\r\n\t * - `width` - preferred width, minimum width as a left-panel\r\n\t * - `maxWidth` - maximum width as a left-panel\r\n\t *\r\n\t * PS will only show two panels if it can fit `width` in the left, and\r\n\t * `minWidth` in the right. Extra space will be given to to right panel\r\n\t * until it reaches `width`, then evenly distributed until both panels\r\n\t * reach `maxWidth`, and extra space above that will be given to the\r\n\t * right panel.\r\n\t */\r\n\tgetWidthFor(room: PSRoom) {\r\n\t\tswitch (room.type) {\r\n\t\tcase 'mainmenu':\r\n\t\t\treturn {\r\n\t\t\t\tminWidth: 340,\r\n\t\t\t\twidth: 628,\r\n\t\t\t\tmaxWidth: 628,\r\n\t\t\t\tisMainMenu: true,\r\n\t\t\t};\r\n\t\tcase 'chat':\r\n\t\tcase 'rooms':\r\n\t\tcase 'battles':\r\n\t\t\treturn {\r\n\t\t\t\tminWidth: 320,\r\n\t\t\t\twidth: 570,\r\n\t\t\t\tmaxWidth: 640,\r\n\t\t\t};\r\n\t\tcase 'team':\r\n\t\t\treturn {\r\n\t\t\t\tminWidth: 660,\r\n\t\t\t\twidth: 660,\r\n\t\t\t\tmaxWidth: 660,\r\n\t\t\t};\r\n\t\tcase 'battle':\r\n\t\t\treturn {\r\n\t\t\t\tminWidth: 320,\r\n\t\t\t\twidth: 956,\r\n\t\t\t\tmaxWidth: 1180,\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn {\r\n\t\t\tminWidth: 640,\r\n\t\t\twidth: 640,\r\n\t\t\tmaxWidth: 640,\r\n\t\t};\r\n\t}\r\n\t/** @returns changed */\r\n\tupdateLayout(): boolean {\r\n\t\tconst leftPanelWidth = this.calculateLeftPanelWidth();\r\n\t\tconst totalWidth = document.body.offsetWidth;\r\n\t\tconst totalHeight = document.body.offsetHeight;\r\n\t\tconst roomHeight = totalHeight - 56;\r\n\t\tif (leftPanelWidth === null) {\r\n\t\t\tthis.panel.width = totalWidth - 200;\r\n\t\t\tthis.panel.height = totalHeight;\r\n\t\t} else if (leftPanelWidth) {\r\n\t\t\tthis.leftPanel.width = leftPanelWidth;\r\n\t\t\tthis.leftPanel.height = roomHeight;\r\n\t\t\tthis.rightPanel!.width = totalWidth + 1 - leftPanelWidth;\r\n\t\t\tthis.rightPanel!.height = roomHeight;\r\n\t\t} else {\r\n\t\t\tthis.panel.width = totalWidth;\r\n\t\t\tthis.panel.height = roomHeight;\r\n\t\t}\r\n\r\n\t\tif (this.leftPanelWidth !== leftPanelWidth) {\r\n\t\t\tthis.leftPanelWidth = leftPanelWidth;\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\tgetRoom(elem: HTMLElement | EventTarget | null | undefined, skipClickable?: boolean): PSRoom | null {\r\n\t\tlet curElem: HTMLElement | null = elem as HTMLElement;\r\n\t\t// might be the close button on the roomtab\r\n\t\tif ((curElem as HTMLButtonElement)?.name === 'closeRoom' && (curElem as HTMLButtonElement).value) {\r\n\t\t\treturn PS.rooms[(curElem as HTMLButtonElement).value] || null;\r\n\t\t}\r\n\t\twhile (curElem) {\r\n\t\t\tif (curElem.id.startsWith('room-')) {\r\n\t\t\t\treturn PS.rooms[curElem.id.slice(5)] || null;\r\n\t\t\t}\r\n\t\t\tif (curElem.getAttribute('data-roomid')) {\r\n\t\t\t\treturn PS.rooms[curElem.getAttribute('data-roomid') as RoomID] || null;\r\n\t\t\t}\r\n\t\t\tif (skipClickable && (\r\n\t\t\t\tcurElem.tagName === 'A' || curElem.tagName === 'BUTTON' || curElem.tagName === 'INPUT' ||\r\n\t\t\t\tcurElem.tagName === 'SELECT' || curElem.tagName === 'TEXTAREA' || curElem.tagName === 'LABEL' ||\r\n\t\t\t\tcurElem.classList?.contains('textbox') || curElem.classList?.contains('username')\r\n\t\t\t)) {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\tcurElem = curElem.parentElement;\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\tdragOnto(fromRoom: PSRoom, toLocation: 'left' | 'right' | 'mini-window', toIndex: number) {\r\n\t\t// one day you will be able to rearrange mainmenu and rooms, but not today\r\n\t\tif (fromRoom.id === '' || fromRoom.id === 'rooms') return;\r\n\r\n\t\tconst onHome = (toLocation === 'left' && toIndex === 0);\r\n\r\n\t\tPS.moveRoom(fromRoom, toLocation, onHome, toIndex);\r\n\t\tPS.update();\r\n\t}\r\n\toverride update() {\r\n\t\tthis.updateLayout();\r\n\t\tsuper.update();\r\n\t}\r\n\treceive(msg: string) {\r\n\t\tmsg = msg.endsWith('\\n') ? msg.slice(0, -1) : msg;\r\n\t\tlet roomid = '' as RoomID;\r\n\t\tif (msg.startsWith('>')) {\r\n\t\t\tconst nlIndex = msg.indexOf('\\n');\r\n\t\t\troomid = msg.slice(1, nlIndex) as RoomID;\r\n\t\t\tmsg = msg.slice(nlIndex + 1);\r\n\t\t}\r\n\t\tconst roomid2 = roomid || 'lobby' as RoomID;\r\n\t\tlet room = PS.rooms[roomid];\r\n\t\tconsole.log('\\u2705 ' + (roomid ? '[' + roomid + '] ' : '') + '%c' + msg, \"color: #007700\");\r\n\t\tlet isInit = false;\r\n\t\tfor (const line of msg.split('\\n')) {\r\n\t\t\tconst args = BattleTextParser.parseLine(line);\r\n\t\t\tswitch (args[0]) {\r\n\t\t\tcase 'init': {\r\n\t\t\t\tisInit = true;\r\n\t\t\t\troom = PS.rooms[roomid2];\r\n\t\t\t\tconst [, type] = args;\r\n\t\t\t\tif (!room) {\r\n\t\t\t\t\troom = this.addRoom({\r\n\t\t\t\t\t\tid: roomid2,\r\n\t\t\t\t\t\ttype,\r\n\t\t\t\t\t\tconnected: true,\r\n\t\t\t\t\t}, roomid === 'staff' || roomid === 'upperstaff');\r\n\t\t\t\t} else {\r\n\t\t\t\t\troom.type = type;\r\n\t\t\t\t\tthis.updateRoomTypes();\r\n\t\t\t\t}\r\n\t\t\t\tif (room) {\r\n\t\t\t\t\tif (room.connected === 'autoreconnect') {\r\n\t\t\t\t\t\troom.connected = true;\r\n\t\t\t\t\t\tif (room.handleReconnect(msg)) return;\r\n\t\t\t\t\t}\r\n\t\t\t\t\troom.connected = true;\r\n\t\t\t\t}\r\n\t\t\t\tthis.updateAutojoin();\r\n\t\t\t\tthis.update();\r\n\t\t\t\tcontinue;\r\n\t\t\t} case 'deinit': {\r\n\t\t\t\troom = PS.rooms[roomid2];\r\n\t\t\t\tif (room) {\r\n\t\t\t\t\troom.connected = false;\r\n\t\t\t\t\tthis.removeRoom(room);\r\n\t\t\t\t}\r\n\t\t\t\tthis.updateAutojoin();\r\n\t\t\t\tthis.update();\r\n\t\t\t\tcontinue;\r\n\t\t\t} case 'noinit': {\r\n\t\t\t\troom = PS.rooms[roomid2];\r\n\t\t\t\tif (room) {\r\n\t\t\t\t\troom.connected = false;\r\n\t\t\t\t\tif (args[1] === 'namerequired') {\r\n\t\t\t\t\t\troom.connectWhenLoggedIn = true;\r\n\t\t\t\t\t\tif (!PS.user.initializing) {\r\n\t\t\t\t\t\t\troom.receiveLine(['error', args[2]]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (args[1] === 'nonexistent') {\r\n\t\t\t\t\t\t// sometimes we assume a room is a chatroom when it's not\r\n\t\t\t\t\t\t// when that happens, just ignore this error\r\n\t\t\t\t\t\tif (room.type === 'chat' || room.type === 'battle') room.receiveLine(args);\r\n\t\t\t\t\t} else if (args[1] === 'rename') {\r\n\t\t\t\t\t\troom.connected = true;\r\n\t\t\t\t\t\troom.title = args[3] || room.title;\r\n\t\t\t\t\t\tthis.renameRoom(room, args[2] as RoomID);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.update();\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\troom?.receiveLine(args);\r\n\t\t}\r\n\t\troom?.update(isInit ? [`initdone`] : null);\r\n\t}\r\n\tsend(msg: string, roomid?: RoomID) {\r\n\t\tconst bracketRoomid = roomid ? `[${roomid}] ` : '';\r\n\t\tconsole.log(`\\u25b6\\ufe0f ${bracketRoomid}%c${msg}`, \"color: #776677\");\r\n\t\tif (!this.connection) {\r\n\t\t\tPS.alert(`You are not connected and cannot send ${msg}.`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.connection.send(`${roomid || ''}|${msg}`);\r\n\t}\r\n\tisVisible(room: PSRoom) {\r\n\t\tif (!this.leftPanelWidth) {\r\n\t\t\t// one panel visible\r\n\t\t\treturn room === this.panel || room === this.room;\r\n\t\t} else {\r\n\t\t\t// both panels visible\r\n\t\t\treturn room === this.rightPanel || room === this.leftPanel || room === this.room;\r\n\t\t}\r\n\t}\r\n\tcalculateLeftPanelWidth() {\r\n\t\tconst available = document.body.offsetWidth;\r\n\t\tif (document.documentElement.clientWidth < 800 || this.prefs.onepanel === 'vertical') {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\t// If we don't have both a left room and a right room, obviously\r\n\t\t// just show one room\r\n\t\tif (!this.leftPanel || !this.rightPanel || this.prefs.onepanel) {\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\t// The rest of this code can assume we have both a left room and a\r\n\t\t// right room, and also want to show both if they fit\r\n\r\n\t\tconst left = this.getWidthFor(this.leftPanel);\r\n\t\tconst right = this.getWidthFor(this.rightPanel);\r\n\r\n\t\tlet excess = available - (left.width + right.width);\r\n\t\tif (excess >= 0) {\r\n\t\t\t// both fit in full size\r\n\t\t\tconst leftStretch = left.maxWidth - left.width;\r\n\t\t\tif (!leftStretch) return left.width;\r\n\t\t\tconst rightStretch = right.maxWidth - right.width;\r\n\t\t\tif (leftStretch + rightStretch >= excess) return left.maxWidth;\r\n\t\t\t// evenly distribute the excess\r\n\t\t\treturn left.width + Math.floor(excess * leftStretch / (leftStretch + rightStretch));\r\n\t\t}\r\n\r\n\t\tif (left.isMainMenu) {\r\n\t\t\tif (available >= left.minWidth + right.width) {\r\n\t\t\t\treturn left.minWidth;\r\n\t\t\t}\r\n\t\t\treturn 0;\r\n\t\t}\r\n\r\n\t\tif (available >= left.width + right.minWidth) {\r\n\t\t\treturn left.width;\r\n\t\t}\r\n\t\treturn 0;\r\n\t}\r\n\tcreateRoom(options: RoomOptions) {\r\n\t\toptions.location ||= this.getRouteLocation(options.id);\r\n\t\toptions.type ||= this.getRoute(options.id) || '';\r\n\t\tconst RoomType = this.roomTypes[options.type];\r\n\t\toptions.noURL ??= RoomType?.noURL;\r\n\t\tif (RoomType?.title) options.title = RoomType.title;\r\n\t\tconst Model = RoomType ? (RoomType.Model || PSRoom) : PlaceholderRoom;\r\n\t\treturn new Model(options);\r\n\t}\r\n\tgetRouteInfo(roomid: RoomID) {\r\n\t\tif (this.routes[roomid]) return this.routes[roomid];\r\n\t\tconst hyphenIndex = roomid.indexOf('-');\r\n\t\tif (hyphenIndex < 0) return this.routes['*'] || null;\r\n\t\troomid = roomid.slice(0, hyphenIndex) + '-*' as RoomID;\r\n\t\tif (this.routes[roomid]) return this.routes[roomid];\r\n\t\treturn null;\r\n\t}\r\n\tgetRouteLocation(roomid: RoomID): PSRoomLocation {\r\n\t\t// must be hardcoded here to have a different loc while also being a ChatRoom\r\n\t\tif (roomid.startsWith('dm-')) {\r\n\t\t\tif (document.documentElement.clientWidth <= 818) {\r\n\t\t\t\treturn 'left';\r\n\t\t\t}\r\n\t\t\treturn 'mini-window';\r\n\t\t}\r\n\t\tconst routeInfo = this.getRouteInfo(roomid);\r\n\t\tif (!routeInfo) return 'left';\r\n\t\tif (routeInfo.startsWith('*')) return routeInfo.slice(1) as PSRoomLocation;\r\n\t\treturn PS.roomTypes[routeInfo]!.location || 'left';\r\n\t}\r\n\tgetRoute(roomid: RoomID) {\r\n\t\tconst routeInfo = this.getRouteInfo(roomid);\r\n\t\treturn routeInfo?.startsWith('*') ? null : routeInfo || null;\r\n\t}\r\n\taddRoomType(...types: PSRoomPanelSubclass[]) {\r\n\t\tfor (const RoomType of types) {\r\n\t\t\tthis.roomTypes[RoomType.id] = RoomType;\r\n\t\t\tfor (const route of RoomType.routes) {\r\n\t\t\t\tthis.routes[route] = RoomType.id;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.updateRoomTypes();\r\n\t}\r\n\tupdateRoomTypes() {\r\n\t\tlet updated = false;\r\n\t\tfor (const roomid in this.rooms) {\r\n\t\t\tconst room = this.rooms[roomid]!;\r\n\t\t\tconst typeIsGuessed = room.type === this.routes['*'] && !roomid.includes('-');\r\n\t\t\tif (!room.isPlaceholder && !typeIsGuessed) continue;\r\n\r\n\t\t\tlet type = (!typeIsGuessed && room.type) || this.getRoute(roomid as RoomID) || room.type || '';\r\n\t\t\tif (!room.isPlaceholder && type === room.type) continue;\r\n\r\n\t\t\tconst RoomType = type && this.roomTypes[type];\r\n\t\t\tif (!RoomType) continue;\r\n\r\n\t\t\tconst options: RoomOptions = room;\r\n\t\t\tif (RoomType.title) options.title = RoomType.title;\r\n\t\t\toptions.type = type;\r\n\t\t\tconst Model = RoomType.Model || PSRoom;\r\n\t\t\tconst newRoom = new Model(options);\r\n\t\t\tthis.rooms[roomid] = newRoom;\r\n\t\t\tif (this.leftPanel === room) this.leftPanel = newRoom;\r\n\t\t\tif (this.rightPanel === room) this.rightPanel = newRoom;\r\n\t\t\tif (this.panel === room) this.panel = newRoom;\r\n\t\t\tif (roomid === '') this.mainmenu = newRoom as MainMenuRoom;\r\n\t\t\tif (this.room === room) {\r\n\t\t\t\tthis.room = newRoom;\r\n\t\t\t\tnewRoom.focusNextUpdate = true;\r\n\t\t\t}\r\n\r\n\t\t\tupdated = true;\r\n\t\t}\r\n\t\tif (updated) this.update();\r\n\t}\r\n\tsetFocus(room: PSRoom) {\r\n\t\troom.onParentEvent?.('focus');\r\n\t}\r\n\tfocusRoom(roomid: RoomID) {\r\n\t\tconst room = this.rooms[roomid];\r\n\t\tif (!room) return false;\r\n\t\tif (this.room === room) {\r\n\t\t\tthis.setFocus(room);\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tthis.closePopupsAbove(room, true);\r\n\t\tif (!this.isVisible(room)) {\r\n\t\t\troom.focusNextUpdate = true;\r\n\t\t}\r\n\t\tif (PS.isNormalRoom(room)) {\r\n\t\t\tif (room.location === 'right') {\r\n\t\t\t\tthis.rightPanel = room;\r\n\t\t\t} else {\r\n\t\t\t\tthis.leftPanel = room;\r\n\t\t\t}\r\n\t\t\tthis.panel = this.room = room;\r\n\t\t} else { // popup or mini-window\r\n\t\t\tif (room.location === 'mini-window') {\r\n\t\t\t\tthis.leftPanel = this.panel = PS.mainmenu;\r\n\t\t\t}\r\n\t\t\tthis.room = room;\r\n\t\t}\r\n\t\tthis.room.autoDismissNotifications();\r\n\t\tthis.update();\r\n\t\tthis.setFocus(room);\r\n\t\treturn true;\r\n\t}\r\n\thorizontalNav(room = this.room) {\r\n\t\tif (this.leftPanelWidth === null) {\r\n\t\t\treturn { rooms: [], index: -1 };\r\n\t\t}\r\n\t\tconst rooms = this.leftRoomList.concat(this.rightRoomList);\r\n\t\tconst miniRoom = this.miniRoomList[0] !== 'news' ? this.miniRoomList[0] : null;\r\n\t\tif (miniRoom) rooms.splice(1, 0, miniRoom);\r\n\t\tconst roomid = (room.location === 'mini-window' && miniRoom) || room.id;\r\n\r\n\t\tconst index = rooms.indexOf(roomid);\r\n\t\t// index === -1: popup or something\r\n\t\treturn { rooms, index };\r\n\t}\r\n\tverticalNav(room = this.room) {\r\n\t\tif (this.leftPanelWidth === null) {\r\n\t\t\tconst rooms = ['' as RoomID, ...this.miniRoomList, ...this.leftRoomList.slice(1), ...this.rightRoomList];\r\n\t\t\tconst index = rooms.indexOf(room.id);\r\n\t\t\treturn { rooms, index };\r\n\t\t}\r\n\t\tif (room.location !== 'mini-window') {\r\n\t\t\treturn { rooms: [], index: -1 };\r\n\t\t}\r\n\t\tconst rooms = this.miniRoomList;\r\n\t\tconst index = rooms.indexOf(room.id);\r\n\t\t// index === -1: shouldn't happen\r\n\t\treturn { rooms, index };\r\n\t}\r\n\tfocusLeftRoom() {\r\n\t\tconst { rooms, index } = this.horizontalNav();\r\n\t\tif (index === -1) return;\r\n\r\n\t\tif (index === 0) {\r\n\t\t\treturn this.focusRoom(rooms[rooms.length - 1]);\r\n\t\t}\r\n\t\treturn this.focusRoom(rooms[index - 1]);\r\n\t}\r\n\tfocusRightRoom() {\r\n\t\tconst { rooms, index } = this.horizontalNav();\r\n\t\tif (index === -1) return;\r\n\r\n\t\tif (index === rooms.length - 1) {\r\n\t\t\treturn this.focusRoom(rooms[0]);\r\n\t\t}\r\n\t\treturn this.focusRoom(rooms[index + 1]);\r\n\t}\r\n\tfocusUpRoom() {\r\n\t\tconst { rooms, index } = this.verticalNav();\r\n\t\tif (index === -1) return;\r\n\r\n\t\tif (index === 0) {\r\n\t\t\treturn this.focusRoom(rooms[rooms.length - 1]);\r\n\t\t}\r\n\t\treturn this.focusRoom(rooms[index - 1]);\r\n\t}\r\n\tfocusDownRoom() {\r\n\t\tconst { rooms, index } = this.verticalNav();\r\n\t\tif (index === -1) return;\r\n\r\n\t\tif (index === rooms.length - 1) {\r\n\t\t\treturn this.focusRoom(rooms[0]);\r\n\t\t}\r\n\t\treturn this.focusRoom(rooms[index + 1]);\r\n\t}\r\n\talert(message: string, opts: { okButton?: string, parentElem?: HTMLElement, width?: number } = {}) {\r\n\t\tthis.join(`popup-${this.popups.length}` as RoomID, {\r\n\t\t\targs: { message, ...opts, parentElem: null },\r\n\t\t\tparentElem: opts.parentElem,\r\n\t\t});\r\n\t}\r\n\tconfirm(message: string, opts: { okButton?: string, cancelButton?: string } = {}) {\r\n\t\topts.cancelButton ??= 'Cancel';\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.join(`popup-${this.popups.length}` as RoomID, {\r\n\t\t\t\targs: { message, okValue: true, cancelValue: false, callback: resolve, ...opts },\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\tprompt(message: string, defaultValue = '', opts: {\r\n\t\tokButton?: string, cancelButton?: string, type?: 'text' | 'password' | 'number', parentElem?: HTMLElement,\r\n\t} = {}): Promise<string | null> {\r\n\t\topts.cancelButton ??= 'Cancel';\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.join(`popup-${this.popups.length}` as RoomID, {\r\n\t\t\t\targs: { message, value: defaultValue, okValue: true, cancelValue: false, callback: resolve, ...opts, parentElem: null },\r\n\t\t\t\tparentElem: opts.parentElem,\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\tgetPMRoom(userid: ID): ChatRoom {\r\n\t\tconst myUserid = PS.user.userid;\r\n\t\tconst roomid = `dm-${[userid, myUserid].sort().join('-')}` as RoomID;\r\n\t\tif (this.rooms[roomid]) return this.rooms[roomid] as ChatRoom;\r\n\t\tthis.join(roomid);\r\n\t\treturn this.rooms[roomid]! as ChatRoom;\r\n\t}\r\n\t/**\r\n\t * Low-level add room. You usually want `join`.\r\n\t */\r\n\taddRoom(options: RoomOptions, noFocus = false) {\r\n\t\t// support hardcoded PM room-IDs\r\n\t\tif (options.id.startsWith('challenge-')) {\r\n\t\t\tthis.requestNotifications();\r\n\t\t\toptions.id = `dm-${options.id.slice(10)}` as RoomID;\r\n\t\t\toptions.args = { challengeMenuOpen: true };\r\n\t\t}\r\n\t\tif (options.id.startsWith('dm-')) {\r\n\t\t\tthis.requestNotifications();\r\n\t\t\tif (options.id.length >= 5 && options.id.endsWith('--')) {\r\n\t\t\t\toptions.id = options.id.slice(0, -2) as RoomID;\r\n\t\t\t\toptions.args = { initialSlash: true };\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (options.id.startsWith('battle-') && PS.prefs.rightpanelbattles) options.location = 'right';\r\n\t\toptions.parentRoomid ??= this.getRoom(options.parentElem)?.id;\r\n\t\tconst parentRoom = options.parentRoomid ? this.rooms[options.parentRoomid] : null;\r\n\t\tlet preexistingRoom = this.rooms[options.id];\r\n\t\tif (preexistingRoom && this.isPopup(preexistingRoom)) {\r\n\t\t\tconst sameOpener = (preexistingRoom.parentElem === options.parentElem);\r\n\t\t\tthis.closePopupsAbove(parentRoom, true);\r\n\t\t\tif (sameOpener) return;\r\n\t\t\tpreexistingRoom = this.rooms[options.id];\r\n\t\t}\r\n\t\tif (preexistingRoom) {\r\n\t\t\tif (!noFocus) {\r\n\t\t\t\tif (options.args?.challengeMenuOpen) {\r\n\t\t\t\t\t(preexistingRoom as ChatRoom).openChallenge();\r\n\t\t\t\t}\r\n\t\t\t\tthis.focusRoom(preexistingRoom.id);\r\n\t\t\t}\r\n\t\t\treturn preexistingRoom;\r\n\t\t}\r\n\t\tif (!noFocus) {\r\n\t\t\tlet parentPopup = parentRoom;\r\n\t\t\tif ((options.parentElem as HTMLButtonElement)?.name === 'closeRoom') {\r\n\t\t\t\t// We want to close all popups above the parent element.\r\n\t\t\t\t// This is usually the parent room, but if we're clicking Close\r\n\t\t\t\t// in the overflow tablist, the close button's parent room is\r\n\t\t\t\t// the tab rather than the overflow tablist popup,\r\n\t\t\t\t// which needs to be corrected here.\r\n\t\t\t\tparentPopup = PS.rooms['roomtablist'] || parentPopup;\r\n\t\t\t}\r\n\t\t\tthis.closePopupsAbove(parentPopup, true);\r\n\t\t}\r\n\t\tconst room = this.createRoom(options);\r\n\t\tthis.rooms[room.id] = room;\r\n\t\tconst location = room.location;\r\n\t\troom.location = null!;\r\n\t\tthis.moveRoom(room, location, noFocus);\r\n\t\tif (options.backlog) {\r\n\t\t\tfor (const args of options.backlog) {\r\n\t\t\t\troom.receiveLine(args);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (!noFocus) room.focusNextUpdate = true;\r\n\t\treturn room;\r\n\t}\r\n\thideRightRoom() {\r\n\t\tif (PS.rightPanel) {\r\n\t\t\tif (PS.panel === PS.rightPanel) PS.panel = PS.leftPanel;\r\n\t\t\tif (PS.room === PS.rightPanel) PS.room = PS.leftPanel;\r\n\t\t\tPS.rightPanel = null;\r\n\t\t\tPS.update();\r\n\t\t\tPS.focusRoom(PS.leftPanel.id);\r\n\t\t}\r\n\t}\r\n\troomVisible(room: PSRoom): boolean {\r\n\t\tif (PS.isNormalRoom(room)) {\r\n\t\t\treturn !this.leftPanelWidth ? room === this.panel : room === this.leftPanel || room === this.rightPanel;\r\n\t\t}\r\n\t\tif (room.location === 'mini-window') {\r\n\t\t\treturn !this.leftPanelWidth ? this.mainmenu === this.panel : this.mainmenu === this.leftPanel;\r\n\t\t}\r\n\t\t// some kind of popup\r\n\t\treturn true;\r\n\t}\r\n\trenameRoom(room: PSRoom, id: RoomID) {\r\n\t\t// should never happen\r\n\t\tif (this.rooms[id]) this.removeRoom(this.rooms[id]);\r\n\r\n\t\tconst oldid = room.id;\r\n\t\troom.id = id;\r\n\t\tthis.rooms[id] = room;\r\n\t\tdelete this.rooms[oldid];\r\n\r\n\t\tconst popupIndex = this.popups.indexOf(oldid);\r\n\t\tif (popupIndex >= 0) this.popups[popupIndex] = id;\r\n\t\tconst leftRoomIndex = this.leftRoomList.indexOf(oldid);\r\n\t\tif (leftRoomIndex >= 0) this.leftRoomList[leftRoomIndex] = id;\r\n\t\tconst rightRoomIndex = this.rightRoomList.indexOf(oldid);\r\n\t\tif (rightRoomIndex >= 0) this.rightRoomList[rightRoomIndex] = id;\r\n\t\tconst miniRoomIndex = this.miniRoomList.indexOf(oldid);\r\n\t\tif (miniRoomIndex >= 0) this.miniRoomList[miniRoomIndex] = id;\r\n\r\n\t\tthis.update();\r\n\t}\r\n\tisPopup(room: PSRoom | undefined | null) {\r\n\t\tif (!room) return false;\r\n\t\treturn room.location === 'popup' || room.location === 'semimodal-popup' || room.location === 'modal-popup';\r\n\t}\r\n\tisNormalRoom(room: PSRoom | undefined | null) {\r\n\t\tif (!room) return false;\r\n\t\treturn room.location === 'left' || room.location === 'right';\r\n\t}\r\n\tmoveRoom(room: PSRoom, location: PSRoomLocation, background?: boolean, index?: number) {\r\n\t\tif (room.location === location && index === undefined) {\r\n\t\t\tif (background === true) {\r\n\t\t\t\tif (room === this.leftPanel) {\r\n\t\t\t\t\tthis.leftPanel = this.mainmenu;\r\n\t\t\t\t\tthis.panel = this.mainmenu;\r\n\t\t\t\t} else if (room === this.rightPanel) {\r\n\t\t\t\t\tthis.rightPanel = this.rooms['rooms'] || null;\r\n\t\t\t\t\tthis.panel = this.rightPanel || this.leftPanel;\r\n\t\t\t\t}\r\n\t\t\t} else if (background === false) {\r\n\t\t\t\tthis.focusRoom(room.id);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst POPUPS = ['popup', 'semimodal-popup', 'modal-popup'];\r\n\t\tif (this.isPopup(room) && POPUPS.includes(location)) {\r\n\t\t\troom.location = location;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tbackground ??= !this.roomVisible(room);\r\n\r\n\t\tif (room.location === 'mini-window') {\r\n\t\t\tconst miniRoomIndex = this.miniRoomList.indexOf(room.id);\r\n\t\t\tif (miniRoomIndex >= 0) {\r\n\t\t\t\tthis.miniRoomList.splice(miniRoomIndex, 1);\r\n\t\t\t}\r\n\t\t\tif (this.room === room) this.room = this.panel;\r\n\t\t} else if (POPUPS.includes(room.location)) {\r\n\t\t\tconst popupIndex = this.popups.indexOf(room.id);\r\n\t\t\tif (popupIndex >= 0) {\r\n\t\t\t\tthis.popups.splice(popupIndex, 1);\r\n\t\t\t}\r\n\t\t\tif (this.room === room) this.room = this.panel;\r\n\t\t} else if (room.location === 'left') {\r\n\t\t\tconst leftRoomIndex = this.leftRoomList.indexOf(room.id);\r\n\t\t\tif (leftRoomIndex >= 0) {\r\n\t\t\t\tthis.leftRoomList.splice(leftRoomIndex, 1);\r\n\t\t\t}\r\n\t\t\tif (this.room === room) this.room = this.mainmenu;\r\n\t\t\tif (this.panel === room) this.panel = this.mainmenu;\r\n\t\t\tif (this.leftPanel === room) this.leftPanel = this.mainmenu;\r\n\t\t} else if (room.location === 'right') {\r\n\t\t\tconst rightRoomIndex = this.rightRoomList.indexOf(room.id);\r\n\t\t\tif (rightRoomIndex >= 0) {\r\n\t\t\t\tthis.rightRoomList.splice(rightRoomIndex, 1);\r\n\t\t\t}\r\n\t\t\tif (this.room === room) this.room = this.rooms['rooms'] || this.leftPanel;\r\n\t\t\tif (this.panel === room) this.panel = this.rooms['rooms'] || this.leftPanel;\r\n\t\t\tif (this.rightPanel === room) this.rightPanel = this.rooms['rooms'] || null;\r\n\t\t}\r\n\r\n\t\troom.location = location;\r\n\t\tswitch (location) {\r\n\t\tcase 'left':\r\n\t\t\tthis.leftRoomList.splice(Math.max(index ?? Infinity, 1), 0, room.id);\r\n\t\t\tbreak;\r\n\t\tcase 'right':\r\n\t\t\tthis.rightRoomList.splice(Math.min(index ?? -1, this.rightRoomList.length - 1), 0, room.id);\r\n\t\t\tbreak;\r\n\t\tcase 'mini-window':\r\n\t\t\tthis.miniRoomList.splice(index ?? 0, 0, room.id);\r\n\t\t\tbreak;\r\n\t\tcase 'popup':\r\n\t\tcase 'semimodal-popup':\r\n\t\tcase 'modal-popup':\r\n\t\t\t// moving a room to a popup must move it to the topmost popup\r\n\t\t\tthis.popups.push(room.id);\r\n\t\t\tthis.room = room; // popups can't be backgrounded\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tthrow new Error(`Invalid room location: ${location satisfies never as string}`);\r\n\t\t}\r\n\t\tif (!background) {\r\n\t\t\tif (location === 'left') this.leftPanel = this.panel = room;\r\n\t\t\tif (location === 'right') this.rightPanel = this.panel = room;\r\n\t\t\tif (location === 'mini-window') this.leftPanel = this.panel = this.mainmenu;\r\n\t\t\tthis.room = room;\r\n\t\t}\r\n\t}\r\n\tremoveRoom(room: PSRoom) {\r\n\t\tconst wasFocused = this.room === room;\r\n\t\troom.destroy();\r\n\t\tdelete PS.rooms[room.id];\r\n\r\n\t\tconst leftRoomIndex = PS.leftRoomList.indexOf(room.id);\r\n\t\tif (leftRoomIndex >= 0) {\r\n\t\t\tPS.leftRoomList.splice(leftRoomIndex, 1);\r\n\t\t}\r\n\t\tif (PS.leftPanel === room) {\r\n\t\t\tPS.leftPanel = this.mainmenu;\r\n\t\t\tif (PS.panel === room) PS.panel = this.mainmenu;\r\n\t\t\tif (PS.room === room) PS.room = this.mainmenu;\r\n\t\t}\r\n\r\n\t\tconst rightRoomIndex = PS.rightRoomList.indexOf(room.id);\r\n\t\tif (rightRoomIndex >= 0) {\r\n\t\t\tPS.rightRoomList.splice(rightRoomIndex, 1);\r\n\t\t}\r\n\t\tif (PS.rightPanel === room) {\r\n\t\t\tlet newRightRoomid = PS.rightRoomList[rightRoomIndex] || PS.rightRoomList[rightRoomIndex - 1];\r\n\t\t\tPS.rightPanel = newRightRoomid ? PS.rooms[newRightRoomid]! : null;\r\n\t\t\tif (PS.panel === room) PS.panel = PS.rightPanel || PS.leftPanel;\r\n\t\t\tif (PS.room === room) PS.room = PS.panel;\r\n\t\t}\r\n\r\n\t\tif (room.location === 'mini-window') {\r\n\t\t\tconst miniRoomIndex = PS.miniRoomList.indexOf(room.id);\r\n\t\t\tif (miniRoomIndex >= 0) {\r\n\t\t\t\tPS.miniRoomList.splice(miniRoomIndex, 1);\r\n\t\t\t}\r\n\t\t\tif (PS.room === room) {\r\n\t\t\t\tPS.room = PS.rooms[PS.miniRoomList[miniRoomIndex]] || PS.rooms[PS.miniRoomList[miniRoomIndex - 1]] || PS.mainmenu;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this.popups.length && room.id === this.popups[this.popups.length - 1]) {\r\n\t\t\tthis.popups.pop();\r\n\t\t\tPS.room = this.popups.length ? PS.rooms[this.popups[this.popups.length - 1]]! :\r\n\t\t\t\tPS.rooms[room.parentRoomid ?? PS.panel.id] || PS.panel;\r\n\t\t}\r\n\r\n\t\tif (wasFocused) {\r\n\t\t\tthis.room.focusNextUpdate = true;\r\n\t\t}\r\n\t}\r\n\t/** do NOT use this in a while loop: see `closePopupsUntil */\r\n\tclosePopup(skipUpdate?: boolean) {\r\n\t\tif (!this.popups.length) return;\r\n\t\tthis.leave(this.popups[this.popups.length - 1]);\r\n\t\tif (!skipUpdate) this.update();\r\n\t}\r\n\tcloseAllPopups(skipUpdate?: boolean) {\r\n\t\tthis.closePopupsAbove(null, skipUpdate);\r\n\t}\r\n\tclosePopupsAbove(room: PSRoom | null | undefined, skipUpdate?: boolean) {\r\n\t\t// a while-loop may be simpler, but the loop invariant is very hard to prove\r\n\t\t// and any bugs (opening a popup while leaving a room) could lead to an infinite loop\r\n\t\t// a for-loop doesn't have that problem\r\n\t\tfor (let i = this.popups.length - 1; i >= 0; i--) {\r\n\t\t\tif (room && this.popups[i] === room.id) break;\r\n\t\t\tthis.removeRoom(PS.rooms[this.popups[i]]!);\r\n\t\t}\r\n\t\tif (!skipUpdate) this.update();\r\n\t}\r\n\t/** Focus a room, creating it if it doesn't already exist. */\r\n\tjoin(roomid: RoomID, options?: Partial<RoomOptions> | null) {\r\n\t\t// popups are always reopened rather than focused\r\n\t\tif (PS.rooms[roomid] && !PS.isPopup(PS.rooms[roomid])) {\r\n\t\t\tif (this.room.id === roomid) return;\r\n\t\t\tthis.focusRoom(roomid);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.addRoom({ id: roomid, ...options });\r\n\t\tthis.update();\r\n\t}\r\n\tleave(roomid: RoomID) {\r\n\t\tif (!roomid || roomid === 'rooms') return;\r\n\t\tconst room = PS.rooms[roomid];\r\n\t\tif (room) {\r\n\t\t\tthis.removeRoom(room);\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tupdateAutojoin() {\r\n\t\tif (!PS.server.registered) return;\r\n\t\tlet autojoins: string[] = [];\r\n\t\tlet autojoinCount = 0;\r\n\t\tlet rooms = this.rightRoomList;\r\n\t\tfor (let roomid of rooms) {\r\n\t\t\tlet room = PS.rooms[roomid] as ChatRoom;\r\n\t\t\tif (!room) return;\r\n\t\t\tif (room.type !== 'chat' || room.pmTarget) continue;\r\n\t\t\tautojoins.push(room.id.includes('-') ? room.id : (room.title || room.id));\r\n\t\t\tif (room.id === 'staff' || room.id === 'upperstaff' || (PS.server.id !== 'showdown' && room.id === 'lobby')) continue;\r\n\t\t\tautojoinCount++;\r\n\t\t\tif (autojoinCount >= 15) break;\r\n\t\t}\r\n\r\n\t\tconst thisAutojoin = autojoins.join(',') || null;\r\n\t\tlet autojoin = this.prefs.autojoin || null;\r\n\t\tif (this.server.id === 'showdown' && typeof autojoin !== 'object') {\r\n\t\t\t// Main server only mode\r\n\t\t\tif (autojoin === thisAutojoin) return;\r\n\r\n\t\t\tthis.prefs.set('autojoin', thisAutojoin || null);\r\n\t\t} else {\r\n\t\t\t// Multi server mode\r\n\t\t\tautojoin = typeof autojoin === 'string' ? { showdown: autojoin } : autojoin || {};\r\n\t\t\tif (autojoin[this.server.id] === thisAutojoin) return;\r\n\r\n\t\t\tautojoin[this.server.id] = thisAutojoin || '';\r\n\t\t\tthis.prefs.set('autojoin', autojoin);\r\n\t\t}\r\n\t}\r\n\trequestNotifications() {\r\n\t\ttry {\r\n\t\t\tif (window.webkitNotifications?.requestPermission) {\r\n\t\t\t\t// Notification.requestPermission crashes Chrome 23:\r\n\t\t\t\t//   https://code.google.com/p/chromium/issues/detail?id=139594\r\n\t\t\t\t// In lieu of a way to detect Chrome 23, we'll just use the old\r\n\t\t\t\t// requestPermission API, which works to request permissions for\r\n\t\t\t\t// the new Notification spec anyway.\r\n\t\t\t\twindow.webkitNotifications.requestPermission();\r\n\t\t\t} else if (window.Notification) {\r\n\t\t\t\tNotification.requestPermission?.(permission => {});\r\n\t\t\t}\r\n\t\t} catch {}\r\n\t}\r\n\tplayNotificationSound() {\r\n\t\tif (window.BattleSound && !this.prefs.mute) {\r\n\t\t\twindow.BattleSound.playSound('audio/notification.wav', this.prefs.notifvolume);\r\n\t\t}\r\n\t}\r\n};\r\n"],
  "mappings": "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",
  "names": ["rooms", "index"]
}
